var wbManager;(()=>{var e={287:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=287,e.exports=t}},t={};function i(n){var s=t[n];if(void 0!==s)return s.exports;var r=t[n]={exports:{}};return e[n](r,r.exports,i),r.exports}i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};(()=>{"use strict";i.r(n),i.d(n,{addItem:()=>J,addLine:()=>q,itemShape:()=>Y,itemType:()=>X,lineSnapPosition:()=>G,start:()=>j});class e{static allTags;static allowedTagColors=[];static initialize(){e.allTags=new e,e.allowedTagColors.push("rgb(255,0,0)"),e.allowedTagColors.push("rgb(255,128,0)"),e.allowedTagColors.push("rgb(0,255,0)"),e.allowedTagColors.push("rgb(128,255,0)"),e.allowedTagColors.push("rgb(0,0,255)"),e.allowedTagColors.push("rgb(0,128,255)")}static deleteTag(t){e.allTags.removeTag(t);for(var i=wbMain.getItems(),n=0;n<i.length;n++)i[n].getTags().removeTag(t)}static renameTag(t,i,n){e.allTags.renameTag(t,i,n);for(var s=wbMain.getItems(),r=0;r<s.length;r++)s[r].getTags().renameTag(t,i)}static getTagColor(t){return e.allTags.getTag(t)}static setTagColor(t,i){e.allTags.addTag(t,i)}constructor(){this.tagsHash=[]}setFromJSON(e){if(null!=e)for(var t=e.key,i=e.value,n=0;n<t.length;n++)this.tagsHash[t[n]]=i[n]}serialize(){var e=new Array,t=new Array;for(var i in this.tagsHash)e.push(i),t.push(this.tagsHash[i]);return{key:e,value:t}}addTag(t,i){wbMain.setDirty(),this!=e.allTags&&e.allTags.addTag(t,i),this.hasTag(t)&&null==i||(this.tagsHash[t]=null==i?"rgb(255,0,64)":i)}renameTag(e,t,i){wbMain.setDirty(),this.hasTag(e)&&(this.removeTag(e),this.addTag(t,i))}removeTag(e){wbMain.setDirty();var t=[];for(var i in this.tagsHash)i!=e&&(t[i]=this.tagsHash[i]);this.tagsHash=t}hasTag(e){return null!=this.tagsHash[e]}hasTags(e){for(var t=0;t<e.length;t++)if(this.hasTag(e[t]))return!0}getTag(e){return this.tagsHash[e]}getTagsHash(){return this.tagsHash}}const t={wbItem:0,wbItemHC:1,wbItemTextEditor:2,wbItemTextEditorNote:3,wbItemTextEditorText:4,wbItemContainer:5,wbItemModelTree:6,wbLine:7},s={rectangle:0,roundedCornerRectangle:1,circle:2};window.wbItemShape=s;class r{static borderPatterns=[[1,1],[5,15],[20,5]];static container="newdialogwindow";constructor(){this._type=t.wbItem,this._active=!1,this._locked=!1,this._dimensions={left:600,top:200,width:500,height:500},this._tempcanvasimagedimensions,this._isSelected=!1,this._shape=s.rectangle,this._backgroundColor="rgb(255,255,255)",this._groupid,this._image,this._targetdiv,this.containedIn=void 0,this._connectedWindows=[],this._tags=new e,this.backgroundOpacity=1,this.borderColor="rgb(0,0,0)",this.borderWidth=1,this.shadowWidth=2,this.borderPattern=void 0,this._guid=this._generateGUID(),this.isLineSnapItem=!1,this.dirty=!0,this.imageDirty=!1,this.order=U.getTopOrder()}setFromJSON(e){this._type=e._type,this._guid=e._guid,this._locked=e._locked,this._dimensions=e._dimensions,this._shape=e._shape,this._backgroundColor=e._backgroundColor,null!=e._groupid&&(this._groupid=e._groupid),this.backgroundOpacity=e.backgroundOpacity,this.borderColor=e.borderColor,this.borderWidth=e.borderWidth,this.shadowWidth=e.shadowWidth,this.order=e.order,null!=e.borderPattern&&(this.borderPattern=e.borderPattern),this.isLineSnapItem=e.isLineSnapItem,this.dirty=!1,this._tags.setFromJSON(e.tags)}serialize(){return{_type:this._type,_guid:this._guid,_locked:this._locked,_dimensions:this._dimensions,_shape:this._shape,_backgroundColor:this._backgroundColor,_groupid:this._groupid,backgroundOpacity:this.backgroundOpacity,borderColor:this.borderColor,borderWidth:this.borderWidth,shadowWidth:this.shadowWidth,borderPattern:this.borderPattern,isLineSnapItem:this.isLineSnapItem,order:this.order,hasImage:null!=this._image,tags:this._tags.serialize()}}_generateGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}setDirty(){this.dirty=!0}getDirty(){return this.dirty}clearDirty(){this.dirty=!1}fetchImage(e){var t=this;fetch("api/Image/"+e+"/"+this._guid).then((function(e){200===e.status?e.json().then((function(e){var i=JSON.parse(e);let n=document.createElement("img");n.src=i.test,t.setImage(n),setTimeout((function(){U.redraw()}),200)})):console.log("Looks like there was a problem. Status Code: "+e.status)})).catch((function(e){console.log("Fetch Error :-S",e)}))}postImage(e){fetch("api/Image/"+e+"/"+this._guid,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({test:this._image.src})})}setupDiv(e){this._targetdiv="wdiv-"+this.getGUID();var t='<div id="'+this._targetdiv+'" style="display:none;border-width:1px; border-color:black;overflow:hidden;box-shadow: 0px 0px 40px grey;">';$("#"+e).append(t)}move(e,t,i){i?(this._dimensions.left+=e,this._dimensions.top+=t):(this._dimensions.left=e,this._dimensions.top=t),this.dirty=!0,this.refreshPositioning()}scale(e){this._dimensions=e,this.dirty=!0}deselectGroup(){if(null!=this._groupid)for(var e=U.getItems(),t=0;t<e.length;t++)e[t].getGroup()==this._groupid&&e[t].setSelected(!1)}disableInput(){}enableInput(){}setLocked(e){this._locked=e}getLocked(){return this._locked}duplicate(){var e=new r;return this._duplicate(e),e}_duplicate(e){for(var t in e.initialize(),e._dimensions={left:this._dimensions.left,top:this._dimensions.top,width:this._dimensions.width,height:this._dimensions.height},e._shape=this._shape,this._tags)e._tags[t]=!0;if(null==this._backgroundColor?e._backgroundColor=void 0:e._backgroundColor=(" "+this._backgroundColor).slice(1),null!=this._image){var i=(" "+this._image.src).slice(1),n=new Image;n.src=i,e._image=n}e.setupDiv(r.container),U.addItem(e)}initialize(){}getGUID(){return this._guid}getType(){return this._type}setBackgroundColor(e){this._backgroundColor=e,null!=this.getDiv()&&(null==e&&(e="transparent"),$("#"+this.getDiv()).css({"background-color":e}))}setGroup(e){this._groupid=e}getGroup(){return this._groupid}getTags(){return this._tags}hasTags(e){return this._tags.hasTags(e)}findConnectedItems(){return[this]}getBackgroundColor(){return this._backgroundColor}getDimensions(){return this._dimensions}setDimensions(e){this._dimensions=e,this.dirty=!0,this.refreshPositioning()}findConnectedContainer(){for(var e=U.getItems(),i=0;i<e.length;i++)if(e[i].getType()==t.wbItemContainer)for(var n=e[i].getContainedItems(),s=0;s<n.length;s++)if(n[s].getGUID()==this.getGUID())return e[i]}findGroupItems(){var e=[];if(null!=this.getGroup())for(var t=U.getItems(),i=0;i<t.length;i++)t[i].getGroup()==this._groupid&&e.push(t[i]);return e}refreshPositioning(){if(null!=this._targetdiv){var e=U.convertCanvasToWindowCoordinates(this.getDimensions());$("#"+this.getDiv()).css({width:e.width,height:e.height,top:e.top,left:e.left})}}refreshImage(e){}getSelected(){return this._isSelected}setSelected(e){this._isSelected=e}getTempDimensions(){return this._tempcanvasimagedimensions}storeTempDimensions(){this._tempcanvasimagedimensions={left:this._dimensions.left,top:this._dimensions.top,width:this._dimensions.width,height:this._dimensions.height}}clearTempDimensions(){this._tempcanvasimagedimensions=void 0}setShape(e){this._shape=e,this.dirty=!0,this.updateCircular()}updateCircular(){null!=this.getDiv()&&this.getShape()==s.circle?$("#"+this.getDiv()).css({"border-radius":"50%"}):$("#"+this.getDiv()).css({"border-radius":"0%"})}getShape(){return this._shape}setImage(e){this._image=e}getImage(){return this._image}setDiv(e){this._targetdiv=e}getDiv(){return this._targetdiv}setActive(e){this._active=e}getActive(){return this._active}activate(e){0==this._active&&(this.refreshPositioning(),this._active=!0,null!=this.getDiv()&&$("#"+this.getDiv()).css({display:"block"}))}deactivate(){this._active&&(this.setActive(!1),null!=this.getDiv()&&$("#"+this.getDiv()).css({display:"none"}))}pointInsideItem(e){var t=this.getDimensions();return e.x>=t.left&&e.x<=t.left+t.width&&e.y>=t.top&&e.y<=t.top+t.height}pointInsideItemWithTolerance(e,t){var i=this.getDimensions();return e.x>=i.left-t&&e.x<=i.left+i.width+t&&e.y>=i.top-t&&e.y<=i.top+i.height+t}renderPre(e,t){var i=this.getBackgroundColor(),n=this.getDimensions();if(e.fillStyle=i,e.strokeStyle=this.borderColor,e.shadowColor="#898",e.shadowBlur=2.5*this.shadowWidth,e.shadowOffsetX=0,e.shadowOffsetY=this.shadowWidth,e.lineWidth=this.borderWidth,null!=this.borderPattern?e.setLineDash(r.borderPatterns[this.borderPattern]):e.setLineDash([]),e.globalAlpha=this.backgroundOpacity,this.getShape()!=s.rectangle){if(e.save(),n=this.getDimensions(),this.getShape()==s.roundedCornerRectangle)this.roundRect(e,n.left,n.top,n.width,n.height,50,!0,!0);else{e.beginPath();var o=Math.sqrt(n.width*n.width+n.height*n.height);o=n.width>n.height?n.height/2:n.width/2,e.arc(n.left+n.width/2,n.top+n.height/2,o,0,2*Math.PI,!0),e.stroke(),e.closePath()}e.clip()}}drawPoint(e,t,i){e.save(),e.beginPath(),e.lineWidth=1,e.arc(t.x,t.y,i,0,2*Math.PI,!1),e.closePath(),e.stroke(),e.fill(),e.restore()}renderPost(t,i){var n=this.getDimensions();this.isLineSnapItem&&(i.setLineDash([]),i.fillStyle="rgb(128,128,255)",i.strokeStyle="rgb(255,255,255)",this.drawPoint(i,{x:n.left+n.width/2,y:n.top+n.height/2},5/t.getTransform().a),this.drawPoint(i,{x:n.left,y:n.top+n.height/2},5/t.getTransform().a),this.drawPoint(i,{x:n.left+n.width,y:n.top+n.height/2},5/t.getTransform().a),this.drawPoint(i,{x:n.left+n.width/2,y:n.top},5/t.getTransform().a),this.drawPoint(i,{x:n.left+n.width/2,y:n.top+n.height},5/t.getTransform().a)),this.getShape()!=s.rectangle&&t.restore(),this.getSelected()&&(this.getLocked()?i.strokeStyle="rgb(255,64,64)":i.strokeStyle="rgb(64,64,255)",i.lineWidth=1/t.getTransform().a,i.strokeRect(n.left,n.top,n.width,n.height));var r=this.getTags().getTagsHash(),o=e.allTags.getTagsHash();if(U.convertCanvasToWindowCoordinates(n).height>100){var a=5/t.getTransform().a,h=11/t.getTransform().a;t.textAlign="right",t.font=10/t.getTransform().a+"px monospace";var d=n.top+h;for(var l in r){var c=t.measureText(l),u=h,g=n.left-a+20/t.getTransform().a;t.fillStyle=o[l],t.fillRect(g-c.width-2/t.getTransform().a,d-u/1.5,c.width+4/t.getTransform().a,u/1.2),t.fillStyle="rgb(255,255,255)",t.fillText(l,g,d),d+=u}}else for(var l in a=5/t.getTransform().a,h=5/t.getTransform().a,d=n.top+h,r)u=h,t.fillStyle=o[l],t.fillRect(n.left-5/t.getTransform().a,d-u/1.5,10/t.getTransform().a,u/1.2),d+=u;t.shadowColor="#898",t.shadowBlur=0,t.shadowOffsetX=0,t.shadowOffsetY=0,t.globalAlpha=1}render(e,t){this.renderPre(e,t);var i=this.getBackgroundColor(),n=this.getDimensions();null!=i&&this.backgroundOpacity>0&&e.fillRect(n.left,n.top,n.width,n.height),this.borderWidth>0&&this.getShape()==s.rectangle&&e.strokeRect(n.left+(this.borderWidth-1)/2,n.top+(this.borderWidth-1)/2,n.width-(this.borderWidth-1),n.height-(this.borderWidth-1)),e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=0;var r=this.getImage();null!=r&&e.drawImage(r,n.left,n.top,n.width,n.height),this.renderPost(e,t)}roundRect(e,t,i,n,s,r,o,a){if(void 0===a&&(a=!0),void 0===r&&(r=5),"number"==typeof r)r={tl:r,tr:r,br:r,bl:r};else{var h={tl:0,tr:0,br:0,bl:0};for(var d in h)r[d]=r[d]||h[d]}e.beginPath(),e.moveTo(t+r.tl,i),e.lineTo(t+n-r.tr,i),e.quadraticCurveTo(t+n,i,t+n,i+r.tr),e.lineTo(t+n,i+s-r.br),e.quadraticCurveTo(t+n,i+s,t+n-r.br,i+s),e.lineTo(t+r.bl,i+s),e.quadraticCurveTo(t,i+s,t,i+s-r.bl),e.lineTo(t,i+r.tl),e.quadraticCurveTo(t,i,t+r.tl,i),e.closePath(),o&&e.fill(),a&&e.stroke()}connectWindow(e){this._connectedWindows.push({whiteboarditem:e,position:void 0,type:void 0}),this.dirty=!0}getConnectedWindows(){return this._connectedWindows}}const o={left:0,right:1,top:2,bottom:3,center:4};function a(e){return e*e}function h(e,t){return a(e.x-t.x)+a(e.y-t.y)}class d extends r{static lineSnapItem=void 0;static newLineMode=void 0;static pickTolerance=15;static setNewLineMode(e){d.newLineMode=e}static distToSegment(e,t,i){return Math.sqrt(function(e,t,i){var n=h(t,i);if(0==n)return h(e,t);var s=((e.x-t.x)*(i.x-t.x)+(e.y-t.y)*(i.y-t.y))/n;return s=Math.max(0,Math.min(1,s)),h(e,{x:t.x+s*(i.x-t.x),y:t.y+s*(i.y-t.y)})}(e,t,i))}static checkAndStartNewLine(e,t){if(null!=d.newLineMode){var i;(i=0==d.newLineMode?new d(new Communicator.Point2(e.x,e.y),new Communicator.Point2(e.x,e.y)):1==d.newLineMode?new l(new Communicator.Point2(e.x,e.y),new Communicator.Point2(e.x,e.y)):new c(new Communicator.Point2(e.x,e.y),new Communicator.Point2(e.x,e.y))).initialize(),null!=t&&i.setSnapItem(0,t,o.center);var n=new y(x.dragLinePoint);return d.addLine(i),n.extra={line:i,pointinfo:{id:1,isCandidate:!1}},d.newLineMode=void 0,n}}static addLine(e){U.getItems().push(e)}static deletePointFromDoubleClick(e){var t=d.pickTolerance/U.getZoomFactor(),i=d.getSingleSelectedLine();if(null!=i){var n=i.findSelection(e,t);if(null!=n&&(null==n.isCandidate||0==n.isCandidate))return i.deletePoint(n.id),!0}return!1}static getSingleSelectedLine(){var e=U.getCachedSelectedItems();return 1==e.length&&e[0].getType()==t.wbLine?e[0]:void 0}static checkAndStartLinePointSelection(e){var t=d.pickTolerance/U.getZoomFactor(),i=d.getSingleSelectedLine();if(null!=i){var n=i.findSelection(e,t);if(null!=n){var s=new y(x.dragLinePoint);return s.extra={line:i,pointinfo:n},s}}}static dragLinePointSelection(e,t){return null!=t&&t.type==x.dragLinePoint&&(t.extra.line.dragPoint(t.extra.pointinfo,e,U.getZoomFactor(),!0),U.redraw(),!0)}static finalizePointDrag(e){null!=e&&e.type==x.dragLinePoint&&e.extra.line.finalizePointDrag(e)}static updateAllSnappedLinePoints(){for(var e=U.getCachedLineItems(),t=0;t<e.length;t++)null!=e[t].snapItems[0]&&e[t].updateSnappedLinePoints(0),null!=e[t].snapItems[1]&&e[t].updateSnappedLinePoints(1)}static updateAllLineData(){for(var e=U.getCachedLineItems(),t=0;t<e.length;t++)e[t].recalculateLineData()}constructor(e,i){super(),this.shadowWidth=0,this._type=t.wbLine,this.lineType=0,this.points=[],this.pointCandidates=[],this.points.push(e),this.points.push(i),this.drawStartArrow=!1,this.drawEndArrow=!0,this.borderWidth=3,this.snapItems=[void 0,void 0]}initialize(){this.recalculateLineData()}finalizePointDrag(e){}setDrawArrows(e,t){this.drawStartArrow=e,this.drawEndArrow=t}setFromJSON(e){super.setFromJSON(e),this.lineType=e.lineType,this.points=e.points,this.drawStartArrow=e.drawStartArrow,this.drawEndArrow=e.drawEndArrow,this.snapItems=e.snapItems,null==this.snapItems[0]&&(this.snapItems[0]=void 0),null==this.snapItems[1]&&(this.snapItems[1]=void 0)}serialize(){var e=super.serialize();return e.points=this.points,e.drawStartArrow=this.drawStartArrow,e.drawEndArrow=this.drawEndArrow,e.lineType=this.lineType,e.snapItems=[void 0,void 0],e.snapItems[0]=null!=this.snapItems[0]?{item:this.snapItems[0].item._guid,position:this.snapItems[0].position}:void 0,e.snapItems[1]=null!=this.snapItems[1]?{item:this.snapItems[1].item._guid,position:this.snapItems[1].position}:void 0,e}setSnapItem(e,t,i){this.snapItems[e]={item:t,position:i}}move(e,t,i){var n=this.getDimensions();if(i)for(var s=0;s<this.points.length;s++)this.points[s].x+=e,this.points[s].y+=t;else{var r=n.left-e,o=n.top-t;for(s=0;s<this.points.length;s++)this.points[s].x-=r,this.points[s].y-=o}super.move(e,t,i)}scale(e){for(var t=this.getDimensions(),i=t.width/e.width,n=t.height/e.height,s=t.left-e.left,r=t.top-e.top,o=0;o<this.points.length;o++){var a=this.points[o].x-t.left,h=this.points[o].y-t.top;this.points[o].x=t.left+a/i,this.points[o].y=t.top+h/n,this.points[o].x-=s,this.points[o].y-=r}this.recalculateLineData(),this._dimensions=e}recalculateBounding(){for(var e=this.getDimensions(),t={x1:Number.MAX_VALUE,y1:Number.MAX_VALUE,x2:-Number.MAX_VALUE,y2:-Number.MAX_VALUE},i=0;i<this.points.length;i++)t.x1>this.points[i].x&&(t.x1=this.points[i].x),t.x2<this.points[i].x&&(t.x2=this.points[i].x),t.y1>this.points[i].y&&(t.y1=this.points[i].y),t.y2<this.points[i].y&&(t.y2=this.points[i].y);e.left=t.x1-25,e.top=t.y1-25,e.width=t.x2-t.x1+50,e.height=t.y2-t.y1+50}recalculateLineData(){this.recalculateBounding(),this.calculatePointCandidates()}calculatePointCandidates(){this.pointCandidates=[];for(var e=0;e<this.points.length-1;e++)this.pointCandidates.push(new Communicator.Point2((this.points[e].x+this.points[e+1].x)/2,(this.points[e].y+this.points[e+1].y)/2))}addPoint(e){this.points.push(e)}deletePoint(e){this.points.length>2&&(this.points.splice(e,1),this.recalculateLineData())}findSelection(e,t){for(var i=0;i<this.points.length;i++)if(e.x>=this.points[i].x-t&&e.x<=this.points[i].x+t&&e.y>=this.points[i].y-t&&e.y<=this.points[i].y+t)return{id:i,isCandidate:!1,hor:this.points[i].hor,pt:this.points[i]};for(i=0;i<this.pointCandidates.length;i++)if(e.x>=this.pointCandidates[i].x-t&&e.x<=this.pointCandidates[i].x+t&&e.y>=this.pointCandidates[i].y-t&&e.y<=this.pointCandidates[i].y+t)return null==this.pointCandidates[i].insertId?{id:i,isCandidate:!0,hor:this.pointCandidates[i].hor,pt:this.pointCandidates[i]}:{id:this.pointCandidates[i].insertId,isCandidate:!0,hor:this.pointCandidates[i].hor,pt:this.pointCandidates[i]}}dragPoint(e,t){if(1==e.isCandidate)this.points.splice(e.id+1,0,new Communicator.Point2(t.x,t.y)),e.isCandidate=!1,e.id=e.id+1;else{if(0==e.id||e.id==this.points.length-1){var i=this.snapToWindow(t,e.id);if(null!=i)return this.points[e.id].x=i.x,this.points[e.id].y=i.y,void this.recalculateLineData()}this.points[e.id].x=t.x,this.points[e.id].y=t.y}this.setDirty(),this.recalculateLineData()}checkClose(e,t,i,n,s){return e>=i-s&&e<=i+s&&t>=n-s&&t<=n+s}adjustEndPoint(e){}updateSnappedLinePoints(e){this.setDirty();var t,i,n=this.snapItems[e],s=n.item.getDimensions();if(n.position==o.left)t=s.left,i=s.top+s.height/2;else if(n.position==o.right)t=s.left+s.width,i=s.top+s.height/2;else if(n.position==o.top)t=s.left+s.width/2,i=s.top;else if(n.position==o.bottom)t=s.left+s.width/2,i=s.top+s.height;else if(n.position==o.center){var r=this.updateCenterSnap(e);t=r.x,i=r.y}0==e?(this.points[0].x=t,this.points[0].y=i,this.adjustEndPoint(0)):(this.points[this.points.length-1].x=t,this.points[this.points.length-1].y=i,this.adjustEndPoint(1))}updateCenterSnap(e){var t,i,n,s,r,a=this.snapItems[e].item;0==e?(n=this.points[1].x,s=this.points[1].y):(n=this.points[this.points.length-2].x,s=this.points[this.points.length-2].y);var h=a.getDimensions();t=h.left,i=h.top+h.height/2;var d=o.left;r=Math.sqrt(Math.pow(t-n,2)+Math.pow(i-s,2));var l=h.left+h.width,c=h.top+h.height/2,u=Math.sqrt(Math.pow(l-n,2)+Math.pow(c-s,2));return u<r&&(r=u,t=l,i=c,d=o.right),l=h.left+h.width/2,c=h.top,(u=Math.sqrt(Math.pow(l-n,2)+Math.pow(c-s,2)))<r&&(r=u,t=l,i=c,d=o.top),l=h.left+h.width/2,c=h.top+h.height,(u=Math.sqrt(Math.pow(l-n,2)+Math.pow(c-s,2)))<r&&(r=u,t=l,i=c,d=o.bottom),{x:t,y:i,position:d}}snapToWindow(e,i){var n,s=25/U.getZoomFactor();d.lineSnapItem&&(d.lineSnapItem.isLineSnapItem=!1,d.lineSnapItem=void 0),n=i==this.points.length-1?1:0,this.snapItems[n]=void 0;for(var r=U.getItems(),a=0;a<r.length;a++)if(r[a].getType()!=t.wbLine&&r[a].pointInsideItemWithTolerance(e,35)){d.lineSnapItem&&(d.lineSnapItem.isLineSnapItem=!1),r[a].isLineSnapItem=!0,d.lineSnapItem=r[a],r[a].isLineSnapItem=!0;var h=r[a].getDimensions(),l=h.left,c=h.top+h.height/2;if(this.checkClose(e.x,e.y,l,c,s))return this.snapItems[n]={item:r[a],position:o.left},{x:l,y:c};if(l=h.left+h.width,c=h.top+h.height/2,this.checkClose(e.x,e.y,l,c,s))return this.snapItems[n]={item:r[a],position:o.right},{x:l,y:c};if(l=h.left+h.width/2,c=h.top,this.checkClose(e.x,e.y,l,c,s))return this.snapItems[n]={item:r[a],position:o.top},{x:l,y:c};if(l=h.left+h.width/2,c=h.top+h.height,this.checkClose(e.x,e.y,l,c,s))return this.snapItems[n]={item:r[a],position:o.bottom},{x:l,y:c};if(l=h.left+h.width/2,c=h.top+h.height/2,this.checkClose(e.x,e.y,l,c,s))return this.snapItems[n]={item:r[a],position:o.center},{x:l,y:c}}}pointInsideItem(e){if(super.pointInsideItem(e))for(var t=0;t<this.points.length-1;t++)if(d.distToSegment(e,this.points[t],this.points[t+1])<5)return!0;return!1}arrowLine(e,t){var i=Communicator.Point2.subtract(t,e),n=Communicator.Point2.distance(t,e);return i.x/=n,i.y/=n,new Communicator.Point2(e.x+i.x*this.borderWidth,e.y+i.y*this.borderWidth)}render(e){if(this.renderPre(e),e.save(),e.lineJoin="round",e.fillStyle=this.borderColor,this.points.length,e.beginPath(),this.drawStartArrow){var t=this.arrowLine(this.points[0],this.points[1]);e.moveTo(t.x,t.y)}else e.moveTo(this.points[0].x,this.points[0].y);for(var i=1;i<this.points.length-1;i++)e.lineTo(this.points[i].x,this.points[i].y);this.drawEndArrow?(t=this.arrowLine(this.points[this.points.length-1],this.points[this.points.length-2]),e.lineTo(t.x,t.y)):e.lineTo(this.points[this.points.length-1].x,this.points[this.points.length-1].y),e.stroke(),this.renderPost(e)}renderPost(e){this.drawPoints(e),this.drawArrows(e),e.restore()}drawPoints(e){if(this.getSelected()&&1==U.getCachedSelectedItems().length){e.save(),e.setLineDash([]),e.strokeStyle="rgb(0,0,0)",e.fillStyle="rgb(255,255,255)",this.drawPoint(e,this.points[0],5);for(var t=1;t<this.points.length;t++)this.drawPoint(e,this.points[t],5);for(e.strokeStyle="rgb(255,255,255)",e.fillStyle="rgb(160, 160, 255)",t=0;t<this.pointCandidates.length;t++)this.drawPoint(e,this.pointCandidates[t],5);e.restore()}}drawArrows(e){this.drawStartArrow&&this.drawLineWithArrows(e,this.points[1],this.points[0],7,13,!0,!1),this.drawEndArrow&&this.drawLineWithArrows(e,this.points[this.points.length-2],this.points[this.points.length-1],7,13,!0,!1)}drawLineWithArrows(e,t,i,n,s,r,o){this.borderWidth<4?(n=7,s=13):(n=2*this.borderWidth*.9,s=4*this.borderWidth*.9);var a=t.x-i.x,h=t.y-i.y,d=Math.atan2(h,a);Math.sqrt(a*a+h*h),e.save(),e.translate(i.x,i.y),e.rotate(d),e.beginPath(),e.moveTo(s,-n),e.lineTo(0,0),e.lineTo(s,n),e.lineTo(s,-n),e.fill(),e.restore()}}class l extends d{constructor(e,t){super(e,t),this.lineType=1,this.cp=[],this.curveSubdivisions=20}setFromJSON(e){super.setFromJSON(e),this.cp=e.cp}serialize(){var e=super.serialize();return e.cp=this.cp,e}recalculateLineData(){this.fitControlPoints(),super.recalculateLineData()}updateCenterSnap(e){var t=super.updateCenterSnap(e);return this.adjustSnapCurve(e,t.position),t}adjustSnapCurve(e,t){var i,n,s,r=100;1==e&&(i=this.snapItems[1],n=this.cp[this.cp.length-2]),0==e&&(i=this.snapItems[0],n=this.cp[1]),s=null!=t?t:i.position;var a=i.item.getDimensions(),h=a.left+a.width/2,d=a.top+a.height/2;s==o.left?(n.x=a.left-r,n.y=d):s==o.right?(n.x=a.left+a.width+r,n.y=d):s==o.top?(n.x=h,n.y=a.top-r):s==o.bottom&&(n.x=h,n.y=a.top+a.height+r)}fitControlPoints(){if(!U.ctrlPressed){this.cp=[];for(var e=0;e<this.points.length;e++)0==e?this.cp=this.cp.concat(this.fitControlPointSet(this.points[0],this.points[0],this.points[1],.3)):e==this.points.length-1?this.cp=this.cp.concat(this.fitControlPointSet(this.points[e-1],this.points[e],this.points[e],.3)):this.cp=this.cp.concat(this.fitControlPointSet(this.points[e-1],this.points[e],this.points[e+1],.3));null!=this.snapItems[1]&&(this.snapItems[1].position==o.center?this.updateCenterSnap(1):this.adjustSnapCurve(1)),null!=this.snapItems[0]&&(this.snapItems[0].position==o.center?this.updateCenterSnap(0):this.adjustSnapCurve(0))}}bezierCurveToTessellated(e,t,i,n,s,r,o,a){for(var h=[],d=[[e,t],[i,n],[s,r],[o,a]],l=0;l<=this.curveSubdivisions;l++){var c,u,g,m,p,f,v,w,x=l/this.curveSubdivisions;g=3*(d[1][0]-d[0][0]),u=3*(d[2][0]-d[1][0])-g,c=d[3][0]-d[0][0]-g-u,f=3*(d[1][1]-d[0][1]),p=3*(d[2][1]-d[1][1])-f,m=d[3][1]-d[0][1]-f-p;var y=c*(w=(v=x*x)*x)+u*v+g*x+d[0][0],b=m*w+p*v+f*x+d[0][1];h.push(new Communicator.Point2(y,b))}return h}calculatePointCandidates(){this.pointCandidates=[];for(var e=0;e<this.points.length-1;e++){var t=this.points[e],i=this.points[e+1];if(e<this.points.length-1){var n=this.bezierCurveToTessellated(t.x,t.y,this.cp[2*e+1].x,this.cp[2*e+1].y,this.cp[2*e+2].x,this.cp[2*e+2].y,i.x,i.y)[this.curveSubdivisions/2];n.insertId=e,this.pointCandidates.push(n)}}}pointInsideItem(e){var t=this.getDimensions();if(e.x>=t.left&&e.x<=t.left+t.width&&e.y>=t.top&&e.y<=t.top+t.height)for(var i=0;i<this.points.length-1;i++){var n=this.points[i],s=this.points[i+1];if(i<this.points.length-1)for(var r=this.bezierCurveToTessellated(n.x,n.y,this.cp[2*i+1].x,this.cp[2*i+1].y,this.cp[2*i+2].x,this.cp[2*i+2].y,s.x,s.y),o=0;o<r.length-1;o++)if(d.distToSegment(e,r[o],r[o+1])<5)return!0}return!1}fitControlPointSet(e,t,i,n){var s=Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)),r=n*s/(s+Math.sqrt(Math.pow(i.x-t.x,2)+Math.pow(i.y-t.y,2))),o=n-r,a=t.x+r*(e.x-i.x),h=t.y+r*(e.y-i.y),d=t.x-o*(e.x-i.x),l=t.y-o*(e.y-i.y);return[new Communicator.Point2(a,h),new Communicator.Point2(d,l)]}render(e){this.renderPre(e),e.save(),e.fillStyle=this.borderColor,this.points.length,e.beginPath();for(var t=0;t<this.points.length-1;t++){var i=this.points[t],n=this.points[t+1],s=i,r=n;if(0==t||t==this.points.length-2){if(0==t&&1==this.drawStartArrow){var o=Communicator.Point2.subtract(this.cp[1],i),a=Communicator.Point2.distance(this.cp[1],i);o.x/=a,o.y/=a,s=new Communicator.Point2(i.x+o.x*this.borderWidth,i.y+o.y*this.borderWidth)}t==this.points.length-2&&1==this.drawEndArrow&&(o=Communicator.Point2.subtract(this.cp[this.cp.length-2],n),a=Communicator.Point2.distance(this.cp[this.cp.length-2],n),o.x/=a,o.y/=a,r=new Communicator.Point2(n.x+o.x*this.borderWidth,n.y+o.y*this.borderWidth))}e.moveTo(s.x,s.y),t<this.points.length-1&&e.bezierCurveTo(this.cp[2*t+1].x,this.cp[2*t+1].y,this.cp[2*t+2].x,this.cp[2*t+2].y,r.x,r.y)}e.stroke(),e.closePath(),this.renderPost(e)}move(e,t,i){super.move(e,t,i),this.fitControlPoints()}updateSnappedLinePoints(e){super.updateSnappedLinePoints(e),this.fitControlPoints()}drawArrows(e){this.drawStartArrow&&this.drawLineWithArrows(e,this.cp[1],this.points[0],7,13,!0,!1),this.drawEndArrow&&this.drawLineWithArrows(e,this.cp[this.cp.length-2],this.points[this.points.length-1],7,13,!0,!1)}}class c extends d{constructor(e,t){super(e,t),this.lineType=2,this.segments=[],this.segments.push({point1:void 0,point2:void 0,pt:void 0,isCandidate:!0}),this.segments.push({point1:void 0,point2:void 0,pt:void 0,isCandidate:!0}),this.segments.push({point1:void 0,point2:void 0,pt:void 0,isCandidate:!0}),this.start=!0}setFromJSON(e){super.setFromJSON(e),this.segments=e.segments}serialize(){var e=super.serialize();return e.segments=this.segments,e}findSelection(e,t){for(var i=0;i<this.segments.length;i++)if(e.x>=this.segments[i].pt.x-t&&e.x<=this.segments[i].pt.x+t&&e.y>=this.segments[i].pt.y-t&&e.y<=this.segments[i].pt.y+t)return{id:i,isSegment:!0};for(i=0;i<this.points.length;i++)if(e.x>=this.points[i].x-t&&e.x<=this.points[i].x+t&&e.y>=this.points[i].y-t&&e.y<=this.points[i].y+t)return{id:i,isSegment:!1}}deletePoint(e){e>1&&(0==this.segments[e].hor?(this.segments[e-2].point2.x=this.segments[e].point2.x,this.segments[e+1].point1=this.segments[e-2].point2):(this.segments[e-2].point2.y=this.segments[e].point2.y,this.segments[e+1].point1=this.segments[e-2].point2)),this.segments.splice(e,1),this.segments.splice(e-1,1),this.recalculateLineData()}adjustEndPoint(e){if(1==e){var t=this.points[1];this.segments[this.segments.length-1].point2.x=t.x,this.segments[this.segments.length-1].point2.y=t.y,1==this.segments[this.segments.length-1].hor?this.segments[this.segments.length-1].point1.x=t.x:this.segments[this.segments.length-1].point1.y=t.y}else t=this.points[0],this.segments[0].point1.x=t.x,this.segments[0].point1.y=t.y,1==this.segments[0].hor?this.segments[0].point2.x=t.x:this.segments[0].point2.y=t.y}dragPoint(e,t){if(null==e.isCandidate&&1==this.segments[e.id].isCandidate&&1==e.isSegment){var i;this.segments[e.id].isCandidate=!1,e.id==this.segments.length-1&&((i={point1:void 0,point2:void 0,pt:void 0,isCandidate:!0}).point1=this.segments[this.segments.length-1].point2,i.point2=this.segments[this.segments.length-1].point2.copy(),i.hor=!this.segments[this.segments.length-1].hor,this.segments.push(i),this.segments[e.id].isCandidate=!1),0==e.id&&((i={point1:void 0,point2:void 0,pt:void 0,isCandidate:!0}).point1=this.segments[0].point1.copy(),i.point2=this.segments[0].point1,i.hor=!this.segments[0].hor,this.segments.splice(0,0,i),e.id=1),this.start=!1}else{if(null!=e.isCandidate||0==e.isSegment){var n=this.snapToWindow(t,e.id);null!=n&&(t=n),this.points[e.id].x=t.x,this.points[e.id].y=t.y,0==e.isSegment&&this.adjustEndPoint(e.id)}if(1==e.isSegment){var s=this.segments[e.id];1==s.hor?(s.pt.x=t.x,s.point1.x=t.x,s.point2.x=t.x):(s.pt.y=t.y,s.point1.y=t.y,s.point2.y=t.y)}}this.recalculateLineData()}calculateSteps(e){if(this.points[0].x,this.points[0].y,1==this.start){this.segments[0].point1=new Communicator.Point2(this.points[0].x,this.points[0].y),this.segments[0].point2=new Communicator.Point2((this.points[0].x+this.points[1].x)/2,this.points[0].y),this.segments[0].hor=!1,this.segments[1].point1=this.segments[0].point2,this.segments[1].point2=new Communicator.Point2((this.points[0].x+this.points[1].x)/2,this.points[1].y),this.segments[1].hor=!0,this.segments[2].point1=this.segments[1].point2,this.segments[2].point2=new Communicator.Point2(this.points[1].x,this.points[1].y),this.segments[2].hor=!1;for(var t=0;t<this.segments.length;t++)this.segments[t].pt=new Communicator.Point2((this.segments[t].point1.x+this.segments[t].point2.x)/2,(this.segments[t].point1.y+this.segments[t].point2.y)/2)}else{for(t=0;t<this.segments.length;t++)this.segments[t].pt=new Communicator.Point2((this.segments[t].point1.x+this.segments[t].point2.x)/2,(this.segments[t].point1.y+this.segments[t].point2.y)/2);this.points[0]=this.segments[0].point1.copy(),this.points[1]=this.segments[this.segments.length-1].point2.copy()}}addCandidate(e,t,i,n){var s=new Communicator.Point2((e.x+t.x)/2,(e.y+t.y)/2);s.insertId=n,s.hor=i,this.pointCandidates.push(s)}render(e){if(this.renderPre(e),e.save(),e.fillStyle=this.borderColor,this.points.length,this.calculateSteps(!1),e.beginPath(),this.drawStartArrow){var t=this.arrowLine(this.segments[0].point1,this.segments[1].point1);e.moveTo(t.x,t.y)}else e.moveTo(this.segments[0].point1.x,this.segments[0].point1.y);for(var i=1;i<this.segments.length;i++)e.lineTo(this.segments[i].point1.x,this.segments[i].point1.y);this.drawEndArrow?(t=this.arrowLine(this.segments[this.segments.length-1].point2,this.segments[this.segments.length-1].point1),e.lineTo(t.x,t.y)):e.lineTo(this.segments[this.segments.length-1].point2.x,this.segments[this.segments.length-1].point2.y),e.stroke(),e.closePath(),this.renderPost(e)}calculatePointCandidates(){this.calculateSteps(!0)}scale(e){for(var t=this.getDimensions(),i=t.width/e.width,n=t.height/e.height,s=t.left-e.left,r=t.top-e.top,o=0;o<this.points.length;o++){var a=this.points[o].x-t.left,h=this.points[o].y-t.top;this.points[o].x=t.left+a/i,this.points[o].y=t.top+h/n,this.points[o].x-=s,this.points[o].y-=r}var d=void 0;for(o=0;o<this.segments.length;o++)d!=this.segments[o].point1&&(a=this.segments[o].point1.x-t.left,h=this.segments[o].point1.y-t.top,this.segments[o].point1.x=t.left+a/i,this.segments[o].point1.y=t.top+h/n,this.segments[o].point1.x-=s,this.segments[o].point1.y-=r,d=this.segments[o].point1),d!=this.segments[o].point2&&(a=this.segments[o].point2.x-t.left,h=this.segments[o].point2.y-t.top,this.segments[o].point2.x=t.left+a/i,this.segments[o].point2.y=t.top+h/n,this.segments[o].point2.x-=s,this.segments[o].point2.y-=r,d=this.segments[o].point2);this.recalculateLineData(),this._dimensions=e}move(e,t,i){var n=this.getDimensions(),s=n.left-e,r=n.top-t;i&&(s=-e,r=-t);for(var o=0;o<this.points.length;o++)this.points[o].x-=s,this.points[o].y-=r;var a=void 0;for(o=0;o<this.segments.length;o++)a!=this.segments[o].point1&&(this.segments[o].point1.x-=s,this.segments[o].point1.y-=r,a=this.segments[o].point1),a!=this.segments[o].point2&&(this.segments[o].point2.x-=s,this.segments[o].point2.y-=r,a=this.segments[o].point2);i?(this._dimensions.left+=e,this._dimensions.top+=t):(this._dimensions.left=e,this._dimensions.top=t),this.refreshPositioning()}updateCenterSnap(e){var t,i,n,s,r,o=Number.MAX_VALUE,a=this.snapItems[e].item;0==e?(n=this.segments[0].point2.x,s=this.segments[0].point2.y,r=this.segments[0].hor):(n=this.segments[this.segments.length-1].point1.x,s=this.segments[this.segments.length-1].point1.y,r=this.segments[this.segments.length-1].hor),t=Number.MAX_VALUE,i=Number.MAX_VALUE;var h=a.getDimensions();if(r)l=h.left+h.width/2,c=h.top,(d=Math.sqrt(Math.pow(l-n,2)+Math.pow(c-s,2)))<o&&(o=d,t=l,i=c),l=h.left+h.width/2,c=h.top+h.height,(d=Math.sqrt(Math.pow(l-n,2)+Math.pow(c-s,2)))<o&&(o=d,t=l,i=c);else{l=h.left,c=h.top+h.height/2,(d=Math.sqrt(Math.pow(l-n,2)+Math.pow(c-s,2)))<o&&(o=d,t=l,i=c);var d,l=h.left+h.width,c=h.top+h.height/2;(d=Math.sqrt(Math.pow(l-n,2)+Math.pow(c-s,2)))<o&&(o=d,t=l,i=c)}return{x:t,y:i}}recalculateBounding(){for(var e=this.getDimensions(),t={x1:Number.MAX_VALUE,y1:Number.MAX_VALUE,x2:-Number.MAX_VALUE,y2:-Number.MAX_VALUE},i=0;i<this.segments.length;i++)null!=this.segments[i].point1&&(t.x1>this.segments[i].point1.x&&(t.x1=this.segments[i].point1.x),t.x2<this.segments[i].point1.x&&(t.x2=this.segments[i].point1.x),t.y1>this.segments[i].point1.y&&(t.y1=this.segments[i].point1.y),t.y2<this.segments[i].point1.y&&(t.y2=this.segments[i].point1.y));null!=this.segments[0].point1&&(t.x1>this.segments[this.segments.length-1].point2.x&&(t.x1=this.segments[this.segments.length-1].point2.x),t.x2<this.segments[this.segments.length-1].point2.x&&(t.x2=this.segments[this.segments.length-1].point2.x),t.y1>this.segments[this.segments.length-1].point2.y&&(t.y1=this.segments[this.segments.length-1].point2.y),t.y2<this.segments[this.segments.length-1].point2.y&&(t.y2=this.segments[this.segments.length-1].point2.y)),e.left=t.x1-25,e.top=t.y1-25,e.width=t.x2-t.x1+50,e.height=t.y2-t.y1+50}pointInsideItem(e){var t=this.getDimensions();if(e.x>=t.left&&e.x<=t.left+t.width&&e.y>=t.top&&e.y<=t.top+t.height)for(var i=0;i<this.segments.length;i++)if(d.distToSegment(e,this.segments[i].point1,this.segments[i].point2)<5)return!0;return!1}finalizePointDrag(e){for(var t=0;t<this.segments.length;t++)Math.abs(this.segments[t].point1.x-this.segments[t].point2.x)<5&&Math.abs(this.segments[t].point1.y-this.segments[t].point2.y)<5&&(t>1?(this.segments[t+1].point1=this.segments[t-1].point1,this.segments.splice(t,1),this.segments.splice(t-1,1)):(this.segments[t-1].point2=this.segments[t+1].point2,this.segments.splice(t,1),this.segments.splice(t,1)))}drawPoints(e){if(this.getSelected()&&1==U.getCachedSelectedItems().length){e.save(),e.strokeStyle="rgb(0,0,0)",e.fillStyle="rgb(255,255,255)",e.setLineDash([]);for(var t=0;t<this.segments.length;t++)0==this.segments[t].isCandidate&&this.drawPoint(e,this.segments[t].pt,3.5);for(t=0;t<this.points.length;t++)this.drawPoint(e,this.points[t],3.5);for(e.strokeStyle="rgb(255,255,255)",e.fillStyle="rgb(160, 160, 255)",t=0;t<this.segments.length;t++)1==this.segments[t].isCandidate&&this.drawPoint(e,this.segments[t].pt,3.5);e.restore()}}drawArrows(e){this.drawStartArrow&&this.drawLineWithArrows(e,this.segments[0].point2,this.segments[0].point1,7,13,!0,!1),this.drawEndArrow&&this.drawLineWithArrows(e,this.segments[this.segments.length-1].point1,this.segments[this.segments.length-1].point2,7,13,!0,!1)}}class u extends r{static dragAndArrangedTemp=void 0;static prepareForDragAndArrange(e){null!=u.dragAndArrangedTemp&&u.dragAndArrangedTemp.containerguid==e.getGUID()||(u.dragAndArrangedTemp={itemlist:U.getSelectedItems(),containerguid:e.getGUID(),newdims:[],insertBefore:void 0})}static clearDragAndArrange(){if(null!=u.dragAndArrangedTemp){for(var e=0;e<u.dragAndArrangedTemp.itemlist.length;e++){u.dragAndArrangedTemp.itemlist[e].getDimensions();var i=u.dragAndArrangedTemp.newdims[e];u.dragAndArrangedTemp.itemlist[e].move(i.left,i.top,!1)}var n=U.getItems(),s=[];for(e=0;e<u.dragAndArrangedTemp.itemlist.length;e++)if(s.push(u.dragAndArrangedTemp.itemlist[e]),u.dragAndArrangedTemp.itemlist[e].getType()==t.wbItemContainer)for(var r=0;r<u.dragAndArrangedTemp.itemlist[e]._containedItems.length;r++)s.push(u.dragAndArrangedTemp.itemlist[e]._containedItems[r]);for(u.dragAndArrangedTemp.itemlist=s,e=0;e<u.dragAndArrangedTemp.itemlist.length;e++)for(r=0;r<n.length;r++)if(n[r].getGUID()==u.dragAndArrangedTemp.itemlist[e].getGUID()){n.splice(r,1);break}if(null!=u.dragAndArrangedTemp.insertBefore){for(e=0;e<n.length;e++)if(n[e].getGUID()==u.dragAndArrangedTemp.insertBefore){for(r=u.dragAndArrangedTemp.itemlist.length-1;r>=0;r--)n.splice(e,0,u.dragAndArrangedTemp.itemlist[r]);break}}else for(r=0;r<u.dragAndArrangedTemp.itemlist.length;r++)n.push(u.dragAndArrangedTemp.itemlist[r]);u.dragAndArrangedTemp=void 0}}static assignItemsToContainer(){for(var e=U.getItems(),i=0;i<e.length;i++)e[i]._done=!1,e[i].containedIn=void 0;for(i=e.length-1;i>=0;i--)e[i].getType()==t.wbItemContainer&&e[i].findContainedItems()}static arrangeAllItemsByTags(){for(var e=U.getItems(),i=0;i<e.length;i++)e[i].getType()==t.wbItemContainer&&e[i].arrangeItems();U.redraw(),u.assignItemsToContainer()}constructor(){super(),this._containedItems=[],this._type=t.wbItemContainer,this._targetTags=new e,this._autoArrange=!1}setFromJSON(e){super.setFromJSON(e),this._targetTags.setFromJSON(e._targetTags)}serialize(){var e=super.serialize();return e._autoArrange=this._autoArrange,e._targetTags=this._targetTags.serialize(),e}static _findConnectedItemsRecursive(e,i){e.push(i);for(var n=i.getContainedItems(),s=0;s<n.length;s++)e.push(n[s]),n[s].getType()==t.wbItemContainer&&u._findConnectedItemsRecursive(e,n[s])}findConnectedItems(){var e=[];return u._findConnectedItemsRecursive(e,this),e}getAutoArange(){return this._autoArrange}setAutoArrange(e){this._autoArrange=e}move(e,t,i){var n,s;this.dirty=!0,i?(n=e,s=t,this._dimensions.left+=e,this._dimensions.top+=t):(n=e-this._dimensions.left,s=t-this._dimensions.top,this._dimensions.left=e,this._dimensions.top=t);for(var r=0;r<this._containedItems.length;r++)this._containedItems[r].move(n,s,!0)}dragItemsAndArrange(e){var t=[];if(null!=e){if(u.prepareForDragAndArrange(this),1==u.dragAndArrangedTemp.itemlist.length&&u.dragAndArrangedTemp.itemlist[0]==this)return void(u.dragAndArrangedTemp=void 0);t=u.dragAndArrangedTemp.itemlist}for(var i=this._containedItems,n=0;n<t.length;n++)for(var s=0;s<i.length;s++)if(t[n].getGUID()==i[s].getGUID()){i.splice(s,1);break}var r=this.getDimensions(),o=new Communicator.Point2(10,10),a=0;o=new Communicator.Point2(10,10);var h=!1;for(n=0;n<i.length;n++){var d,l=i[n].findConnectedContainer();if(!(d=null!=l&&l.getGUID()!=this.getGUID()?l:i[n]).getLocked()){var c=d.findGroupItems(),g=d.findConnectedItems().concat(c),m=U.calculateCombinedBounding(g),p={x:o.x,y:o.y,maxlineheight:a};o.x+m.width>r.width&&(o.x=10,o.y+=a+20,a=0);var f=r.left+o.x,v=r.top+o.y;if(null!=e&&e.x>=f-20&&e.x<=f+m.width+20&&e.y>=v-20&&e.y<=v+m.height+20&&!h){for(o.x=p.x,o.y=p.y,a=p.maxlineheight,u.dragAndArrangedTemp.newdims=[],u.dragAndArrangedTemp.insertBefore=d.getGUID(),n--,s=0;s<t.length;s++)m.width=t[s].getDimensions().width,m.height=t[s].getDimensions().height,o.x+m.width>r.width&&(o.x=10,o.y+=a+20,a=0),f=r.left+o.x,v=r.top+o.y,u.dragAndArrangedTemp.newdims.push({left:f,top:v}),a<m.height&&(a=m.height),o.x+=m.width+20;h=!0}else{var w=f-m.left,x=v-m.top;for(s=0;s<g.length;s++){var y=g[s].getDimensions();y.left=y.left+w,y.top=y.top+x,g[s].setDimensions(y)}a<m.height&&(a=m.height),o.x+=m.width+20}}}if(null!=e&&!h)for(u.dragAndArrangedTemp.newdims=[],s=0;s<t.length;s++){var b=t[s].getDimensions().width,_=t[s].getDimensions().height;o.x+b>r.width&&(o.x=10,o.y+=a+20,a=0),u.dragAndArrangedTemp.newdims.push({left:r.left+o.x,top:r.top+o.y}),a<_&&(a=_),o.x+=b+20}}arrangeItems(){this._autoArrange=!0;var e=this.getTargetTags(),t=[];for(var i in e.getTagsHash())t.push(i);if(t.length>0){for(var n=U.getItems(),s=this.getDimensions(),r=new Communicator.Point2(10,10),o=0,a=0;a<n.length;a++)n[a]._done=!1;for(a=0;a<n.length;a++)if(!n[a]._done&&n[a].getGUID()!=this.getGUID()){if((c=null!=(u=n[a].findConnectedContainer())&&u.getGUID()!=this.getGUID()?u:n[a]).getLocked())continue;if(c.hasTags(t)){(g=c.findGroupItems()).push(c);var h=U.calculateCombinedBounding(g),d=c.findConnectedItems().concat(g);10+h.width>s.width&&(s.width=10+h.width+5)}}for(a=0;a<n.length;a++)n[a]._done=!1;r=new Communicator.Point2(10,10);var l=0;for(a=0;a<n.length;a++)if(!n[a]._done&&n[a].getGUID()!=this.getGUID()){var c,u;if((c=null!=(u=n[a].findConnectedContainer())&&u.getGUID()!=this.getGUID()?u:n[a]).getLocked())continue;if(c.hasTags(t)){var g;(g=c.findGroupItems()).push(c),h=U.calculateCombinedBounding(g),d=c.findConnectedItems().concat(g),r.x+h.width>s.width&&(r.x=10,r.y+=o+20,o=0);var m=s.left+r.x,p=s.top+r.y,f=m-h.left,v=p-h.top;for(i=0;i<d.length;i++)if(!d[i]._done){var w=d[i].getDimensions();d[i]._done=!0,w.left=w.left+f,w.top=w.top+v,d[i].setDimensions(w)}o<h.height&&(o=h.height),r.x+=h.width+20,l=h.height+20}}var x=r.y-10+l+10;x>s.height&&(s.height=x),this.setDimensions(s)}}static _hasTagsRecursive(e,i){if(e._hasTag2(i))return!0;for(var n=0;n<e._containedItems.length;n++){if(e._containedItems[n].hasTags(i))return!0;if(e._containedItems[n].getType()==t.wbItemContainer)return u._hasTagsRecursive(e._containedItems[n],i)}return!1}_hasTag2(e){return super.hasTags(e)}hasTags(e){return u._hasTagsRecursive(this,e)}getContainedItems(){return this._containedItems}setTargetTag(e){this._targetTags.addTag(e)}getTargetTags(){return this._targetTags}async duplicate(){await this.deactivate();var e=new u;return super._duplicate(e),e}findContainedItems(){this._containedItems=[];for(var e=U.getItems(),t=this.getDimensions(),i=0;i<e.length;i++){var n=e[i].getDimensions();n.left>t.left&&n.left+n.width<t.left+t.width&&n.top>t.top&&n.top+n.height<t.top+t.height&&e[i].getGUID()!=this.getGUID()&&0==e[i]._done&&(this._containedItems.push(e[i]),e[i]._done=!0,e[i].containedIn=this)}}}function g(){return{camera:void 0,isolateNode:void 0,cadView:void 0,sheet:void 0,explode:void 0,drawMode:void 0,ambientOcclusion:void 0,bloom:void 0,projectionMode:void 0,measureData:void 0,selectedNodes:void 0,initialize:function(){},duplicate:function(){var e=new g;return e.copy(this),e.camera=this.camera.copy(),e},saveStatesFromHWV:function(e){this.camera=e.view.getCamera().copy(),this.drawMode=e.view.getDrawMode(),this.ambientOcclusion=e.view.getAmbientOcclusionEnabled(),this.bloom=e.view.getBloomEnabled(),this.projectionMode=e.view.getProjectionMode(),this.measureData=JSON.stringify(e.measureManager.exportMarkup()),this.selectedNodes=function(e){for(var t=[],i=e.selectionManager.getResults(),n=0;n<i.length;n++)t.push(i[n].getNodeId());return t}(e)},copy:function(e){this.isolateNode=e.isolateNode,this.cadView=e.cadView,this.sheet=e.sheet,this.explode=e.explode,this.drawMode=e.drawMode,this.ambientOcclusion=e.ambientOcclusion,this.bloom=e.bloom,this.projectionMode=e.projectionMode,this.selectedNodes=e.selectedNodes},serialize:function(){return{isolateNode:this.isolateNode,cadView:this.cadView,sheet:this.sheet,explode:this.explode,drawMode:this.drawMode,ambientOcclusion:this.ambientOcclusion,bloom:this.bloom,projectionMode:this.projectionMode,selectedNodes:this.selectedNodes,camera:null!=this.camera?this.camera.toJson():void 0}},saveCamera:function(e){this.camera=e},getCamera:function(){return this.camera},apply:function(e){var t=this;return new Promise((function(i,n){null!=t.explode?e.explodeManager.setMagnitude(t.explode).then((function(){i()})):null!=t.isolateNode?"number"==typeof t.isolateNode?e.view.isolateNodes([t.isolateNode],0).then((function(){i()})):e.view.isolateNodes(t.isolateNode,0).then((function(){i()})):null!=t.cadView?e.model.activateCadView(t.cadView,0).then((function(){i()})):null!=t.sheet?e.view.isolateNodes([t.sheet],0).then((function(){i()})):i()}))},activate:function(e){var t=this;return new Promise((function(i,n){e.selectionManager.setNodeSelectionColor(new Communicator.Color(255,0,0)),e.selectionManager.setNodeElementSelectionColor(new Communicator.Color(255,0,0)),e.selectionManager.setNodeSelectionOutlineColor(new Communicator.Color(255,0,0)),e.view.setAmbientOcclusionEnabled(!1),e.view.setBloomEnabled(!1),e.view.setBackfacesVisible(!0),e.explodeManager.setMagnitude(0);var s=e.view.getHiddenLineSettings();e.sheetManager.setBackgroundSheetEnabled(!1),s.setObscuredLineOpacity(0),e.view.setDrawMode(Communicator.DrawMode.WireframeOnShaded),e.measureManager.removeAllMeasurements(),e.setMinimumFramerate(v.minFramerate),e.selectionManager.clear(),e.reset(0).then((function(){if(null!=t.drawMode&&e.view.setDrawMode(t.drawMode),null!=t.ambientOcclusion&&e.view.setAmbientOcclusionEnabled(t.ambientOcclusion),null!=t.bloom&&e.view.setBloomEnabled(t.bloom),null!=t.projectionMode&&e.view.setProjectionMode(t.projectionMode),null!=t.measureData&&e.measureManager.loadData(JSON.parse(t.measureData)),null!=t.selectedNodes)for(var n=0;n<t.selectedNodes.length;n++)e.selectionManager.selectNode(t.selectedNodes[n],Communicator.SelectionMode.Add);null!=t.isolateNode?"number"==typeof t.isolateNode?e.view.isolateNodes([t.isolateNode],0).then((function(){e.view.setCamera(t.camera,0),i()})):e.view.isolateNodes(t.isolateNode,0).then((function(){e.view.setCamera(t.camera,0),i()})):null!=t.sheet?e.view.isolateNodes([t.sheet],0).then((function(){e.view.setCamera(t.camera,0),i()})):null!=t.cadView?e.model.activateCadView(t.cadView,0).then((function(){e.view.setCamera(t.camera,0),i()})):null!=t.explode?e.explodeManager.setMagnitude(t.explode).then((function(){e.view.setCamera(t.camera,0),i()})):(null!=t.camera&&e.view.setCamera(t.camera,0),i())}))}))}}}class m{constructor(e){this._viewer=e,this._bounding=null,this._mouseDownSelection=null,this._mouseButton=null,this._partinfo=[],this._click=!1,this._whiteboarditem=null,this._factor=4,this._connectedWindow=void 0,this._magDone=void 0}setItem(e){this._whiteboarditem=e}onMouseDown(e){if(this._click=!0,this._magDone=void 0,this._connectedWindow=void 0,this._mouseButton=e.getButton(),this._mouseButton===Communicator.Button.Left&&e.shiftDown())for(var t=this._whiteboarditem.getConnectedWindows(),i=e.getPosition(),n=wbMain.getZoomFactor(),s=0;s<t.length;s++){var r=t[s].position,o=void 0;if(null!=r&&(o={left:r.left*n,top:r.top*n,radius:r.radius*n}),null==o||i.x>o.left-o.radius&&i.x<o.left+o.radius&&i.y>o.top-o.radius&&i.y<o.top+o.radius){this._connectedWindow=s,this._magDone=!0;break}}}onMouseUp(e){null!=this._magDone&&(e.setHandled(!0),this._magDone=void 0,this._click=!1)}onMousewheel(e){e.shiftDown()&&(e.getWheelDelta()>0?this._factor-=2:this._factor+=2,this._factor<1&&(this._factor=1),this.doPick(e),e.setHandled(!0))}doPick(e){var t=this,i=(e.getPosition().copy(),new Communicator.PickConfig(Communicator.SelectionMask.All));this._viewer.view.pickFromPoint(e.getPosition(),i).then((function(e){var i=e.getPosition();if(null!=i){var n=t._viewer.view.getCamera().copy(),s=n.getPosition().copy(),r=n.getTarget().copy(),o=n.getUp().copy(),a=n.getWidth(),h=n.getHeight(),d=Communicator.Point3.subtract(r,s),l=d.length();d.normalize();var c=Communicator.Point3.cross(o,d);l/=t._factor;var u=new Communicator.Point3(s.x-d.x*l,s.y-d.y*l,s.z-d.z*l),g=Communicator.Point3.subtract(s,i);n.setTarget(i),n.setPosition(new Communicator.Point3(u.x-g.x,u.y-g.y,u.z-g.z)),a/=t._factor,h/=t._factor,n.setWidth(a),n.setHeight(h),c.scale(a/2),o.scale(h/2);var m=Communicator.Point3.add(i,c),p=Communicator.Point3.add(i,o),f=t._viewer.view.projectPoint(m),v=(t._viewer.view.projectPoint(p),t._viewer.view.projectPoint(i)),w=wbMain.getZoomFactor(),x=t._whiteboarditem.getConnectedWindows();x[t._connectedWindow].position={left:v.x/w,top:v.y/w,radius:(v.x-f.x)/w};var y=x[t._connectedWindow].whiteboarditem.getHWV();null!=y&&y.view.setCamera(n,0),wbMain.redraw()}}))}onMouseMove(e){e.shiftDown()&&this._mouseButton===Communicator.Button.Left&&null!=this._connectedWindow&&null!=this._magDone&&(this.doPick(e),e.setHandled(!0))}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onKeyDown(e){}onKeyUp(e){}onDeactivate(){}onActivate(){}onViewOrientationChange(){}stopInteraction(){}}function p(){var e,t,i,n;function s(t,i,n){var r=e.model.getNodeChildren(t);0==r.length&&i.push(function(t,i){return new Promise((function(n,s){e.model.getMeshIds([t]).then((function(e){e.length>0&&(i[e[0][1]]=t),n()}))}))}(t,n));for(var o=0;o<r.length;o++)s(r[o],i,n)}return{initialize:function(e,n){t=e,i=n;var s='<div id="'+this.getDiv()+'" style="overflow:hidden"></div>\n';$("#"+f.getOffscreenContainer()).append(s)},activateHWV:function(i,s,r){if($("#"+i).append($("#"+this.getDiv())),null==e){var o=this.getDiv();if($("#"+o).empty(),0==f.getSCSLoading())a={containerId:o,endpointUri:"ws://localhost:11180?renderingLocation=csr",model:t,rendererType:0,streamingMode:1,memoryLimit:0,boundingPreviewMode:Communicator.BoundingPreviewMode.None};else var a={containerId:o,endpointUri:"models\\"+t+".scs"};Sample._applyExtraProperties(a),e=new Communicator.WebViewer(a);var h=this;e.setCallbacks({sceneReady:function(){var t=new m(h.getHWV());t.setItem(s),h.sethcMagnifierOperatorHandle(t),e.operatorManager.push(n)},modelStructureReady:r}),e.start()}else e.operatorManager.getOperator(n).setItem(s),e.resizeCanvas(),r()},sethcMagnifierOperatorHandle:function(e){n=this.getHWV().registerCustomOperator(e)},findUniqueMeshes:function(){return new Promise((function(t,i){var n=[],r=[];s(e.model.getRootNode(),n,r),Promise.all(n).then((function(){t(r)}))}))},deactivateHWV:function(){$("#"+f.getOffscreenContainer()).append($("#"+this.getDiv()))},getHWV:function(){return e},getDiv:function(){return null==i?"hc-"+t:"hc-"+t+i}}}let f=new function(){var e,i=[],n=!0;return{initialize:function(t){e=t},getModel:function(e,n){return null!=i[e+n]?i[e+n]:null==i[e]?(i[e]=new p,i[e].initialize(e),i[e]):function(e,i){for(var n=U.getItems(),s=0;s<n.length;s++)if(n[s].getType()==t.wbItemHC&&1==n[s].getActive()&&n[s].getGUID()!=i&&n[s].getModelName()==e)return!0;return!1}(e,n)?(i[e+n]=new p,i[e+n].initialize(e,n),i[e+n]):i[e]},getOffscreenContainer:function(){return e},setSCSLoading(e){n=e},getSCSLoading:()=>n}};class v extends r{static keepAlive=!1;static activeHCItem;static minFramerate=10;static setDrawMode(e){U.findwbItemHCUnderMouse().getHWV().view.setDrawMode(e)}static setViewOrientation(e){U.findwbItemHCUnderMouse().getHWV().view.setViewOrientation(e)}static setAmbientOcclusion(e){U.findwbItemHCUnderMouse().getHWV().view.setAmbientOcclusionEnabled(e)}static setBloom(e){U.findwbItemHCUnderMouse().getHWV().view.setBloomEnabled(e)}static setProjectionMode(e){U.findwbItemHCUnderMouse().getHWV().view.setProjectionMode(e)}static setKeepAlive(e){v.keepAlive=e}static create(e,t){U.clearSelection(),null!=v.activeHCItem&&0==v.keepAlive?v.activeHCItem.deactivate().then((function(){v._create(e,t)})):v._create(e,t)}static async _replace(e,t){await t.shutdown(),t.setModelName(e),await t.activate()}static async replace(e,t){null!=v.activeHCItem&&0==v.keepAlive?(await v.activeHCItem.deactivate(),await v._replace(e,t)):await v._replace(e,t)}static _create(e,t){var i=U.findwbItemHCUnderMouse();if(null!=i&&null!=e&&null==t)return i.shutdown().then((function(){i.setModelName(e),i.activate()})),i;var n,s=new v;if(s.initialize(e),s.setupDiv(v.container),U.addItem(s),null!=t)n={left:t.left,top:t.top,width:t.width,height:t.height};else{var r={left:U.lastX,top:U.lastY,width:500,height:500};n=U.convertWindowToCanvasCoordinates(r)}return s.setDimensions(n),s.activate(),v.activeHCItem=s,U.redraw(),s}constructor(){super(),this._modelName="",this._hcmodel,this._type=t.wbItemHC,this._currentState=new g,this._savedoperator=1,this._inputDisabled=!1}initialize(e){super.initialize(),this.setModelName(e)}serialize(){var e=super.serialize();return e._modelName=this._modelName,e.hasImage=!0,e.currentState=this._currentState.serialize(),e}setModelName(e){this._modelName=e,this._tags[e]=!0}getModelName(){return this._modelName}getHCModel(){return this._hcmodel}setHCModel(e){this._hcmodel=e}getModelState(){return this._currentState}render(e,t){this.renderPre(e,t);var i=this.getImage(),n=this.getDimensions(),r=this.getBackgroundColor();null!=r&&this.backgroundOpacity>0&&(e.fillStyle=r,e.fillRect(n.left,n.top,n.width,n.height)),this.borderWidth>0&&this.getShape()==s.rectangle&&e.strokeRect(n.left+(this.borderWidth-1)/2,n.top+(this.borderWidth-1)/2,n.width-(this.borderWidth-1),n.height-(this.borderWidth-1)),e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=0,null!=i&&e.drawImage(i,n.left,n.top,n.width,n.height);var o,a=this.getConnectedWindows();o=null==v.activeHCItem?e:t;for(var h=0;h<a.length;h++){var d=a[h].position;if(null!=d){o.lineWidth=1.5/e.getTransform().a,o.strokeStyle="rgb(200,200,0)",o.beginPath(),o.arc(n.left+d.left,n.top+d.top,d.radius,0,2*Math.PI),o.stroke();var l=a[h].whiteboarditem.getDimensions(),c=new Communicator.Point2(n.left+d.left,n.top+d.top),u=new Communicator.Point2(l.left+l.width/2,l.top+l.height/2),g=d.radius,m=l.width/2,p=Communicator.Point2.distance(u,c),f=Communicator.Point2.subtract(u,c);f.x/=p,f.y/=p;var w=f.copy().scale(g),x=f.copy().scale(m);o.beginPath(),o.moveTo(c.x-w.y,c.y+w.x),o.lineTo(u.x-x.y,u.y+x.x),o.stroke(),o.beginPath(),o.moveTo(c.x+w.y,c.y-w.x),o.lineTo(u.x+x.y,u.y-x.x),o.stroke()}}this.renderPost(e,t)}getHWV(){if(null!=this.getHCModel())return this.getHCModel().getHWV()}refreshPositioning(){super.refreshPositioning(),1==this.getActive()&&null!=this.getHWV()&&this.getHWV().resizeCanvas()}_setupDialog(){this.updateCircular();var e=this.getBackgroundColor();null==e&&(e="transparent");var t=U.convertCanvasToWindowCoordinates(this.getDimensions());if(null!=this.getImage()){this.getImage().width=t.width,this.getImage().height=t.height,$("#"+this.getDiv()).append(this.getImage());var i=this;setTimeout((function(){$("#"+i.getDiv()).find("img").remove()}),500)}$("#"+this.getDiv()).css({"background-color":e,display:"block",width:t.width,height:t.height,top:t.top,left:t.left,position:"absolute"})}_generateImage(){var e=this;return new Promise((function(t,i){var n=e.getDiv(),s=$("#"+n).find("canvas")[0],r=s.width,o=s.height,a=$("#"+n).width(),h=$("#"+n).height();s.width<200&&(r=s.width/(s.width/500),o=s.height/(s.width/500)),e.getHCModel().getHWV().setMinimumFramerate(0);var d=new Communicator.SnapshotConfig(r,o);if(e.getHCModel().getHWV().view.getAxisTriad().disable(),e.getHCModel().getHWV().view.getAxisTriad().disable(),e.getHCModel().getHWV().view.getNavCube().disable(),"[]"==e.getModelState().measureData){var l=$("#"+e.getDiv()).css("top");$("#"+e.getDiv()).css({width:r,height:o,top:-1e3}),e.getHCModel().getHWV().resizeCanvas(),e.getHCModel().getHWV().redraw((function(){var i=new Image;i.src=s.toDataURL({type:"image/jpeg"}),$("#"+e.getDiv()).css({width:a+"px",height:h+"px",top:l}),e.getHCModel().getHWV().resizeCanvas(),t(i)}))}else e.getHCModel().getHWV().takeSnapshot(d).then((function(e){t(e)}))}))}activate(){var e=this;return new Promise((function(t,i){1!=e.getActive()&&null!=e.getModelName()?(v.activeHCItem=e,e._setupDialog(),e.setActive(!0),e.setImage(void 0),U.redraw(),e.setHCModel(f.getModel(e.getModelName(),e.getGUID())),e.getHCModel().activateHWV(e.getDiv(),e,(function(){e.getModelState().activate(e.getHWV()).then((function(){t()}))}))):t()}))}async duplicate(){await this.deactivate();var e=new v;return super._duplicate(e),e._currentState=this._currentState.duplicate(),e._modelName=(" "+this._modelName).slice(1),e}shutdown(){var e=this;return new Promise((function(t,i){e.deactivate().then((function(){e._currentState=new g,e._connectedWindows=[],e.setImage(),t()}))}))}deactivate(){var e=this;return new Promise((function(t,i){0!=e.getActive()?(e.setActive(!1),e.getModelState().saveStatesFromHWV(e.getHWV()),e.setDirty(),e._generateImage().then((function(i){e.setImage(i),e.imageDirty=!0,e.getHCModel().deactivateHWV(),e.getGUID();var n=e.getDiv();$("#"+n).empty(),$("#"+e.getDiv()).css({display:"none"}),U.redraw(),t()}))):t()}))}setupFromState(e,t,i){var n=this;return new Promise((function(s,r){var o=e.getHWV().view.getCamera().copy();e.getModelState().saveStatesFromHWV(e.getHWV()),e.getHWV().measureManager.removeAllMeasurements(),i.apply(e.getHWV()).then((function(){var r=e.getHWV().view.getCamera().copy();e._generateImage().then((function(a){e.getHWV().reset(0).then((function(){$("#"+n.getDiv()).css({display:"none"}),null!=e.getModelState().measureData&&e.getHWV().measureManager.loadData(JSON.parse(e.getModelState().measureData)),e.getHWV().view.setCamera(o,0),e.getHWV().explodeManager.setMagnitude(0),n.setImage(a),n.imageDirty=!0,n.setDirty(),n.setDimensions(t),n.getModelState().saveCamera(r),i.drawMode=e.getHWV().view.getDrawMode(),i.ambientOcclusion=e.getHWV().view.getAmbientOcclusionEnabled(),i.bloom=e.getHWV().view.getBloomEnabled(),i.projectionMode=e.getHWV().view.getProjectionMode(),n.getModelState().copy(i),U.redraw(),n.setActive(!1),s()}))}))}))}))}_newViewerFromCurrent(e,t,i){var n=this;return new Promise((function(s,r){var o=new v;o.initialize(e),o.setupDiv(v.container),U.addItem(o),o.setupFromState(n,t,i).then((function(){s(o)}))}))}async isolateToNewWindow(){await this.activate();var e=this.getHWV();e.setMinimumFramerate(0),e.selectionManager.getLast().getNodeId();for(var t=[],i=e.selectionManager.getResults(),n=0;n<i.length;n++)t.push(i[n].getNodeId());e.selectionManager.clear();var s=this.getDimensions(),r=s.width/2*1.2*t.length;for(n=0;n<t.length;n++){var o={left:s.left+s.width/2-r/2+s.width/2*1.2*n,top:s.top+1.2*s.height,width:s.width/2,height:s.height/2},a=new g;a.isolateNode=t[n],await this._newViewerFromCurrent(this.getModelName(),o,a)}e.setMinimumFramerate(10)}async uniqueMeshesToNewWindow(){await this.activate();var e=this.getHWV();e.setMinimumFramerate(0);var t=this.getHCModel(),i=await t.findUniqueMeshes(),n=[];for(var s in i)n.push(i[s]);var r=this.getDimensions(),o=r.width/2*1.2*n.length;if(n.length>1e3)alert("Too many unique parts");else for(s=0;s<n.length;s++){var a={left:r.left+r.width/2-o/2+r.width/2*1.2*s,top:r.top+1.2*r.height,width:r.width/2,height:r.height/2},h=new g;h.isolateNode=n[s],await this._newViewerFromCurrent(this.getModelName(),a,h)}e.setMinimumFramerate(10)}async duplicateToNewWindow(){await this.activate();var e=this.getHWV();e.setMinimumFramerate(0);var t=this.getDimensions(),i={left:t.left+t.width+t.width/3,top:t.top,width:t.width,height:t.height},n=new g;n.camera=this.getHWV().getView().getCamera().copy(),this._newViewerFromCurrent(this.getModelName(),i,n),e.setMinimumFramerate(10)}async isolateAllToNewWindow(){await this.activate();var e=this.getHWV();e.setMinimumFramerate(0),e.selectionManager.getLast().getNodeId();for(var t=[],i=e.selectionManager.getResults(),n=0;n<i.length;n++)t.push(i[n].getNodeId());e.selectionManager.clear();var s=this.getDimensions(),r={left:s.left+s.width+s.width/3,top:s.top,width:s.width,height:s.height},o=new g;o.isolateNode=t,this._newViewerFromCurrent(this.getModelName(),r,o),e.setMinimumFramerate(10)}disableInput(){var e=this.getHWV();null!=e&&0==this._inputDisabled&&($("#"+r.container).css("pointer-events","none"),this._inputDisabled=!0,0!=e.operatorManager._operatorStack[0]&&(this._savedoperator=e.operatorManager._operatorStack[0]),e.operatorManager.set(Communicator.OperatorId.None,0),e.operatorManager.set(Communicator.OperatorId.Turntable,1))}enableInput(){var e=this.getHWV();null!=e&&1==this._inputDisabled&&($("#"+r.container).css("pointer-events","auto"),e.operatorManager.set(this._savedoperator,0),e.operatorManager.set(Communicator.OperatorId.Select,1),this._inputDisabled=!1)}setSelected(e){super.setSelected(e),0==e?this.disableInput():this.enableInput()}async magnifierToNewWindow(){await this.activate(),U.clearSelection();var e=this.getHWV();e.setMinimumFramerate(0);var t=this.getDimensions(),i={left:t.left+t.width+t.width/3,top:t.top,width:t.width,height:t.width},n=new g;n.camera=this.getHWV().getView().getCamera().copy();var r=await this._newViewerFromCurrent(this.getModelName(),i,n);e.setMinimumFramerate(10),this.connectWindow(r),r.activate(),r.setShape(s.circle)}mTreeToNewWindow(){var e=this.getDimensions(),t={left:e.left+e.width+e.width/3,top:e.top,width:e.width,height:e.width},i=new wbItemModelTree;i.initialize(),i.setDimensions(t),U.addItem(i),i.connectWindow(this),U.redraw()}async explodeToNewWindow(){await this.activate();var e=this.getHWV();e.setMinimumFramerate(0);var t=this.getDimensions(),i={left:t.left+t.width+t.width/3,top:t.top,width:t.width,height:t.height},n=new g;n.camera=this.getHWV().getView().getCamera().copy(),n.explode=1.5,this._newViewerFromCurrent(this.getModelName(),i,n),e.setMinimumFramerate(10)}async standardViewsToNewWindow(){await this.activate();var e=this.getHWV();e.setMinimumFramerate(0);var t=this.getDimensions(),i=t.width+t.width/50,n={left:i+t.left+t.width+t.width/50,top:t.top,width:t.width,height:t.height};await e.view.setViewOrientation(Communicator.ViewOrientation.Front,0);var s=new g;s.camera=this.getHWV().getView().getCamera().copy(),await this._newViewerFromCurrent(this.getModelName(),n,s),n={left:i+t.left+t.width+t.width/50,top:t.top+t.height+t.width/50,width:t.width,height:t.height},await e.view.setViewOrientation(Communicator.ViewOrientation.Right,0),(s=new g).camera=this.getHWV().getView().getCamera().copy(),await this._newViewerFromCurrent(this.getModelName(),n,s),n={left:i+t.left,top:t.top+t.height+t.width/50,width:t.width,height:t.height},await e.view.setViewOrientation(Communicator.ViewOrientation.Top,0),(s=new g).camera=this.getHWV().getView().getCamera().copy(),await this._newViewerFromCurrent(this.getModelName(),n,s),n={left:i+t.left,top:t.top,width:t.width,height:t.height},await e.view.setViewOrientation(Communicator.ViewOrientation.TopRight,0),(s=new g).camera=this.getHWV().getView().getCamera().copy(),await this._newViewerFromCurrent(this.getModelName(),n,s),e.setMinimumFramerate(10)}async CADViewstoNewWindow(){await this.activate();var e=this.getHWV();e.setMinimumFramerate(0);var t=[],i=e.model.getCadViewMap();for(let[e,n]of i)t.push(e);for(var n=this.getDimensions(),s=n.width/2*1.2*t.length,r=0;r<t.length;r++){var o={left:n.left+n.width/2-s/2+n.width/2*1.2*r,top:n.top+1.2*n.height,width:n.width/2,height:n.height/2},a=new g;a.cadView=t[r],await this._newViewerFromCurrent(this.getModelName(),o,a)}e.setMinimumFramerate(10)}_buildDagreGraphRecursive(e,t,i,n,s,r,o,a,h){if(!(o>r)){var d=e.model.getNodeChildren(n);if(0!=d.length||1!=i[n].length||1!=i[s].length||i[n][0][1]!=i[s][0][1]){s=e.model.getNodeParent(n),t.setNode(n.toString(),{width:a,height:h}),e.model.getNodeName(n),n!=e.model.getRootNode()&&t.setEdge(e.model.getNodeParent(n).toString(),n.toString());for(var l=0;l<d.length;l++)this._buildDagreGraphRecursive(e,t,i,d[l],n,r,o+1,a,h)}}}_gatherMeshId(e,t,i){return new Promise((function(n,s){t.model.getMeshIds([e]).then((function(t){i[e]=t,n()}))}))}gatherMatchingNodesRecursive(e,t,i,n){if(-1!=i.model.getNodeName(t).toLowerCase().indexOf(e.toLowerCase())){var s=t,r=[];for(r.push(i.model.getNodeName(t));;){var o=i.model.getNodeParent(s);if(null==o||o==i.model.getRootNode())break;r.push(i.model.getNodeName(o)),s=o}for(var a="",h=r.length-1;h>=0;h--)a+=h>0?r[h]+"->":r[h];var d={name:i.model.getNodeName(t),chain:a,id:t,selected:i.selectionManager.isSelected(Communicator.Selection.SelectionItem.create(t))};n.push(d)}for(var l=i.model.getNodeChildren(t),c=0;c<l.length;c++)this.gatherMatchingNodesRecursive(e,l[c],i,n)}gatherMatchingNodes(e){var t=[];return this.gatherMatchingNodesRecursive(e,this.getHWV().model.getRootNode(),this.getHWV(),t),t}_gatherMeshidsRecursive(e,t,i,n,s,r){n.push(this._gatherMeshId(t,e,i));for(var o=e.model.getNodeChildren(t),a=0;a<o.length;a++)this._gatherMeshidsRecursive(e,o[a],i,n,s,r+1)}_gatherMeshids(e,t,i){var n=this;return new Promise((function(s,r){var o=[];n._gatherMeshidsRecursive(e,e.model.getRootNode(),t,o,i,0),Promise.all(o).then((function(){s()}))}))}_gatherMeshidsRecursive2(e,t,i,n,s,r){if(!(r>s)){var o=e.model.getNodeChildren(i);0==o.length&&t.setEdge(i.toString(),"@"+n[i][0][1]);for(var a=0;a<o.length;a++)this._gatherMeshidsRecursive2(e,t,o[a],n,s,r+1)}}async modelTreeToNewWindow(){await this.activate();var e=this.getHWV(),t=[],i=e.model.getRootNode();null!=e.selectionManager.getLast()&&(i=e.selectionManager.getLast().getNodeId()),e.selectionManager.clear(),await this._gatherMeshids(e,t,5);var n=new dagre.graphlib.Graph;n.setDefaultEdgeLabel((function(){return{}}));var s=this.getDimensions();n.setGraph({marginx:0,ranksep:s.height/4}),this._buildDagreGraphRecursive(e,n,t,i,i,5,0,s.width/2,s.height/2);var r,a,h=[];for(var l in t)1==t[l].length&&(h[t[l][0][1]]=l);for(var c of(dagre.layout(n),e.setMinimumFramerate(0),n.nodes()))null!=(m=n.node(c))&&parseInt(c)==i&&(r=m.x,a=m.y);var u=[];for(var c of n.nodes()){var m;if(null!=(m=n.node(c))){var p={left:m.x+s.left-r+s.width/4,top:m.y+s.top-a+s.height/2,width:s.width/2,height:s.height/2},f=new g;c.includes("@")&&(c=h[c=c.split("@")[1]]),f.isolateNode=parseInt(c);var v=await this._newViewerFromCurrent(this.getModelName(),p,f);u[parseInt(c)]={dims:p,wbitem:v}}}for(var l in u)for(var w=e.model.getNodeChildren(parseInt(l)),x=0;x<w.length;x++){var y=w[x].toString();if(null!=u[y]){var b=new d(new Communicator.Point2(u[l].dims.left+s.width/2/2,u[l].dims.top+s.height/2),new Communicator.Point2(u[y].dims.left+s.width/2/2,u[y].dims.top));b.initialize(),b.setDrawArrows(!1,!0),b.setSnapItem(0,u[l].wbitem,o.bottom),b.setSnapItem(1,u[y].wbitem,o.top),d.addLine(b)}}U.redraw()}async sheetsToNewWindow(){await this.activate();var e=this.getHWV();e.setMinimumFramerate(0);for(var t=e.sheetManager.getSheetIds(),i=this.getDimensions(),n=i.width/2*1.2*t.length,s=0;s<t.length;s++){var r={left:i.left+i.width/2-n/2+i.width/2*1.2*s,top:i.top+1.2*i.height,width:i.width/2,height:i.height/2},o=new g;o.sheet=t[s],await this._newViewerFromCurrent(this.getModelName(),r,o)}e.setMinimumFramerate(0)}async floorsToNewWindow(){await this.activate();var e=this.getHWV();e.setMinimumFramerate(0);var t=e.model.getNodeChildren(e.model.getRootNode());t=e.model.getNodeChildren(t[0]),t=e.model.getNodeChildren(t[0]),t=e.model.getNodeChildren(t[0]);for(var i=e.model.getNodeChildren(t[0]),n=this.getDimensions(),s=n.width/2*1.2*i.length,r=0;r<i.length;r++){var o={left:n.left+n.width/2-s/2+n.width/2*1.2*r,top:n.top+1.2*n.height,width:n.width/2,height:n.height/2},a=new g;a.isolateNode=i[r],await this._newViewerFromCurrent(this.getModelName(),o,a)}e.setMinimumFramerate(10)}}let w=new function(){var e,i=[];return{initialize:function(t){e=t},calculateAlignment:function(n){var s=U.calculateSelectionBounding(!1).bounding;i=[];for(var r,o,a=U.getItems(),h=20/e.getTransform().a,d=(s.x1+s.x2)/2,l=(s.y1+s.y2)/2,c=0;c<a.length;c++)if(0==a[c].getSelected()&&a[c].getType()!=t.wbLine){var u=a[c].getDimensions();if(u.left+u.width<s.x1||u.left>s.x2||u.top+u.height<s.y1||u.top>s.y2){var g=u.left+u.width/2,m=u.top+u.height/2;if(l>m-h&&l<m+h){var p=Math.abs(d-g);(null==r||p<r.dist)&&(r=g<d?{type:0,x1:s.x1,y1:m,x2:u.left+u.width,y2:m,dist:p}:{type:0,x1:s.x2,y1:m,x2:u.left,y2:m,dist:p})}d>g-h&&d<g+h&&(p=Math.abs(l-m),(null==o||p<o.dist)&&(o=m<l?{type:1,y1:s.y1,x1:g,y2:u.top+u.height,x2:g,dist:p}:{type:1,y1:s.y2,x1:g,y2:u.top,x2:g,dist:p}))}}null!=r&&i.push(r),null!=o&&i.push(o),this.adjustAlignment(s,n)},adjustAlignment:function(e,t){for(var n={x1:e.x1,x2:e.x2,y1:e.y1,y2:e.y2},s=0;s<i.length;s++){var r=i[s];0==r.type?n.y1=r.y1-(n.y2-n.y1)/2:1==r.type&&(n.x1=r.x1-(n.x2-n.x1)/2)}var o=e.y1-n.y1,a=e.x1-n.x1,h=U.getItems();for(s=0;s<h.length;s++)if(null!=h[s].getTempDimensions()&&0==t&&null==h[s].containedIn||h[s].getSelected()){var d=h[s].getDimensions();h[s].move(d.left-a,d.top-o,!1)}},drawAlignment:function(){e.lineWidth=1/e.getTransform().a,e.setLineDash([5/e.getTransform().a,15/e.getTransform().a]);for(var t=0;t<i.length;t++)e.beginPath(),e.moveTo(i[t].x1,i[t].y1),e.lineTo(i[t].x2,i[t].y2),e.stroke();e.setLineDash([])}}};const x={scaleItem:0,dragItem:1,dragLinePoint:2};function y(e){this.type=e,this.extra=void 0}class b{constructor(e,t){this._whiteboarditem=window,this._button,this.drawSelectionRectangle,this._itemUnderMouse,this._ctx=e,this._ctx_o=t,this._dragged,this.dragStart,this.dragLast,this._dragged,this._pickedHandle,this._lastmouseuptime,this.cachedSelectedItems=[],this.cachedLineItems=[],this._cameraDirty=!1}setCameraDirty(){this._cameraDirty=!0}getCameraDirty(){return this._cameraDirty}clearCameraDirty(){this._cameraDirty=!1}_disableEnableInput(e){for(var t=U.getItems(),i=0;i<t.length;i++)1==e?t[i].enableInput():t[i].disableInput()}_recursiveContainerDrag(e){for(var i=e.getContainedItems(),n=0;n<i.length;n++)i[n].storeTempDimensions(),i[n].getType()==t.wbItemContainer&&this._recursiveContainerDrag(i[n])}_startSelectionDrag(e){for(var i=U.getItems(),n=0;n<i.length;n++)i[n].clearTempDimensions();for(n=0;n<i.length;n++)(i[n].getSelected()||n==e)&&(i[n].storeTempDimensions(),i[n].getType()==t.wbItemContainer&&this._recursiveContainerDrag(i[n]))}_selectionDrag(){for(var e=this._ctx.transformedPoint(U.lastX,U.lastY),i=U.getItems(),n=!1,s=0;s<i.length;s++)if(i[s].getType()==t.wbItemContainer&&1==i[s].getAutoArange()&&i[s].pointInsideItem(e)&&!n&&(i[s].dragItemsAndArrange(e),n=!0),null!=i[s].getTempDimensions()&&!i[s].getLocked()){i[s].getDimensions();var r=i[s].getTempDimensions();i[s].move(r.left+(e.x-this.dragStart.x),r.top+(e.y-this.dragStart.y),!1)}n||(u.dragAndArrangedTemp=void 0)}_selectionScale(){var e=U.calculateSelectionBounding(!0);if(null!=e){var i,n,s=e.bounding,r=this._ctx.transformedPoint(U.lastX,U.lastY);0==this._pickedHandle.extra?(n=s.x2-s.x1-(r.x-this.dragStart.x),i=e.keepAspectRatio?(s.y2-s.y1)/(s.x2-s.x1)*n:s.y2-s.y1-(r.y-this.dragStart.y)):2==this._pickedHandle.extra?(n=s.x2-s.x1+(r.x-this.dragStart.x),i=e.keepAspectRatio?(s.y2-s.y1)/(s.x2-s.x1)*n:s.y2-s.y1+(r.y-this.dragStart.y)):1==this._pickedHandle.extra?(n=s.x2-s.x1+(r.x-this.dragStart.x),i=e.keepAspectRatio?(s.y2-s.y1)/(s.x2-s.x1)*n:s.y2-s.y1-(r.y-this.dragStart.y)):3==this._pickedHandle.extra&&(n=s.x2-s.x1-(r.x-this.dragStart.x),i=e.keepAspectRatio?(s.y2-s.y1)/(s.x2-s.x1)*n:s.y2-s.y1+(r.y-this.dragStart.y));for(var o=n/(s.x2-s.x1),a=i/(s.y2-s.y1),h=U.getItems(),d=0;d<h.length;d++)if(h[d].getSelected()&&!h[d].getLocked()){var l={left:0,top:0,width:0,height:0},c=h[d].getTempDimensions(),u=l.width;l.width=c.width*o;var g=l.width/u;if(l.height=c.height*a,0==this._pickedHandle.extra?(l.left=s.x2+(c.left-s.x2)*o,l.top=s.y2+(c.top-s.y2)*a):2==this._pickedHandle.extra?(l.left=s.x1+(c.left-s.x1)*o,l.top=s.y1+(c.top-s.y1)*a):1==this._pickedHandle.extra?(l.left=s.x1+(c.left-s.x1)*o,l.top=s.y2+(c.top-s.y2)*a):3==this._pickedHandle.extra&&(l.left=s.x2+(c.left-s.x2)*o,l.top=s.y1+(c.top-s.y1)*a),h[d].scale(l),h[d].getType()==t.wbItemHC)for(var m=h[d].getConnectedWindows(),p=0;p<m.length;p++)null!=m[p].position&&(m[p].position.left*=g,m[p].position.top*=g,m[p].position.radius*=g);h[d].refreshPositioning()}}}_pickHandle(e){var t=15/this._ctx.getTransform().a,i=U.calculateSelectionBounding(!1);if(null!=i){var n=!0,s=new y(x.scaleItem),r=i.bounding,o=(r.x2+r.x1)/2;if(e.x>=r.x1-t&&e.x<=r.x1+t&&e.y>=r.y1-t&&e.y<=r.y1+t?s.extra=0:e.x>=r.x2-t&&e.x<=r.x2+t&&e.y>=r.y2-t&&e.y<=r.y2+t?s.extra=2:e.x>=r.x2-t&&e.x<=r.x2+t&&e.y>=r.y1-t&&e.y<=r.y1+t?s.extra=1:e.x>=r.x1-t&&e.x<=r.x1+t&&e.y>=r.y2-t&&e.y<=r.y2+t?s.extra=3:e.x>=o-t&&e.x<=o+t&&e.y>=r.y1-t&&e.y<=r.y1+t?s.type=x.dragItem:n=!1,n)return s}return d.checkAndStartLinePointSelection(e)}onMouseDown(e,i,n){if(!menuOpen&&(U.hideAllMenus&&U.hideAllMenus(),blockRightClick=!1,this._button=n,this.drawSelectionRectangle=!1,this._itemUnderMouse=void 0,document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none",U.lastX=e,U.lastY=i,this.dragStart=this._ctx.transformedPoint(U.lastX,U.lastY),this.dragLast=this._ctx.transformedPoint(U.lastX,U.lastY),this._dragged=!1,this._pickedHandle=void 0,null==U.getRectangleLoadData())){if(this._itemUnderMouse=U.findwbItemUnderMouse(),null!=this._itemUnderMouse&&1==this._itemUnderMouse.getLocked()&&(this._itemUnderMouse=void 0),0==this._button)if(this._pickedHandle=d.checkAndStartNewLine(this.dragStart,this._itemUnderMouse),null==this._pickedHandle&&(this._pickedHandle=this._pickHandle(this.dragStart)),null==this._pickedHandle){if(null!=this._itemUnderMouse&&this._itemUnderMouse.getType()==t.wbItemModelTree&&this._itemUnderMouse.onMouseDown())return;null==this._itemUnderMouse?U.clearSelection():(1==this._itemUnderMouse.getSelected()&&U.ctrlPressed&&0==this._itemUnderMouse.getActive()?(this._itemUnderMouse.setSelected(!1),this._itemUnderMouse.deselectGroup()):0==this._itemUnderMouse.getSelected()&&(U.ctrlPressed||U.clearSelection(),this._itemUnderMouse.setSelected(!0),U.selectRelatedGroups(),U.hideSelectionMenu&&U.hideSelectionMenu()),this._startSelectionDrag())}else this._pickedHandle.type==x.dragItem?(this._disableEnableInput(!1),this._startSelectionDrag()):this._pickedHandle.type==x.dragLinePoint||(this._disableEnableInput(!1),this._startSelectionDrag());this.cachedSelectedItems=U.getSelectedItems(),this.cachedLineItems=U.getLineItems()}}onMouseMove(e,i,n){if(!menuOpen){U.lastX=e,U.lastY=i,this._dragged=!0;var s=this._ctx.transformedPoint(U.lastX,U.lastY);if(this.dragStart)if(2==this._button)blockRightClick=!0,null==this._itemUnderMouse&&(U.hideSelectionMenu&&U.hideSelectionMenu(),this._ctx.translate(s.x-this.dragStart.x,s.y-this.dragStart.y),this._ctx_o.translate(s.x-this.dragStart.x,s.y-this.dragStart.y),this.setCameraDirty(),U.redraw(),U.respositionNonCanvasItems());else{if(null!=this._itemUnderMouse&&this._itemUnderMouse.getType()==t.wbItemModelTree&&this._itemUnderMouse.onMouseMove())return;if(null!=this._itemUnderMouse&&this._itemUnderMouse.getActive()&&null==this._pickedHandle)return;if(U.hideSelectionMenu&&U.hideSelectionMenu(),!d.dragLinePointSelection(s,this._pickedHandle))if(null==this._itemUnderMouse&&null==this._pickedHandle||0!=this.drawSelectionRectangle)null==U.getRectangleLoadData()&&(this.drawSelectionRectangle=!0),U.redraw();else{if(null==this._pickedHandle||this._pickedHandle.type==x.dragItem?(this._selectionDrag(),null==u.dragAndArrangedTemp&&w.calculateAlignment(!1)):(this._selectionScale(),null==u.dragAndArrangedTemp&&w.calculateAlignment(!0)),null!=this._pickedHandle&&this._pickedHandle.type!=x.dragItem)for(var r=U.getItems(),o=0;o<r.length;o++)r[o].getType()==t.wbItemTextEditor&&(r[o].getActive()?r[o].deactivate():null!=r[o].getTempDimensions()&&r[o].refreshImage(this._ctx));U.respositionNonCanvasItems(),d.updateAllSnappedLinePoints(),U.redraw(),w.drawAlignment()}}this.dragLast=this._ctx.transformedPoint(U.lastX,U.lastY)}}onMouseUp(e,i,n){if(!menuOpen){this._disableEnableInput(!0);var s=new Date,r=this._ctx.transformedPoint(U.lastX,U.lastY);null!=this._itemUnderMouse&&this._itemUnderMouse.getType()==t.wbItemModelTree&&this._itemUnderMouse.onMouseUp(this._dragged),s-this._lastmouseuptime<200&&0==this._button&&!this._dragged?null==this._itemUnderMouse?(U.deactivateAll(!0),d.deletePointFromDoubleClick(r)):d.deletePointFromDoubleClick(r)||0==this._itemUnderMouse.getActive()&&(this._dragged=!1,this.dragStart=void 0,U.deactivateAll(!v.keepAlive).then((function(){U.activateItemUnderMouse()}))):0!=this._button||this._dragged||null!=this._itemUnderMouse||U.deactivateAll(!v.keepAlive),this._lastmouseuptime=s,1==this.drawSelectionRectangle&&(U.selectFromRectangle(this.dragStart),this.drawSelectionRectangle=!1,U.redraw()),null!=U.getRectangleLoadData()&&U.loadFromLoadData(),this.dragStart=void 0,u.clearDragAndArrange(),u.assignItemsToContainer(),U.showSelectionMenu&&U.showSelectionMenu(),this.cachedSelectedItems=U.getSelectedItems(),this.cachedLineItems=U.getLineItems(),d.finalizePointDrag(this._pickedHandle),d.updateAllSnappedLinePoints(),d.updateAllLineData(),d.lineSnapItem&&(d.lineSnapItem.isLineSnapItem=!1,d.lineSnapItem=void 0),U.redraw()}}onMouseWheel(e){U.hideSelectionMenu&&U.hideSelectionMenu(),setTimeout((function(){U.showSelectionMenu&&U.showSelectionMenu()}),100);var t=e.wheelDelta?e.wheelDelta/40:e.detail?-e.detail:0;return t&&U.zoom(t),U.respositionNonCanvasItems(),this.setCameraDirty(),e.preventDefault()&&!1}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onKeyDown(e){}onKeyUp(e){}onDeactivate(){}onActivate(){}onViewOrientationChange(){}stopInteraction(){}}class _ extends r{static resizePhase=0;static startSize=50;static carotaScale=1;static carotaSuppressSelection=!1;static carotaItemActive=void 0;static carotaActive=!0;static skipCarotaLoad=!1;static contentChanged(){if(_.skip)_.skip=!1;else if(_.skipCarotaLoad)_.skipCarotaLoad=!1;else if(null==_.carotaItemActive||1!=_.carotaItemActive.autoResizeText){if(null!=_.carotaItemActive&&1==_.carotaItemActive.autoResizeExtents){for(e=0,t=0,i=U.carotaEditor.frame.lines,n=0;n<i.length;n++)i[n].actualWidth>e&&(e=i[n].actualWidth),i[n].baseline+i[n].descent>t&&(t=i[n].baseline+i[n].descent);(s=_.carotaItemActive.getDimensions()).width=e+30,s.height=t+30,s.width<40&&(s.width=40),s.height<40&&(s.height=40),_.carotaItemActive.setDimensions(s),U.redraw()}}else if(0==_.resizePhase)_.resizePhase=1,U.carotaEditor.select(0,U.carotaEditor.frame.length-1),U.carotaEditor.selectedRange().setFormatting("size",_.startSize.toString());else{for(var e=0,t=0,i=U.carotaEditor.frame.lines,n=0;n<i.length;n++)i[n].actualWidth>e&&(e=i[n].actualWidth),i[n].baseline+i[n].descent>t&&(t=i[n].baseline+i[n].descent);var s;(e>(s=_.carotaItemActive.getDimensions()).width-5||t>s.height-10)&&_.startSize>=10?(_.startSize-=2,U.carotaEditor.select(0,U.carotaEditor.frame.length-1),U.carotaEditor.selectedRange().setFormatting("size",_.startSize.toString())):(_.resizePhase=0,_.startSize=50,U.carotaEditor.select(0,0,!0))}}constructor(){super(),this._type=t.wbItemTextEditor,this._editorText,this.autoResizeExtents=!1,this.autoResizeText=!1,this.setDiv("carotadiv"),this.textBoxDimensions={left:0,top:0,width:0,right:0}}setFromJSON(e){super.setFromJSON(e),null!=e._editorText&&(this._editorText=e._editorText)}serialize(){var e=super.serialize();return e._editorText=this._editorText,e.hasImage=!1,e}scale(e){super.scale(e),this.autoResizeExtents=!1}refreshPositioning(){if(null!=this._targetdiv){var e=this.getDimensions();this.textBoxDimensions={width:e.width-20,height:e.height-20,top:e.top+10,left:e.left+10};var t=U.convertCanvasToWindowCoordinates(this.textBoxDimensions);$("#"+this.getDiv()).css({width:t.width,height:t.height,top:t.top,left:t.left}),U.carotaEditor.redraw()}}render(e,t){this.renderPre(e,t);var i=this.getBackgroundColor(),n=this.getDimensions();null!=i&&this.backgroundOpacity>0&&e.fillRect(n.left,n.top,n.width,n.height),this.borderWidth>0&&this.getShape()==s.rectangle&&e.strokeRect(n.left+(this.borderWidth-1)/2,n.top+(this.borderWidth-1)/2,n.width-(this.borderWidth-1),n.height-(this.borderWidth-1)),e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=0;var r=this.getImage();null!=r&&e.drawImage(r,this.textBoxDimensions.left,this.textBoxDimensions.top,this.textBoxDimensions.width,this.textBoxDimensions.height),this.renderPost(e,t)}refreshImage(e){var t=this._active;if(this.activate(e),this._active=t,0==this._active){_.carotaSuppressSelection=!0,U.carotaEditor.redraw();var i=$("#"+this.getDiv()).find("canvas")[0].toDataURL(),n=new Image;n.src=i,this.setImage(n),_.carotaSuppressSelection=!1;var s=this;setTimeout((function(){$("#"+s.getDiv()).css({display:"none"}),U.redraw()}),10)}}async duplicate(){await this.deactivate();var e=new _;return super._duplicate(e),e.setDiv("carotadiv"),e._editorText=(" "+this._editorText).slice(1),e}setBackgroundColor(e){this._backgroundColor=e}activate(e){var t=this._active;if(super.activate(e),0==t)if(_.carotaActive=!0,this.setBackgroundColor(this.getBackgroundColor()),_.carotaItemActive=this,_.carotaScale=e.getTransform().a,this._image=void 0,_.skipCarotaLoad=!0,null!=this._editorText){var i=JSON.parse(this._editorText);U.carotaEditor.load(i),(n=U.carotaEditor.selectedRange()).setFormatting("align","center")}else{(i=[]).push({text:"",size:10,align:"center"}),U.carotaEditor.load(i),U.carotaEditor.select(0,U.carotaEditor.frame.length-1);var n,s=this.getDimensions();(n=U.carotaEditor.selectedRange()).setFormatting("size",(s.height/2).toString()),n.setFormatting("align","center")}}deactivate(){if(this._active){_.carotaActive=!1,this.setDirty(),_.carotaItemActive=void 0,this._editorText=JSON.stringify(U.carotaEditor.save()),_.carotaSuppressSelection=!0,U.carotaEditor.redraw();var e=$("#"+this.getDiv()).find("canvas")[0].toDataURL(),t=new Image;t.src=e,this.setImage(t),_.carotaSuppressSelection=!1,setTimeout((function(){U.redraw()}),10)}super.deactivate()}}var I,C,S,T,M,k,A;(I={carota:{src:{"carota.js":function(e,t,i){var n={node:i("./node"),editor:i("./editor"),document:i("./doc"),dom:i("./dom"),runs:i("./runs"),html:i("./html"),frame:i("./frame"),text:i("./text"),rect:i("./rect")};if(t.exports=n,"undefined"!=typeof window&&window.document){if(window.carota)throw new Error("Something else is called carota!");window.carota=n}},"characters.js":function(e,t,i){var n=i("./runs"),s=function(e,t){if(e._runs!==t._runs)throw new Error("Characters for different documents")},r={equals:function(e){return s(this,e),this._run===e._run&&this._offset===e._offset},cut:function(e){s(this,e);var t=this;return function(i){for(var s=t._run;s<=e._run;s++){var r=t._runs[s];if(r){var o=s===t._run?t._offset:0,a=s===e._run?e._offset:n.getTextLength(r.text);o<a&&n.getSubText((function(e){var t=Object.create(r);t.text=e,i(t)}),r.text,o,a-o)}}}}};function o(e,t,i){return Object.create(r,{_runs:{value:e},_run:{value:t},_offset:{value:i},char:{value:t>=e.length?null:n.getTextChar(e[t].text,i)}})}function a(e,t){for(;t<e.length;t++)if(0!=n.getTextLength(e[t].text))return o(e,t,0);return o(e,e.length,0)}t.exports=function(e){return function(t){for(var i=a(e,0);!t(i)&&null!==i.char;)i=i._offset+1<n.getTextLength(e[i._run].text)?o(e,i._run,i._offset+1):a(e,i._run+1)}}},"codes.js":function(e,t,i){var n=i("./text"),s=i("./frame"),r=i("./node"),o=i("./rect"),a=i("./util"),h=r.derive({parent:function(){return this._parent},draw:function(e){this.inline.draw(e,this.left,this.baseline,this.measured.width,this.measured.ascent,this.measured.descent,this.formatting)},position:function(e,t,i){this.left=e,this.baseline=t,i&&(this._bounds=i)},bounds:function(){return this._bounds||o(this.left,this.baseline-this.measured.ascent,this.measured.width,this.measured.ascent+this.measured.descent)},byCoordinate:function(e,t){return e<=this.bounds().center().x?this:this.next()}}),d={number:function(e,t){var i=t+1+".";return{measure:function(e){return n.measure(i,e)},draw:function(e,t,s,r,o,a,h){n.draw(e,i,h,t,s,r,o,a)}}}};d.listNext=d.listEnd=function(e){return a.derive(e,{eof:!0,measure:function(e){return{width:10,ascent:0,descent:0}},draw:function(e,t,i){}})},d.listStart=function(e,t,i){return a.derive(e,{block:function(t,n,a,d,l,c){var u,g,m,p=r.generic("list",l,t,n),f=function(e,o){u=r.generic("item",p);var l=i(e.marker||{$:"number"},p.children().length);m=function(e,t,i,n,s){if(!e.draw||!e.measure)throw new Error;return Object.create(h,{inline:{value:e},_parent:{value:t},ordinal:{value:i},length:{value:1},formatting:{value:s},measured:{value:e.measure(s)}})}(l,u,d,0,o),m.block=!0,g=s(t+50,n,a-50,d+1,u,(function(e){return"listEnd"===e.$}),m.measured.ascent)};return f(e,c),function(e){if(g?g((function(e){d=e.ordinal+e.length;var i=e.bounds(),s=e.first(),r=t+50-10-m.measured.width,a=o(t,n,50,i.h);"baseline"in s?m.position(r,s.baseline,a):m.position(r,n+m.measured.ascent,a),n=i.t+i.h,u.children().push(m),u.children().push(e),u.finalize(),p.children().push(u),u=g=m=null}),e):d++,!g){var i=e.code();if(i){if("listEnd"==i.$)return p.finalize(),p;"listNext"==i.$&&f(i,e.codeFormatting())}}}}})},t.exports=e=function(e,t,i){var n=d[e.$];return n&&n(e,t,i)},e.editFilter=function(e){var t=0;if(!e.words.some((function(i,n){var s=i.code();if(s)switch(s.$){case"listStart":t++;break;case"listNext":if(0===t)return e.spliceWordsWithRuns(n,1,[a.derive(i.codeFormatting(),{text:{$:"listStart",marker:s.marker}})]),!0;break;case"listEnd":0===t&&e.spliceWordsWithRuns(n,1,[]),t--}}))&&t>0){for(var i=[];t>0;)t--,i.push({text:{$:"listEnd"}});e.spliceWordsWithRuns(e.words.length-1,0,i)}}},"doc.js":function(e,t,i){var n=i("per"),s=i("./characters"),r=i("./split"),o=i("./word"),a=i("./node"),h=i("./runs"),d=i("./range"),l=i("./util"),c=i("./frame"),u=i("./codes"),g=i("./rect"),m=function(e,t,i,n){var s=e.selection.start,r=e.selection.end;return function(o){e._wordOrdinals=[];var a=Array.prototype.splice.apply(e.words,[t,i].concat(n));o(m(e,t,n.length,a)),e._nextSelection={start:s,end:r}}},p=function(e){var t=[];return e((function(e){t.push(e)})),function(e){e(p((function(e){for(;t.length;)t.pop()(e)})))}},f=function(e){if(e.isNewLine())return!0;var t=e.code();return!(!t||!t.block&&!t.eof)},v=a.derive({redraw:function(){this.quickrefresh(0,0,!1)},load:function(e,t){var i=this;this.undo=[],this.redo=[],this._wordOrdinals=[],this.words=n(s(e)).per(r(i.codes)).map((function(e){return o(e,i.codes)})).all(),this.layout(),this.contentChanged.fire(),this.select(0,0,t)},layout:function(){this.frame=null;try{this.frame=n(this.words).per(c(0,0,this._width,0,this)).first()}catch(e){console.error(e)}if(this.frame){if(this._nextSelection){var e=this._nextSelection;delete this._nextSelection,this.select(e.start,e.end)}}else console.error("A bug somewhere has produced an invalid state - rolling back"),this.performUndo()},range:function(e,t){return d(this,e,t)},documentRange:function(){return this.range(0,this.frame.length-1)},selectedRange:function(){return this.range(this.selection.start,this.selection.end)},save:function(){return this.documentRange().save()},paragraphRange:function(e,t){var i,n=this.wordContainingOrdinal(e);if(e=0,n&&!f(n.word))for(i=n.index;i>0;i--)if(f(this.words[i-1])){e=this.wordOrdinal(i);break}var s=this.wordContainingOrdinal(t);if(t=this.frame.length-1,s&&!f(s.word))for(i=s.index;i<this.words.length;i++)if(f(this.words[i])){t=this.wordOrdinal(i);break}return this.range(e,t)},insert:function(e,t){this.select(this.selection.end+this.selectedRange().setText(e),null,t)},modifyInsertFormatting:function(e,t){this.nextInsertFormatting[e]=t,this.notifySelectionChanged()},applyInsertFormatting:function(e){var t=this.nextInsertFormatting,i=Object.keys(t);i.length&&e.forEach((function(e){i.forEach((function(i){e[i]=t[i]}))}))},wordOrdinal:function(e){if(e<this.words.length){var t=this._wordOrdinals.length;if(t<e+1)for(var i=t>0?this._wordOrdinals[t-1]:0,n=t;n<=e;n++)this._wordOrdinals[n]=i,i+=this.words[n].length;return this._wordOrdinals[e]}},wordContainingOrdinal:function(e){var t,i=0;return this.words.some((function(n,s){if(e>=i&&e<i+n.length)return t={word:n,ordinal:i,index:s,offset:e-i},!0;i+=n.length})),t},runs:function(e,t){var i=this.wordContainingOrdinal(Math.max(0,t.start)),n=this.wordContainingOrdinal(Math.min(t.end,this.frame.length-1));if(i.index===n.index)i.word.runs(e,{start:i.offset,end:n.offset});else{i.word.runs(e,{start:i.offset});for(var s=i.index+1;s<n.index;s++)this.words[s].runs(e);n.word.runs(e,{end:n.offset})}},spliceWordsWithRuns:function(e,t,i){var a=this,h=n(s(i)).per(r(a.codes)).truthy().map((function(e){return o(e,a.codes)})).all(),d=!1;if("_filtersRunning"in a)a._filtersRunning++;else{for(var l=0;l<t;l++)this.words[e+l].code()&&(d=!0);d||(d=h.some((function(e){return!!e.code()})))}this.transaction((function(i){if(m(a,e,t,h)(i),d){a._filtersRunning=0;try{for(;;){var n=a._filtersRunning;if(!a.editFilters.some((function(e){return e(a),n!==a._filtersRunning})))break}}finally{delete a._filtersRunning}}}))},splice:function(e,t,i){if("string"==typeof i){var s=Math.max(0,e-1),r=n({start:s,end:s+1}).per(this.runs,this).first();i=[r?Object.create(r,{text:{value:i}}):{text:i}]}else Array.isArray(i)||(i=[{text:i}]);this.applyInsertFormatting(i);var o,a,d=this.wordContainingOrdinal(e),l=this.wordContainingOrdinal(t);if(e===d.ordinal)if(d.index>0&&!f(this.words[d.index-1])){d.index--;var c=this.words[d.index];o=n({}).per(c.runs,c).all()}else o=[];else o=n({end:d.offset}).per(d.word.runs,d.word).all();t===l.ordinal?t===this.frame.length-1||f(l.word)?(a=[],l.index--):a=n({}).per(l.word.runs,l.word).all():a=n({start:l.offset}).per(l.word.runs,l.word).all();var u=this.frame.length;return this.spliceWordsWithRuns(d.index,l.index-d.index+1,n(o).concat(i).concat(a).per(h.consolidate()).all()),this.frame?this.frame.length-u:0},registerEditFilter:function(e){this.editFilters.push(e)},width:function(e){if(0===arguments.length)return this._width;this._width=e,this.layout()},children:function(){return[this.frame]},toggleCaret:function(){var e=this.caretVisible;return this.selection.start===this.selection.end&&(this.selectionJustChanged?this.selectionJustChanged=!1:this.caretVisible=!this.caretVisible),this.caretVisible!==e},getCaretCoords:function(e){var t,i=this.byOrdinal(e);if(i){if(i.block&&e>0){var n=this.byOrdinal(e-1);if(n.newLine){var s=n.bounds(),r=n.parent().parent().bounds();t=g(r.l,r.b,1,s.h)}else t=n.bounds(),t=g(t.r,t.t,1,t.h)}else t=(t=i.bounds()).h?g(t.l,t.t,1,t.h):g(t.l,t.t,t.w,1);return t}},byCoordinate:function(e,t){for(var i=this.frame.byCoordinate(e,t).ordinal,n=this.getCaretCoords(i);n.b<=t&&i<this.frame.length-1;)i++,n=this.getCaretCoords(i);for(;n.t>=t&&i>0;)i--,n=this.getCaretCoords(i);return this.byOrdinal(i)},drawSelection:function(e,t){if(!_.carotaSuppressSelection)if(this.selection.end===this.selection.start){if(this.selectionJustChanged||t&&this.caretVisible){var i=this.getCaretCoords(this.selection.start);i&&(e.save(),e.fillStyle="black",i.fill(e),e.restore())}}else e.save(),e.fillStyle=t?"rgba(0, 100, 200, 0.3)":"rgba(160, 160, 160, 0.3)",this.selectedRange().parts((function(t){t.bounds(!0).fill(e)})),e.restore()},notifySelectionChanged:function(e){var t=null,i=this;this.selectionChanged.fire((function(){return t||(t=i.selectedRange().getFormatting()),t}),e)},quickrefresh:function(e,t,i){this.selectionJustChanged=!0,this.caretVisible=!0,this.nextInsertFormatting={},this.notifySelectionChanged(i)},select:function(e,t,i){this.frame&&(this.selection.start=Math.max(0,e),this.selection.end=Math.min("number"==typeof t?t:this.selection.start,this.frame.length-1),this.selectionJustChanged=!0,this.caretVisible=!0,this.nextInsertFormatting={},this.notifySelectionChanged(i))},performUndo:function(e){var t=e?this.redo:this.undo,i=e?this.undo:this.redo,n=t.pop();n&&(n((function(e){i.push(e)})),this.layout(),this.contentChanged.fire())},canUndo:function(e){return e?!!this.redo.length:!!this.undo.length},transaction:function(e){if(this._currentTransaction)e(this._currentTransaction);else{for(var t=this;this.undo.length>50;)t.undo.shift();this.redo.length=0;var i=!1;this.undo.push(p((function(n){t._currentTransaction=n;try{e(n)}finally{i=n.length>0,t._currentTransaction=null}}))),i&&(t.layout(),t.contentChanged.fire())}},type:"document"});t.exports=function(){var e=Object.create(v);return e._width=0,e.selection={start:0,end:0},e.caretVisible=!0,e.customCodes=function(e,t,i){},e.codes=function(t,i){return u(t,i,e.codes)||e.customCodes(t,i,e.codes)},e.selectionChanged=l.event(),e.contentChanged=l.event(),e.editFilters=[u.editFilter],e.load([]),e}},"dom.js":function(e,t,i){e.isAttached=function(e){for(var t=e;t.parentNode;)t=t.parentNode;return!!t.body},e.clear=function(e){for(;e.firstChild;)e.removeChild(e.firstChild)},e.setText=function(t,i){e.clear(t),t.appendChild(document.createTextNode(i))},e.handleEvent=function(e,t,i){e.addEventListener(t,(function(e){!1===i(e)&&e.preventDefault()}))},e.handleMouseEvent=function(t,i,n){e.handleEvent(t,i,(function(e){var i=t.getBoundingClientRect();return n(e,(e.clientX-i.left)/_.carotaScale,(e.clientY-i.top)/_.carotaScale)}))},e.effectiveStyle=function(e,t){return document.defaultView.getComputedStyle(e).getPropertyValue(t)}},"editor.js":function(e,t,i){i("per");var n=i("./doc"),s=i("./dom"),r=i("./rect");setInterval((function(){if(_.carotaActive){var e=document.querySelectorAll(".carotaEditorCanvas"),t=document.createEvent("Event");t.initEvent("carotaEditorSharedTimer",!0,!0);for(var i=0;i<e.length;i++)e[i].dispatchEvent(t)}}),200),e.create=function(e){"absolute"!==s.effectiveStyle(e,"position")&&(e.style.position="relative"),e.innerHTML='<div id="spacerid" class="carotaSpacer"><canvas width="100" height="100" class="carotaEditorCanvas" style="position: absolute;"></canvas></div><div class="carotaTextArea" style="overflow: hidden; position: absolute; height: 0;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; padding: 0px; width: 1000px; height: 1em; outline: none; font-size: 4px;"></textarea>';var t=e.querySelector("canvas"),i=e.querySelector(".carotaSpacer"),o=e.querySelector(".carotaTextArea"),a=e.querySelector("textarea"),h=n(),d=0,l=null,c=null,u=null,g=null,m="",p=null,f=null,v={66:"bold",73:"italic",85:"underline",83:"strikeout"},w=function(e,t){return t<0?e<=0:e>=h.frame.length-1},x=function(e,t){return e.b<=t.t||t.b<=e.t},y=function(e,t){var i,n=h.getCaretCoords(e);for(c=null!==l?l:n.l;!w(e,t)&&(e+=t,i=h.getCaretCoords(e),!x(i,n)););for(n=i;!w(e,t)&&!(t>0&&i.l>=c||t<0&&i.l<=c);)if(e+=t,i=h.getCaretCoords(e),x(i,n)){e-=t;break}return e},b=function(e,t){for(var i,n=h.getCaretCoords(e);!w(e,t);)if(e+=t,i=h.getCaretCoords(e),x(i,n)){e-=t;break}return e},I=function(e,t,i){var n=h.selection.start,s=h.selection.end,r=h.frame.length-1,o=!1;if(c=null,t){if(!d)switch(e){case 37:case 38:case 36:case 33:d=-1;break;case 39:case 40:case 35:case 34:d=1}}else d=0;var a=1===d?s:n,u=!1;switch(e){case 37:t||n==s?a>0&&(i?a=(m=h.wordContainingOrdinal(a)).ordinal===a?m.index>0?h.wordOrdinal(m.index-1):0:m.ordinal:a--):a=n,u=!0;break;case 39:var m;t||n==s?a<r&&(i?a=(m=h.wordContainingOrdinal(a)).ordinal+m.word.length:a++):a=s,u=!0;break;case 40:a=y(a,1),u=!0;break;case 38:a=y(a,-1),u=!0;break;case 36:a=b(a,-1),u=!0;break;case 35:a=b(a,1),u=!0;break;case 33:a=0,u=!0;break;case 34:a=r,u=!0;break;case 8:n===s&&n>0&&(h.range(n-1,n).clear(),g=n-1,h.select(g,g),o=!0);break;case 46:n===s&&n<r&&(h.range(n,n+1).clear(),o=!0);break;case 90:i&&(o=!0,h.performUndo());break;case 89:i&&(o=!0,h.performUndo(!0));break;case 65:i&&(o=!0,h.select(0,r));break;case 67:case 88:i&&(p=h.selectedRange().save(),f=h.selectedRange().plainText())}var w=v[e];if(i&&w){var x=h.selectedRange();x.setFormatting(w,!0!==x.getFormatting()[w]),T(),o=!0}if(u){switch(d){case 0:n=s=a;break;case-1:n=a;break;case 1:s=a}if(n===s)d=0;else if(n>s){d=-d;var _=s;s=n,n=_}g=a,h.select(n,s),o=!0}return l=c,o};s.handleEvent(a,"keydown",(function(e){if(I(e.keyCode,e.shiftKey,e.ctrlKey))return!1;console.log(e.which)}));var C="top";function S(){var t=h.frame.bounds().h*_.carotaScale;if(t<e.clientHeight)switch(C){case"middle":return(e.clientHeight-t)/2/_.carotaScale+15;case"bottom":return e.clientHeight-t}return 0}h.setVerticalAlignment=function(e){C=e,T()};var T=function(){var n=1*e.clientWidth;h.width()!==n&&h.width(n);var s=h.frame.bounds().h,o=Math.max(h.frame.actualWidth(),e.clientWidth),d=e.clientHeight;parseFloat($(i).css("zoom")),t.width=1*e.clientWidth,t.height=1*d,t.style.width=e.clientWidth+"px",t.style.height=d+"px",t.style.top=e.scrollTop+"px",i.style.width=e.clientWidth+"px",i.style.height=Math.max(s,e.clientHeight)+"px",s<e.clientHeight-50&&h.frame.actualWidth(),e.style.overflow="hidden";var l=t.getContext("2d");l.scale(_.carotaScale,_.carotaScale),console.log(e.scrollTop),l.clearRect(0,0,o,d),l.translate(0,S()-e.scrollTop),h.draw(l,r(0,e.scrollTop,o,d)),h.drawSelection(l,u||document.activeElement===a)};s.handleEvent(e,"scroll",T),s.handleEvent(a,"input",(function(){var e=a.value;m!=e&&(m="",a.value="",e===f&&(e=p),h.insert(e))}));var M=function(){g=null===g?h.selection.end:g;var t=h.byOrdinal(g);if(g=null,t){var i=t.bounds();o.style.left=i.l*_.carotaScale+"px",o.style.top=i.t*_.carotaScale+"px",a.focus(),Math.max(0,(i.t+i.h)*_.carotaScale-(e.scrollTop+e.clientHeight))&&(e.scrollTop+=(i.t+i.h)*_.carotaScale-(e.scrollTop+e.clientHeight)),Math.max(0,e.scrollTop-i.t*_.carotaScale)&&(e.scrollTop-=e.scrollTop-i.t*_.carotaScale);var n=Math.max(0,i.l-(e.scrollLeft+e.clientWidth));(n=0)&&(e.scrollLeft+=n);var s=Math.max(0,e.scrollLeft-i.l);(s=0)&&(e.scrollLeft-=s),n=0,s=0}m=h.selectedRange().plainText(),a.value=m,a.select(),setTimeout((function(){a.focus()}),10)};function k(e,t){s.handleMouseEvent(i,e,(function(e,i,n){t(h.byCoordinate(i,n-S()),e.button,e.detail)}))}h.selectionChanged((function(e,t){T(),u||!1!==t&&M()})),k("mousedown",(function(e,t,i){if(2!=t){if(u=e.ordinal,3!=i)h.select(e.ordinal,e.ordinal);else{var n=e.word.line.ordinal,s=n+e.word.line.length;h.select(n,s)}l=null}})),k("dblclick",(function(e){(e=e.parent())&&h.select(e.ordinal,e.ordinal+(e.word?e.word.text.length:e.length))})),k("mousemove",(function(e,t){2!=t&&null!==u&&e&&(g=e.ordinal,u>e.ordinal?h.select(e.ordinal,u):h.select(u,e.ordinal))})),k("mouseup",(function(e,t){2!=t&&(u=null,l=null,M(),a.focus())}));var A=(new Date).getTime(),D=!1,P=e.clientWidth,N=e.clientHeight,E=function(){var t=!1,i=document.activeElement===a;D!==i&&(D=i,t=!0);var n=(new Date).getTime();n>A&&(A=n+500,h.toggleCaret()&&(t=!0)),e.clientWidth===P&&e.clientHeight===N||(t=!0,P=e.clientWidth,N=e.clientHeight),t&&T()};return s.handleEvent(t,"carotaEditorSharedTimer",E),E(),h.sendKey=I,h}},"frame.js":function(e,t,i){var n=i("./node"),s=i("./wrap"),r=i("./rect"),o=n.derive({bounds:function(){if(!this._bounds){var e=0,t=0,i=0,n=0;if(this.lines.length){var s=this.lines[0].bounds();e=s.l,t=s.t,this.lines.forEach((function(e){var t=e.bounds();i=Math.max(i,t.l+t.w),n=Math.max(n,t.t+t.h)}))}this._bounds=r(e,t,i-e,this.height||n-t)}return this._bounds},actualWidth:function(){if(!this._actualWidth){var e=0;this.lines.forEach((function(t){"number"==typeof t.actualWidth&&(e=Math.max(e,t.actualWidth))})),this._actualWidth=e}return this._actualWidth},children:function(){return this.lines},parent:function(){return this._parent},draw:function(e,t){t&&t.t,t?(t.t,t.h):Number.MAX_VALUE,this.lines.some((function(i){i.bounds(),i.draw(e,t)}))},type:"frame"});t.exports=function(e,t,i,n,r,a,h,d){var l=[],c=Object.create(o,{lines:{value:l},_parent:{value:r},ordinal:{value:n}}),u=s(e,t,i,n,c,a,h,d),g=0,m=0;return function(e,t){if(u((function(e){"number"==typeof e?m=e:(g=e.ordinal+e.length-n,l.push(e))}),t))return Object.defineProperty(c,"length",{value:g}),Object.defineProperty(c,"height",{value:m}),e(c),!0}}},"html.js":function(e,t,i){var n=i("./runs"),s=i("per"),r=function(e,t){return function(i,n){i.nodeName===e&&(n[t]=!0)}},o=function(e,t,i,n){return function(s,r){var o=s[e]&&s[e][t];o&&(n&&(o=n(o)),r[i]=o)}},a=function(e,t,i){return o("attributes",e,t,i)},h=function(e,t,i){return o("style",e,t,i)},d=function(e,t,i){return function(n,s){n.style&&n.style[e]===t&&(s[i]=!0)}},l=[6,7,9,10,12,16,20,30],c={left:!0,center:!0,right:!0,justify:!0},u=function(e){return c[e]?e:"left"},g=function(e){var t=e.split(/\s*,\s*/g);if(0==t.length)return e;var i=(e=t[0]).match(/^"(.*)"$/);return i||(i=e.match(/^'(.*)'$/))?i[1].trim():e},m={H1:30,H2:20,H3:16,H4:14,H5:12},p=[r("B","bold"),r("STRONG","bold"),r("I","italic"),r("EM","italic"),r("U","underline"),r("S","strikeout"),r("STRIKE","strikeout"),r("DEL","strikeout"),d("fontWeight","bold","bold"),d("fontStyle","italic","italic"),d("textDecoration","underline","underline"),d("textDecoration","line-through","strikeout"),h("color","color"),h("fontFamily","font",g),h("fontSize","size",(function(e){var t=e.match(/^([\d\.]+)pt$/);return t?parseFloat(t[1]):10})),h("textAlign","align",u),function(e,t){"SUB"===e.nodeName&&(t.script="sub")},function(e,t){"SUPER"===e.nodeName&&(t.script="super")},function(e,t){"CODE"===e.nodeName&&(t.font="monospace")},function(e,t){var i=m[e.nodeName];i&&(t.size=i)},a("color","color"),a("face","font",g),a("align","align",u),a("size","size",(function(e){return l[e]||10}))],f={};["BR","P","H1","H2","H3","H4","H5"].forEach((function(e){f[e]=!0})),e.parse=function(e,t){var i=e;"string"==typeof i&&((i=document.createElement("div")).innerHTML=e);var r=[],o=!0,a=s(n.consolidate()).into(r),h=function(e,t){a.submit(Object.create(t,{text:{value:e}}))};return function e(i,n){if(3==i.nodeType)!function(e,t){var i=(e=e.replace(/\n+\s*/g," ")).length;e=e.replace(/^\s+/,""),o?o=!1:i!==e.length&&(e=" "+e),(i=e.length)!==(e=e.replace(/\s+$/,"")).length&&(o=!0,e+=" "),h(e,t)}(i.nodeValue,n);else{n=Object.create(n);var s=i.attributes.class;if(s&&s.value.split(" ").forEach((function(e){(e=t[e])&&Object.keys(e).forEach((function(t){n[t]=e[t]}))})),p.forEach((function(e){e(i,n)})),i.childNodes)for(var r=0;r<i.childNodes.length;r++)e(i.childNodes[r],n);f[i.nodeName]&&(h("\n",n),o=!0)}}(i,{}),r}},"line.js":function(e,t,i){var n=i("./positionedword"),s=i("./rect"),r=i("./node"),o=(i("./runs"),r.derive({bounds:function(e){if(e){var t=this.first().bounds(),i=this.last().bounds();return s(t.l,this.baseline-this.ascent,i.l+i.w-t.l,this.ascent+this.descent)}return s(this.left,this.baseline-this.ascent,this.width/_.carotaScale,this.ascent+this.descent)},parent:function(){return this.doc},children:function(){return this.positionedWords},type:"line"}));t.exports=function(e,t,i,s,r,a,h,d){var l=h[0].align(),c=Object.create(o,{doc:{value:e},left:{value:t},width:{value:i},baseline:{value:s},ascent:{value:r},descent:{value:a},ordinal:{value:d},align:{value:l}}),u=0;h.forEach((function(e){u+=e.width})),i/=_.carotaScale,u-=h[h.length-1].space.width;var g=0,m=0;if(u<i)switch(l){case"right":g=i-u;break;case"center":g=(i-u)/2;break;case"justify":h.length>1&&!h[h.length-1].isNewLine()&&(m=(i-u)/(h.length-1))}return Object.defineProperty(c,"positionedWords",{value:h.map((function(e){var t=g;g+=e.width+m;var i=d;return d+=e.text.length+e.space.length,n(e,c,t,i,e.width+m)}))}),Object.defineProperty(c,"actualWidth",{value:u}),Object.defineProperty(c,"length",{value:d-c.ordinal}),c}},"node.js":function(e,t,i){i("per"),i("./runs");var n=i("./rect"),s=i("./util");e.prototype={children:function(){return[]},parent:function(){return null},first:function(){return this.children()[0]},last:function(){return this.children()[this.children().length-1]},next:function(){for(var e=this;;){var t=e.parent();if(!t)return null;var i=t.children(),n=i[i.indexOf(e)+1];if(n){for(;;){var s=n.first();if(!s)break;n=s}return n}e=t}},previous:function(){var e=this.parent();if(!e)return null;var t=e.children(),i=t[t.indexOf(this)-1];if(i)return i;var n=e.previous();return n?n.last():null},byOrdinal:function(e){var t=null;return this.children().some((function(i){if(e>=i.ordinal&&e<i.ordinal+i.length&&(t=i.byOrdinal(e)))return!0}))?t:this},byCoordinate:function(e,t){var i;if(this.children().some((function(n){if(n.bounds().contains(e,t)&&(i=n.byCoordinate(e,t)))return!0})),!i){for(i=this.last();i;){var n=i.last();if(!n)break;i=n}var s=i.next();s&&s.block&&(i=s)}return i},draw:function(e,t){this.children().forEach((function(i){i.draw(e,t)}))},parentOfType:function(e){var t=this.parent();return t&&(t.type===e?t:t.parentOfType(e))},bounds:function(){var e=this._left,t=this._top,i=0,s=0;return this.children().forEach((function(n){var r=n.bounds();e=Math.min(e,r.l),t=Math.min(t,r.t),i=Math.max(i,r.l+r.w),s=Math.max(s,r.t+r.h)})),n(e,t,i-e,s-t)}},e.derive=function(t){return s.derive(e.prototype,t)};var r=e.derive({children:function(){return this._children},parent:function(){return this._parent},finalize:function(e,t){var i=Number.MAX_VALUE,n=0;this._children.forEach((function(e){i=Math.min(i,e.ordinal),n=Math.max(n,e.ordinal+e.length)})),Object.defineProperty(this,"ordinal",{value:i-(e||0)}),Object.defineProperty(this,"length",{value:(t||0)+n-i})}});e.generic=function(e,t,i,n){return Object.create(r,{type:{value:e},_children:{value:[]},_parent:{value:t},_left:{value:"number"==typeof i?i:Number.MAX_VALUE},_top:{value:"number"==typeof n?n:Number.MAX_VALUE}})}},"part.js":function(e,t,i){var n=i("./text"),s={measure:function(e){var t=t.measure("?",e);return{width:t.width+4,ascent:t.width+2,descent:t.width+2}},draw:function(e,t,i,n,s,r){e.fillStyle="silver",e.fillRect(t,i-s,n,s+r),e.strokeRect(t,i-s,n,s+r),e.fillStyle="black",e.fillText("?",t+2,i)}},r={draw:function(e,t,i){"string"==typeof this.run.text?n.draw(e,this.run.text,this.run,t,i,this.width,this.ascent,this.descent):this.code&&this.code.draw&&(e.save(),this.code.draw(e,t,i,this.width,this.ascent,this.descent,this.run),e.restore())}};t.exports=function(e,t){var i,o,a;"string"==typeof e.text?(o=1===e.text.length&&"\n"===e.text[0],i=n.measure(o?n.nbsp:e.text,e)):i=(a=t(e.text)||s).measure?a.measure(e):{width:0,ascent:0,descent:0};var h=Object.create(r,{run:{value:e},isNewLine:{value:o},width:{value:o?0:i.width},ascent:{value:i.ascent},descent:{value:i.descent}});return a&&Object.defineProperty(h,"code",{value:a}),h}},"positionedword.js":function(e,t,i){var n=i("./rect"),s=i("./part"),r=i("./text"),o=i("./node"),a=(i("./word"),i("./runs")),h=function(e){return r.measure(r.enter,e).width},d=o.derive({bounds:function(){var e=this.word.bounds(),t=this.word.word.isNewLine()?h(this.word.word.run):this.width||this.part.width;return n(e.l+this.left,e.t,t,e.h)},parent:function(){return this.word},byOrdinal:function(){return this},byCoordinate:function(e,t){return e<=this.bounds().center().x?this:this.next()},type:"character"}),l=o.derive({draw:function(e){this.word.draw(e,this.line.left+this.left,this.line.baseline)},bounds:function(){return n(this.line.left+this.left,this.line.baseline-this.line.ascent,this.word.isNewLine()?h(this.word.run):this.width,this.line.ascent+this.line.descent)},parts:function(e){this.word.text.parts.some(e)||this.word.space.parts.some(e)},realiseCharacters:function(){if(!this._characters){var e=[],t=0,i=this,n=this.ordinal,r=this.parentOfType("document").codes;this.parts((function(o){a.pieceCharacters((function(a){var h=Object.create(o.run);h.text=a;var l=s(h,r);e.push(Object.create(d,{left:{value:t},part:{value:l},word:{value:i},ordinal:{value:n},length:{value:1}})),t+=l.width,n++}),o.run.text)}));var o=e[e.length-1];o&&(Object.defineProperty(o,"width",{value:this.width-o.left}),(this.word.isNewLine()||this.word.code()&&this.word.code().eof)&&Object.defineProperty(o,"newLine",{value:!0})),this._characters=e}},children:function(){return this.realiseCharacters(),this._characters},parent:function(){return this.line},type:"word"});t.exports=function(e,t,i,n,s){return Object.create(l,{word:{value:e},line:{value:t},left:{value:i},width:{value:s},ordinal:{value:n},length:{value:e.text.length+e.space.length}})}},"range.js":function(e,t,i){var n=i("per"),s=i("./runs");function r(e,t,i){this.doc=e,this.start=t,this.end=i,t>i&&(this.start=i,this.end=t)}r.prototype.parts=function(e,t){t=t||this.doc.children();var i=this;t.some((function(t){return!(t.ordinal+t.length<=i.start)&&(t.ordinal>=i.end||void(t.ordinal>=i.start&&t.ordinal+t.length<=i.end?e(t):i.parts(e,t.children())))}))},r.prototype.clear=function(){return this.setText([])},r.prototype.setText=function(e){return this.doc.splice(this.start,this.end,e)},r.prototype.runs=function(e){this.doc.runs(e,this)},r.prototype.plainText=function(){return n(this.runs,this).map(s.getPlainText).all().join("")},r.prototype.save=function(){return n(this.runs,this).per(s.consolidate()).all()},r.prototype.getFormatting=function(){var e=this;if(e.start===e.end){var t=e.start;t>0&&t--,e.start=t,e.end=t+1}return n(e.runs,e).reduce(s.merge).last()||s.defaultFormatting},r.prototype.setFormatting=function(e,t){var i=this;if("align"===e&&(i=i.doc.paragraphRange(i.start,i.end)),i.start===i.end)i.doc.modifyInsertFormatting(e,t);else{var n=i.save(),r={};r[e]=t,s.format(n,r),i.setText(n)}},t.exports=function(e,t,i){return new r(e,t,i)}},"rect.js":function(e,t,i){var n={contains:function(e,t){return e>=this.l&&e<this.l+this.w&&t>=this.t&&t<this.t+this.h},stroke:function(e){e.strokeRect(this.l,this.t,this.w,this.h)},fill:function(e){e.fillRect(this.l,this.t,this.w,this.h)},offset:function(e,t){return s(this.l+e,this.t+t,this.w,this.h)},equals:function(e){return this.l===e.l&&this.t===e.t&&this.w===e.w&&this.h===e.h},center:function(){return{x:this.l+this.w/2,y:this.t+this.h/2}}},s=t.exports=function(e,t,i,s){return Object.create(n,{l:{value:e},t:{value:t},w:{value:i},h:{value:s},r:{value:e+i},b:{value:t+s}})}},"runs.js":function(e,t,i){e.formattingKeys=["bold","italic","underline","strikeout","color","font","size","align","script"],e.defaultFormatting={size:10,font:"sans-serif",color:"black",bold:!1,italic:!1,underline:!1,strikeout:!1,align:"left",script:"normal"},e.sameFormatting=function(t,i){return e.formattingKeys.every((function(e){return t[e]===i[e]}))},e.clone=function(t){var i={text:t.text};return e.formattingKeys.forEach((function(n){var s=t[n];s&&s!=e.defaultFormatting[n]&&(i[n]=s)})),i},e.multipleValues={},e.merge=function(t,i){if(1===arguments.length)return Array.isArray(t)?t.reduce(e.merge):t;if(arguments.length>2)return e.merge(Array.prototype.slice.call(arguments,0));var n={};return e.formattingKeys.forEach((function(s){(s in t||s in i)&&(t[s]===i[s]?n[s]=t[s]:n[s]=e.multipleValues)})),n},e.format=function(t,i){Array.isArray(t)?t.forEach((function(t){e.format(t,i)})):Object.keys(i).forEach((function(n){i[n]!==e.multipleValues&&(t[n]=i[n])}))},e.consolidate=function(){var t;return function(i,n){t&&e.sameFormatting(t,n)&&"string"==typeof t.text&&"string"==typeof n.text?t.text+=n.text:i(t=e.clone(n))}},e.getPlainText=function(t){if("string"==typeof t.text)return t.text;if(Array.isArray(t.text)){var i=[];return t.text.forEach((function(t){i.push(e.getPiecePlainText(t))})),i.join("")}return"_"},e.getPieceLength=function(e){return e.length||1},e.getPiecePlainText=function(e){return e.length?e:"_"},e.getTextLength=function(t){if("string"==typeof t)return t.length;if(Array.isArray(t)){var i=0;return t.forEach((function(t){i+=e.getPieceLength(t)})),i}return 1},e.getSubText=function(t,i,n,s){if(0!==s)if("string"!=typeof i)if(Array.isArray(i)){var r=0;i.some((function(i){if(s<=0)return!0;var o=e.getPieceLength(i);if(r+o>n)if(1===o)t(i),s-=1;else{var a=i.substr(Math.max(0,n-r),s);t(a),s-=a.length}r+=o}))}else t(i);else t(i.substr(n,s))},e.getTextChar=function(t,i){var n;return e.getSubText((function(e){n=e}),t,i,1),n},e.pieceCharacters=function(e,t){if("string"==typeof t)for(var i=0;i<t.length;i++)e(t[i]);else e(t)}},"split.js":function(e,t,i){t.exports=function(e){var t=null,i=null,n=!0;return function(s,r){var o;if(null===r.char)o=!0;else if(n&&(o=!0,n=!1),"string"==typeof r.char)switch(r.char){case" ":i||(i=r);break;case"\n":o=!0,n=!0;break;default:i&&(o=!0)}else{var a=e(r.char);(a.block||a.eof)&&(o=!0,n=!0)}if(o){if(t&&!t.equals(r)){if(!1===s({text:t,spaces:i||r,end:r}))return!1;i=null}null===r.char&&s(null),t=r}}}},"text.js":function(e,t,i){var n=i("./runs"),s=e.getFontString=function(e){var t=e&&e.size||n.defaultFormatting.size;if(e)switch(e.script){case"super":case"sub":t*=.8}return(e&&e.italic?"italic ":"")+(e&&e.bold?"bold ":"")+" "+t+"pt "+(e&&e.font||n.defaultFormatting.font)};e.applyRunStyle=function(e,t){e.fillStyle=t&&t.color||n.defaultFormatting.color,e.font=s(t)},e.prepareContext=function(e){e.textAlign="left",e.textBaseline="alphabetic"},e.getRunStyle=function(e){var t=["font: ",s(e),"; color: ",e&&e.color||n.defaultFormatting.color];if(e)switch(e.script){case"super":t.push("; vertical-align: super");break;case"sub":t.push("; vertical-align: sub")}return t.join("")};var r=e.nbsp=String.fromCharCode(160),o=(e.enter=r,e.measureText=function(e,t){var i,n,s;i=document.createElement("span"),n=document.createElement("div"),s=document.createElement("div"),n.style.display="inline-block",n.style.width="1px",n.style.height="0",s.style.visibility="hidden",s.style.position="absolute",s.style.top="0",s.style.left="0",s.style.width="500px",s.style.height="200px",s.appendChild(i),s.appendChild(n),document.body.appendChild(s);try{i.setAttribute("style",t),i.innerHTML="",i.appendChild(document.createTextNode(e.replace(/\s/g,r)));var o={};n.style.verticalAlign="baseline",o.ascent=n.offsetTop-i.offsetTop,n.style.verticalAlign="bottom",o.height=n.offsetTop-i.offsetTop,o.descent=o.height-o.ascent,o.width=i.offsetWidth}finally{s.parentNode.removeChild(s),s=null}return o}),a=e.createCachedMeasureText=function(){var e={};return function(t,i){var n=i+"<>!&%"+t,s=e[n];return s||(e[n]=s=o(t,i)),s}};e.cachedMeasureText=a(),e.measure=function(t,i){return e.cachedMeasureText(t,e.getRunStyle(i))},e.draw=function(t,i,n,s,r,o,a,h){switch(e.prepareContext(t),e.applyRunStyle(t,n),n.script){case"super":r-=a*(1/3);break;case"sub":r+=h/2}t.fillText("\n"===i?e.enter:i,s,r),n.underline&&t.fillRect(s,1+r,o,1),n.strikeout&&t.fillRect(s,1+r-a/2,o,1)}},"util.js":function(e,t,i){e.event=function(){var e=[],t=function(t){e.push(t)};return t.fire=function(){var t=Array.prototype.slice.call(arguments,0);e.forEach((function(e){e.apply(null,t)}))},t},e.derive=function(e,t){var i={};return Object.keys(t).forEach((function(e){i[e]={value:t[e]}})),Object.create(e,i)}},"word.js":function(e,t,i){var n=i("per"),s=i("./part"),r=i("./runs"),o={isNewLine:function(){return 1==this.text.parts.length&&this.text.parts[0].isNewLine},code:function(){return 1==this.text.parts.length&&this.text.parts[0].code},codeFormatting:function(){return 1==this.text.parts.length&&this.text.parts[0].run},draw:function(e,t,i){n(this.text.parts).concat(this.space.parts).forEach((function(n){n.draw(e,t,i),t+=n.width}))},plainText:function(){return this.text.plainText+this.space.plainText},align:function(){var e=this.text.parts[0];return e?e.run.align:"left"},runs:function(e,t){var i=t&&t.start||0,n=t&&t.end;"number"!=typeof n&&(n=Number.MAX_VALUE),[this.text,this.space].forEach((function(t){t.parts.some((function(t){if(i>=n||n<=0)return!0;var s=t.run,r=s.text;if("string"==typeof r){if(i<=0&&n>=r.length)e(s);else if(i<r.length){var o=Object.create(s),a=Math.max(0,i);o.text=r.substr(a,Math.min(r.length,n-a)),e(o)}i-=r.length,n-=r.length}else i<=0&&n>=1&&e(s),i--,n--}))}))}},a=function(e,t){var i={parts:n(e).map((function(e){return s(e,t)})).all(),ascent:0,descent:0,width:0,length:0,plainText:""};return i.parts.forEach((function(e){i.ascent=Math.max(i.ascent,e.ascent),i.descent=Math.max(i.descent,e.descent),i.width+=e.width,i.length+=r.getPieceLength(e.run.text),i.plainText+=r.getPiecePlainText(e.run.text)})),i};t.exports=function(e,t){var i,n;e?(i=e.text.cut(e.spaces),n=e.spaces.cut(e.end)):(i=[{text:"\n"}],n=[]),i=a(i,t),n=a(n,t);var s=Object.create(o,{text:{value:i},space:{value:n},ascent:{value:Math.max(i.ascent,n.ascent)},descent:{value:Math.max(i.descent,n.descent)},width:{value:i.width+n.width,configurable:!0},length:{value:i.length+n.length}});return e||Object.defineProperty(s,"eof",{value:!0}),s}},"wrap.js":function(e,t,i){var n=i("./line");t.exports=function(e,t,i,s,r,o,a,h){var d,l=[],c=0,u=a||0,g=h||0,m=0,p=t,f=function(e,t){l.push(e),c+=e.width,u=Math.max(u,e.ascent),g=Math.max(g,e.descent),e.isNewLine()&&(v(t),m=e.ascent+e.descent)},v=function(t){if(!d&&0!==l.length){var o=n(r,e,i,p+u,u,g,l,s);s+=o.length,d=t(o),p+=u+g,l.length=0,c=u=g=0}},w=null;return function(n,a){if(w){m=0;var h=w(a);h&&(w=null,s+=h.length,p+=h.bounds().h,Object.defineProperty(h,"block",{value:!0}),n(h))}else{var u=a.code();u&&u.block?(l.length?v(n):p+=m,w=u.block(e,p,i,s,r,a.codeFormatting()),m=0):u&&u.eof||a.eof?((!u||o&&o(u))&&f(a,n),l.length?(v(n),n(p-t)):n(p+m-t),d=!0):(m=0,l.length?(null!=_.carotaItemActive&&_.carotaItemActive.autoResizeExtents||c+a.text.width>i/_.carotaScale&&v(n),f(a,n)):f(a,n))}return d}}}}},per:{":mainpath:":"per.js","per.js":function(e,t,i){!function(i){function n(e,t){return"function"!=typeof e?Array.isArray(e)?function(t){return e.some(t)}:function(t){return t(e)}:t?function(i,n){e.call(t,i,n)}:e}function s(e,t){this.forEach=n(e,t)}function r(e,t){e(t)}function o(e,t){return 0===arguments.length?new s(r):e&&e instanceof s?e:new s(e,t)}function a(e){return"string"==typeof e?new Function("x","return "+e):e}function h(e,t){var i=e[t];return"function"==typeof i?i:function(i){e[t]=i}}function d(){}function l(e){return!!e}function c(e,t){return Math.min(e,t)}function u(e,t){return Math.max(e,t)}function g(e,t){return e+t}function m(e,t){return!(!e||!t)}function p(e,t){return!(!e&&!t)}function f(e){return!e}s.prototype.per=function(e,t){var i=this.forEach,s=n(e&&e.forEach||e,t);return o((function(e,t){return i((function(t){return s(e,t)}),t)}))},s.prototype.map=function(e){return e=a(e),this.per((function(t,i){return t(e(i))}))},s.prototype.filter=function(e){return e=a(e),this.per((function(t,i){if(e(i))return t(i)}))},s.prototype.concat=function(e,t){e=e instanceof s?e.forEach:n(e,t);var i=this.forEach;return o((function(t,n){i(t,n),e(t,n)}))},s.prototype.skip=function(e){return this.per((function(t,i){return e>0?(e--,!1):t(i)}))},s.prototype.take=function(e){return this.per((function(t,i){return e<=0||(e--,t(i))}))},s.prototype.listen=function(e){return this.per((function(t,i){return!!e(i)||t(i)}))},s.prototype.flatten=function(){return this.per((function(e,t){return Array.isArray(t)?t.some((function(t){return e(t)})):e(t)}))},s.prototype.reduce=function(e,t){var i=t,n=2==arguments.length;return this.per((function(t,s){t(i=n?e(i,s):s),n=!0}))},s.prototype.multicast=function(e){return 1!==arguments.length&&(e=Array.prototype.slice.call(arguments,0)),e=e.map((function(e){return"function"==typeof e?e:e instanceof s?e.forEach:d})),this.listen((function(t){var i=!0;return e.forEach((function(e){e(d,t)||(i=!1)})),i}))},s.prototype.into=function(e,t){if(!Array.isArray(e))throw new Error("into expects an array");return t=function(e){return"number"!=typeof e?Number.MAX_VALUE:e}(t),this.listen((function(i){if(t<=0)return!0;e.push(i),t--}))},s.prototype.monitor=function(e){var t=0,i=h(e,"count"),n=h(e,"first"),s=h(e,"last"),r=e.limit;return"number"!=typeof r&&(r=Number.MAX_VALUE),r<1?this:this.listen((function(e){if(0===t&&n(e),t++,i(t),s(e),t>=r)return!0}))},s.prototype.submit=function(e){return this.forEach(d,e)},s.prototype.all=function(){var e=[];return this.into(e).submit(),e},s.prototype.first=function(){var e={limit:1};return this.monitor(e).submit(),e.count>0?e.first:void 0},s.prototype.last=function(){var e={};return this.monitor(e).submit(),e.count>0?e.last:void 0},s.prototype.truthy=function(){return this.filter(l)},s.prototype.min=function(){return this.reduce(c,Number.MAX_VALUE)},s.prototype.max=function(){return this.reduce(u,Number.MIN_VALUE)},s.prototype.sum=function(){return this.reduce(g,0)},s.prototype.and=function(){return this.reduce(m,!0)},s.prototype.or=function(){return this.reduce(p,!1)},s.prototype.not=function(){return this.map(f)},o.pulse=function(e){var t=0;return o((function(i){!function n(){!0!==i(t++)&&setTimeout(n,e)}()}))},function(i){void 0===e?this.per=i:t.exports=i}(o)}()}}},A={".js":[],".json":[],".css":[],".html":[]},M=function(e){var t=new Error("Could not find module '"+e+"'");return t.code="MODULE_NOT_FOUND",t},k=function(e,t,i){var n,s;if("function"==typeof e[t+i])return t+i;for(n=0;s=A[i][n];++n)if("function"==typeof e[t+s])return t+s;return null},C=function(e,t,i,n,s,r){var o,a,h,d,l,c;for("."!==(o=(i=i.split("/")).pop())&&".."!==o||(i.push(o),o="");null!=(a=i.shift());)if(a&&"."!==a&&(".."===a?(e=t.pop(),r=r.slice(0,r.lastIndexOf("/"))):(t.push(e),e=e[a],r+="/"+a),!e))throw M(n);if(o&&"function"!=typeof e[o]&&((c=k(e,o,".js"))||(c=k(e,o,".json")),c||(c=k(e,o,".css")),c||(c=k(e,o,".html")),c?o=c:2!==s&&"object"==typeof e[o]&&(t.push(e),e=e[o],r+="/"+o,o="")),!o)return 1!==s&&e[":mainpath:"]?C(e,t,e[":mainpath:"],n,1,r):C(e,t,"index",n,2,r);if(!(l=e[o]))throw M(n);return l.hasOwnProperty("module")?l.module.exports:(h={},l.module=d={exports:h,id:r+"/"+o},l.call(h,h,d,S(e,t,r)),d.exports)},T=function(e,t,n,s){var r,o=n,a=n.charAt(0),h=0;if("/"===a){if(o=o.slice(1),!(e=I["/"]))return i(287)(n);s="/",t=[]}else if("."!==a){if(r=o.split("/",1)[0],!(e=I[r]))return i(287)(n);s=r,t=[],(o=o.slice(r.length+1))||((o=e[":mainpath:"])?h=1:(o="index",h=2))}return C(e,t,o,n,h,s)},(S=function(e,t,i){return function(n){return T(e,[].concat(t),n,i)}})(I,[],""))("carota/src/carota");let D=new function(){var e=[];return{menudiv:"",imageLocation:"",initialize:function(e,t){D.menudiv="#"+e,D.imageLocation=t},addMenu:function(t){e.push(t)},getByName(t){for(var i=0;i<e.length;i++)if(e[i].getName()==t)return e[i]},hideAll(){for(var t=0;t<e.length;t++)null!=e[t].parent&&e[t].hide(!0)}}};class P{static mouseEnter(e){$(e).css({"background-color":"rgba(200,200,255,.5)","background-blend-mode":"multiply"})}static mouseLeave(e){$(e).css({"background-color":"","background-blend-mode":""})}static mouseClick(e){var t=e.id.split("_"),i=D.getByName(t[0]);if(null!=i){var n=i.getItemByName(t[1]);if(1==n.isToggle&&(n._toggled=!n._toggled,n._toggled?$(e).css({"border-color":"black"}):$(e).css({"border-color":"white"}),null!=n.submenu))if(n._toggled){i._hideSubmenus(),n._toggled=!0,i._updateToggled();var s=$(e).offset(),r=$(D.menudiv).offset(),o={left:s.left-r.left,top:s.top-r.top};n.submenu.setParent(i,n),i.getOrientation()==N.vertical?(n.submenu.setPosition(o.left+50,o.top),n.submenu.display(!0)):(n.submenu.setPosition(o.left,o.top+50),n.submenu.display(!0))}else n.submenu.hide();null==n.submenu&&(null!=n.action?n.action(n,i.getParentItem(),i.getParentMenu()):null!=i.getAction()?i.getAction()(n,i.getParentItem(),i.getParentMenu()):null!=i.getParentItem()&&null!=i.getParentItem().action?i.getParentItem().action(n,i.getParentItem(),i.getParentMenu()):null!=i.getParentMenu()&&null!=i.getParentMenu().getAction()&&i.getParentMenu().getAction()(n,i.getParentItem(),i.getParentMenu())),n.isToggle||null==i.parent||i.hide(!0)}}constructor(e,t,i,n,s,r,o){this.name=e,this.imagename=t,this.action=i,this.extraData=n,this.isToggle=null!=s&&s,this.submenu=r,this._toggled=!1,this._title=o,this.hidden=!1}isToggled(){return this._toggled}setToggled(e){this._toggled=e}getTitle(){return null!=this._title?this._title:this.name}setImage(e,t){this.imagename=e,$("#"+t.getName()+"_"+this.name).css("background-image","url("+D.imageLocation+e+")")}createDiv(e,t){return this.hidden||(this.imagename.indexOf("rgb")>-1?(e+='<div title="'+this.getTitle()+'" id="'+t.getName()+"_"+this.name+"\" onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuItem.mouseClick(this)' style=\"width:"+t._imageSizeX+"px; height:"+t._imageSizeY+"px;background-size:"+t._imageSizeX+"px "+t._imageSizeY+'px;border-style:solid;border-color:white;border-width:1px">',e+='<div style="border-radius:50%;top:5px;left:5px;position:relative;background:'+this.imagename+";width:"+(t._imageSizeX-10)+"px; height:"+(t._imageSizeY-10)+"px;background-size:"+(t._imageSizeX-10)+"px "+(t._imageSizeY-10)+'px;"></div></div>'):e+='<div title="'+this.getTitle()+'" id="'+t.getName()+"_"+this.name+"\" onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='console.log(\"click\"); menuItem.mouseClick(this)' style=\"background: url("+D.imageLocation+this.imagename+") no-repeat top left;width:"+t._imageSizeX+"px; height:"+t._imageSizeY+"px;background-size:"+t._imageSizeX+"px "+t._imageSizeY+'px;border-style:solid;border-color:white;border-width:1px"></div>'),e}}window.menuItem=P;const N={vertical:0,horizontal:1,box:2};class E{static menuidCounter=0;static fadeIn(e){setTimeout((function(){var t=parseFloat($(e).css("opacity"));t+=.05,$(e).css({opacity:t}),t<1&&E.fadeIn(e)}),10)}constructor(e){this._name=e,this._orientation=N.vertical,this._items=[],this._pos=new Communicator.Point2(0,0),this.active=!1,this._box_x=0,this._box_y=0,this._imageSizeX=32,this._imageSizeY=32,this.parent=void 0,this.action=void 0}getItemByName(e){for(var t=0;t<this._items.length;t++)if(this._items[t].name==e)return this._items[t]}addItem(e,t,i,n,s,r,o){var a=new P(e,t,i,n,s,r,o);return this._items.push(a),a}setPosition(e,t){this._pos.x=e,this._pos.y=t}getParentItem(){return null!=this.parent?this.parent.parentitem:void 0}getParentMenu(){return null!=this.parent?this.parent.parentmenu:void 0}setAction(e){this.action=e}getAction(){return this.action}setBoxDimensions(e,t){this._box_x=e,this._box_y=t}setOrientation(e){this._orientation=e}getName(){return this._name}getOrientation(){return this._orientation}setImageSize(e,t){this._imageSizeX=e,this._imageSizeY=t}display(e){if(!this._active){this._active=!0;var t="";if(this._orientation==N.horizontal||this._orientation==N.vertical){var i="";this._orientation==N.horizontal&&(i="display:inline-flex;"),t+='<div id="wbmenu_'+this._name+'" style="'+i+"opacity:0;background-color:white;box-shadow: grey 0px 0px 10px;border-radius: 5px;border: 5px solid white;position:absolute; left:"+this._pos.x+"px; top:"+this._pos.y+'px ;z-index:1000000001">';for(var n=0;n<this._items.length;n++)t=this._items[n].createDiv(t,this);if(t+="</div>",$(D.menudiv).prepend(t),null==e)if(this._orientation==N.vertical){var s=$("#wbmenu_"+this._name).height();$("#wbmenu_"+this._name).css({top:this._pos.y-s/2})}else{var r=$("#wbmenu_"+this._name).width();$("#wbmenu_"+this._name).css({left:this._pos.x-r/2})}}else{i="display:inline-flex;",t+='<div id="wbmenu_'+this._name+'" style="'+i+"opacity:0;background-color:white; box-shadow: grey 0px 0px 10px;border-radius: 5px;border: 5px solid white;position:absolute; left:"+this._pos.x+"px; top:"+this._pos.y+'px ;z-index:1000000001">',n=0;for(var o=0;o<this._box_y;o++){t+="<div>";for(var a=0;a<this._box_x&&!(n>=this._items.length);a++)t=this._items[n].createDiv(t,this),n++;if(t+="</div>",n>=this._items.length)break}t+="</div>",$(D.menudiv).prepend(t)}this._updateToggled(),E.fadeIn("#wbmenu_"+this._name)}}_updateToggled(){for(var e=0;e<this._items.length;e++)this._items[e]._toggled?$("#"+this._name+"_"+this._items[e].name).css({"border-color":"black"}):$("#"+this._name+"_"+this._items[e].name).css({"border-color":"white"})}_hideSubmenus(){for(var e=0;e<this._items.length;e++)null!=this._items[e].submenu&&(this._items[e].submenu.hide(),this._items[e].submenu._hideSubmenus(),this._items[e]._toggled=!1)}hide(e){if(this._active&&(this._active=!1,$("#wbmenu_"+this._name).remove()),this._hideSubmenus(),null!=e&&null!=this.parent)for(var t=this.parent.parentmenu,i=this;null!=t;){t._updateToggled();for(var n=0;n<t._items.length;n++)null!=t._items[n].submenu&&t._items[n].submenu._name==i._name&&(t._items[n]._toggled=!1,t._updateToggled(),null!=t.parent&&t.hide());if(null==t.parent)break;i=t,t=t.parent.parentmenu}}setParent(e,t){this.parent={parentmenu:e,parentitem:t}}}class L extends E{static mouseClick(e){var t=e.id.split("-"),i=D.getByName(t[0]);i.action(t[0],t[1]),i.hide(!0)}constructor(e){super(e),this.action=O.setEditorTextStyles}display(){if(!this._active){this._active=!0;var e="";e+='<div id="wbmenu_'+this.getName()+'" style="opacity:0;background-color:white;box-shadow: grey 0px 0px 10px;border-radius: 5px;border: 5px solid white;position:absolute; left:'+this._pos.x+"px; top:"+this._pos.y+'px ;z-index:1000000001">',e+='<div id="'+this.getName()+"-5\" onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuTextSize.mouseClick(this)' style=\"border-color:white;border-width:1px\">5px</div>",e+='<div id="'+this.getName()+"-10\" onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuTextSize.mouseClick(this)' style=\"border-color:white;border-width:1px\">10px</div>",e+='<div id="'+this.getName()+"-20\" onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuTextSize.mouseClick(this)' style=\"border-color:white;border-width:1px\">20px</div>",e+='<div id="'+this.getName()+"-30\" onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuTextSize.mouseClick(this)' style=\"border-color:white;border-width:1px\">30px</div>",e+='<div id="'+this.getName()+"-40\" onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuTextSize.mouseClick(this)' style=\"border-color:white;border-width:1px\">40px</div>",e+='<div id="'+this.getName()+"-50\" onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuTextSize.mouseClick(this)' style=\"border-color:white;border-width:1px\">50px</div>",e+='<div id="'+this.getName()+"-100\" onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuTextSize.mouseClick(this)' style=\"border-color:white;border-width:1px\">100px</div>",e+="</div>",$(D.menudiv).prepend(e),$("#wbmenu_"+this.getName()).height(),$("#wbmenu_"+this.getName()).css({top:this._pos.y}),E.fadeIn("#wbmenu_"+this._name)}}}class O extends E{static mouseClick(e){var t=e.id.split("-"),i=D.getByName(t[0]);i.action(t[0],t[1]),i.hide(!0)}static setEditorTextStyles(e,t){U.carotaEditor.selectedRange().setFormatting(e,t)}constructor(e){super(e),this.action=O.setEditorTextStyles}display(){if(!this._active){this._active=!0;var e="";e+='<div id="wbmenu_'+this.getName()+'" style="opacity:0;background-color:white;box-shadow: grey 0px 0px 10px;border-radius: 5px;border: 5px solid white;position:absolute; left:'+this._pos.x+"px; top:"+this._pos.y+'px ;z-index:1000000001">',e+='<div id="'+this.getName()+"-Arial\" onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuTextFont.mouseClick(this)' style=\"border-color:white;border-width:1px;font-family: Arial\">Arial</div>",e+='<div id="'+this.getName()+"-Verdana\" onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuTextFont.mouseClick(this)' style=\"border-color:white;border-width:1px;font-family: Verdana\">Verdana</div>",e+='<div id="'+this.getName()+"-Fantasy\" onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuTextFont.mouseClick(this)' style=\"border-color:white;border-width:1px;font-family: Fantasy\">Fantasy</div>",e+='<div id="'+this.getName()+"-Monospace\" onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuTextFont.mouseClick(this)' style=\"border-color:white;border-width:1px;font-family: Monospace\">Monospace</div>",e+="</div>",$(D.menudiv).prepend(e),$("#wbmenu_"+this.getName()).height(),$("#wbmenu_"+this.getName()).css({top:this._pos.y}),E.fadeIn("#wbmenu_"+this._name)}}}window.menuTextFont=O,window.menuTextSize=L;class W extends E{static mouseClick(e){var t=e.id.split("_"),i=menuManager.getByName(t[0]);i.action(t[0],t[1]),i.hide(!0)}static deleteTag(){var e=menuManager.getByName("tags"),t=$("#tagtext")[0].value;wbTags.deleteTag(t),e.hideSimple(),e.mode=0,e.display()}static newTag(){for(var e=menuManager.getByName("tags"),t=$("#tagtext")[0].value,i=wbMain.getSelectedItems(),n=0;n<i.length;n++)i[n].getTags().addTag(t,e.currentTagColor),i[n].setDirty();$("#tagtext")[0].value="",e.generateTagDiv()}static cancelEdit(){var e=menuManager.getByName("tags");e.hideSimple(),e.mode=0,e.display()}static activateTag(e){if(1!=(t=menuManager.getByName("tags")).mode){for(var t=menuManager.getByName("tags"),i=wbMain.getSelectedItems(),n=0,s=0;s<i.length;s++)i[s].getTags().hasTag(e)&&n++;if(n==i.length)for(s=0;s<i.length;s++)i[s].getTags().removeTag(e),i[s].setDirty();else for(s=0;s<i.length;s++)i[s].getTags().addTag(e),i[s].setDirty();t.generateTagDiv()}}static editTag(){var e=menuManager.getByName("tags"),t=e.getEditTag(),i=$("#tagtext")[0].value;wbTags.renameTag(t,i,e.currentTagColor),e.hideSimple(),e.mode=0,e.display()}static editTagMode(e){var t=menuManager.getByName("tags"),i=wbTags.allTags.getTagsHash();t.currentTagColor=i[e],t.setEditTag(e),t.hideSimple(),t.mode=1,t.display(),$("#tagtext")[0].value=e,t.setEditTag((" "+e).slice(1))}static showColorMenu(e){var t=menuManager.getByName("tags"),i=menuManager.getByName("tagcolors");i.setParent(t,void 0);var n=$(e).offset();i.setPosition(n.left,n.top),i.display()}static keyDown(){$("#tagtext")[0].value,menuManager.getByName("tags").generateTagDiv()}static action(e,t){var i=menuManager.getByName("tags");i.currentTagColor=e.imagename,$("#tagcolor").css({background:i.currentTagColor})}constructor(e){super(e),this.mode=0,this.editTagName=void 0,this.action=W.action,this.currentTagColor="rgb(255,0,0)"}generateTagDiv(){var e=void 0,t=$("#tagtext")[0].value;""!=t&&(e=t),$("#alltags").empty();var i=[],n=wbTags.allTags.getTagsHash();for(var s in n)i[s]=!1;var r=wbMain.getSelectedItems();for(s=0;s<r.length;s++){var o=r[s].getTags().getTagsHash();for(var a in o)i[a]=!0}var h="";for(var s in i){var d="";0==i[s]&&(d="opacity:0.15;"),(null==e||s.substring(0,e.length)==e)&&(h+="<div onclick='menuTags.activateTag(\""+s+'")\' style="'+d+"margin-bottom:2px; color:white;background:"+n[s]+';margin-left:3px;padding:2px;display:inline-flex">'+s+"<div onclick='menuTags.editTagMode(\""+s+'")\' style="background: url(menuimages/editicon.png) no-repeat top left;width:10px;height:15px;background-size:10px 15px"></div></div>')}$("#alltags").append(h),wbMain.redraw()}display(){if(!this._active){wbMain.redraw(),this._active=!0;var e="";e+='<div id="wbmenu_'+this.getName()+'" style="opacity:0;background-color:white;box-shadow: grey 0px 0px 10px;border-radius: 5px;border: 5px solid white;position:absolute; left:'+this._pos.x+"px; top:"+this._pos.y+'px ;z-index:1000000000;width:270px">',e+='<div id="tagcolor" onclick="menuTags.showColorMenu(this)" style="border-radius:50%;top:5px;left:5px;position:relative;background:'+this.currentTagColor+';width:20px; height:20px;background-size:20px 20px;"></div>',e+='<input onkeyup="menuTags.keyDown()" id="tagtext" type="text" placeholder="Enter Tag" style="position:relative;left:30px;top:-15px;width:150px"></Input>',0==this.mode?(e+='<button type="button" style="background-color:white;border-style:none;position:relative; top:-15px;left:40px" onclick="menuTags.newTag(this)">Create</button>',e+='<div id="alltags">',e+="</div>"):(e+='<button type="button" style="background-color:white;border-style:none;position:relative; top:-15px;left:40px" onclick="menuTags.editTag(this)">Done</button>',e+='<div style="position:relative;left:150px">',e+='<button type="button" style="background-color:white;border-style:none; position:relative;" onclick="menuTags.deleteTag(this)">Delete</button>',e+='<button type="button" style="background-color:white;border-style:none;position:relative;" onclick="menuTags.cancelEdit(this)">Cancel</button>',e+="</div>"),e+="</div>",$(menuManager.menudiv).prepend(e),0==this.mode&&($("#tagtext").keydown((function(e){13==e.keyCode&&W.newTag(this)})),$("#tagtext").focus(),this.generateTagDiv()),$("#wbmenu_"+this.getName()).height(),$("#wbmenu_"+this.getName()).css({top:this._pos.y}),E.fadeIn("#wbmenu_"+this._name)}}hideSimple(){this._active&&(this._active=!1,$("#wbmenu_"+this._name).remove())}hide(){super.hide(!0),this.mode=0}setEditTag(e){this.editTagName=e}getEditTag(){return this.editTagName}}class H extends E{static mouseClick(e){var t=e.id.split("_");if("backgroundcolor"==t[0]){for(var i=U.getSelectedItems(),n=0;n<i.length;n++)"0"==t[1]?i[n].setBackgroundColor():i[n].setBackgroundColor(H.colorChoices[parseInt(t[1])]),i[n].setDirty();U.redraw()}else{for(i=U.getSelectedItems(),n=0;n<i.length;n++)i[n].borderColor=H.colorChoices[parseInt(t[1])];U.redraw()}D.getByName("menuAppearance").refresh()}static setBorderShape(e){U.setShape(e),D.getByName("menuAppearance").refresh()}static setBorderPattern(e){for(var t=U.getSelectedItems(),i=0;i<t.length;i++)t[i].borderPattern=e,t[i].setDirty();var n=D.getByName("menuAppearance");U.redraw(),n.refresh()}static colorChoices=["rgb(255,255,255)","rgb(255,255,255)","rgb(230,230,230)","rgb(210,210,210)","rgb(150,150,150)","rgb(64,64,64)","rgb(0,0,0)","rgb(255,128,128)","rgb(255,0,0)","rgb(170,0,0)","rgb(130,0,0)","rgb(64,0,0)","rgb(128,255,128)","rgb(0,255,0)","rgb(0,210,0)","rgb(0,170,0)","rgb(0,130,0)","rgb(0,64,0)","rgb(128,128,255)","rgb(0,0,255)","rgb(0,0,210)","rgb(0,0,170)","rgb(0,0,130)","rgb(0,0,64)","rgb(255,241,170)","rgb(255,255,0)","rgb(210,210,0)","rgb(170,170,0)","rgb(130,130,0)","rgb(64,64,0)","rgb(32,32,0)"];static backgroundOpacityChanged(){D.getByName("menuAppearance");for(var e=$("#backgroundopacityslider")[0].value,t=U.getSelectedItems(),i=0;i<t.length;i++)t[i].backgroundOpacity=parseInt(e)/100;U.redraw()}static shadowChanged(){D.getByName("menuAppearance");for(var e=$("#shadowslider")[0].value,t=U.getSelectedItems(),i=0;i<t.length;i++)t[i].shadowWidth=parseInt(e);U.redraw()}static borderThicknessChanged(){D.getByName("menuAppearance");for(var e=$("#borderthicknesslider")[0].value,t=U.getSelectedItems(),i=0;i<t.length;i++)t[i].borderWidth=parseInt(e)/200*20;U.redraw()}constructor(e){super(e)}refresh(){var e=U.getSelectedItems()[0],i="";if(e.getType()!=t.wbLine){i+='<div style="position:absolute;top:0px;">',i+='<div style="background: url(js/wbManager/menuimages/transparent2.png) no-repeat top left;width:20px; height:20px;background-size:20px 20px;border-style:solid;border-color:white;border-width:1px"></div>',i+='<input id="backgroundopacityslider" oninput="menuAppearance.backgroundOpacityChanged()" style="position:absolute; top:0px; left:22px;"type="range" min="0" max="100" step="10" value="'+100*e.backgroundOpacity+'" class="myslider">',i+='<div style="background: url(js/wbManager/menuimages/nontransparent2.png) no-repeat top left;position:absolute;width:20px; height:20px;left:127px;top:0px;background-size:20px 20px;border-style:solid;border-color:white;border-width:1px"></div>',i+='<div style="position:absolute;top:20px;background: url(js/wbManager/menuimages/noshadow.png) no-repeat top left;width:20px; height:20px;background-size:20px 20px;border-style:solid;border-color:white;border-width:1px"></div>',i+='<input id="shadowslider" oninput="menuAppearance.shadowChanged()" style="position:absolute; top:20px; left:22px;"type="range" min="0" max="20" step="1" value="'+e.shadowWidth+'" class="myslider">',i+='<div style="background: url(js/wbManager/menuimages/heavyshadow.png) no-repeat top left;position:absolute;width:20px; height:20px;left:127px;top:20px;background-size:20px 20px;border-style:solid;border-color:white;border-width:1px"></div>',i+="<div onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuAppearance.setBorderShape(wbItemShape.rectangle)' style=\"background: url(js/wbManager/menuimages/rectangleshape.png) no-repeat top left;position:absolute;width:20px; height:20px;left:200px;top:0px;background-size:20px 20px;border-style:solid;border-color:"+(e.getShape()==s.rectangle?"black":"white")+';border-width:1px"></div>',i+="<div onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuAppearance.setBorderShape(wbItemShape.circle)' style=\"background: url(js/wbManager/menuimages/circleshape.png) no-repeat top left;position:absolute;width:20px; height:20px;left:222px;top:0px;background-size:20px 20px;border-style:solid;border-color:"+(e.getShape()==s.circle?"black":"white")+';border-width:1px"></div>',i+="<div onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuAppearance.setBorderShape(wbItemShape.roundedCornerRectangle)' style=\"background: url(js/wbManager/menuimages/roundedrectangleshape.png) no-repeat top left;position:absolute;width:20px; height:20px;left:245px;top:0px;background-size:20px 20px;border-style:solid;border-color:"+(e.getShape()==s.roundedCornerRectangle?"black":"white")+';border-width:1px"></div>';for(var n=0,r=24,o=0;o<5;o++){for(var a=0;a<10;a++){var h="white";if((null==(d=e.getBackgroundColor())&&0==o&&0==a||d==H.colorChoices[n]&&n>0)&&(h="black"),0==o&&0==a?i+="<div id=\"backgroundcolor_0\" onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuAppearance.mouseClick(this)' style=\"position:absolute;top:"+(o+2)*(r+2)+"px;background: url(js/wbManager/menuimages/transparent2.png) no-repeat center;width:"+r+"px; height:"+(r-1)+"px;background-size:"+(r+4)+"px "+(r+4)+"px;border-style:solid;border-color:"+h+';border-width:1px"></div>':(i+='<div id="backgroundcolor_'+n+"\" onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuAppearance.mouseClick(this)' style=\"position:absolute; left:"+a*(r+2)+"px;top:"+(o+2)*(r+2)+"px;width:"+r+"px; height:"+r+"px;background-size:"+r+"px "+r+"px;border-style:solid;border-color:"+h+';border-width:1px">',i+='<div style="border-radius:50%;position:relative;background:'+H.colorChoices[n]+";width:"+r+"px; height:"+r+"px;background-size:"+r+"px "+r+'px;"></div></div>'),++n>=H.colorChoices.length-1)break}if(n>=H.colorChoices.length-1)break}i+="</div>",i+='<div style="position:absolute;top:130px;width:100%">',i+="<hr>",i+="</div>",i+='<div style="position:absolute;top:145px;width:100%">'}else i+='<div style="position:absolute;top:0px;width:100%">';for(i+='<div style="background: url(js/wbManager/menuimages/linethicknessthin.png) no-repeat top left;width:20px; height:20px;background-size:20px 20px;border-style:solid;border-color:white;border-width:1px"></div>',i+='<input id="borderthicknesslider" oninput="menuAppearance.borderThicknessChanged()" style="position:absolute; top:0px; left:22px;"type="range" min="0" max="200" step="10" value="'+e.borderWidth/20*200+'" class="myslider">',i+='<div style="background: url(js/wbManager/menuimages/linethicknessthick.png) no-repeat top left;position:absolute;width:20px; height:20px;left:127px;top:0px;background-size:20px 20px;border-style:solid;border-color:white;border-width:1px"></div>',i+="<div onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuAppearance.setBorderPattern()' style=\"background: url(js/wbManager/menuimages/solidline.png) no-repeat top left;position:absolute;width:20px; height:20px;left:170px;top:0px;background-size:20px 20px;border-style:solid;border-color:"+(null==e.borderPattern?"black":"white")+';border-width:1px"></div>',i+="<div onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuAppearance.setBorderPattern(0)' style=\"background: url(js/wbManager/menuimages/dashedline1.png) no-repeat top left;position:absolute;width:20px; height:20px;left:192px;top:0px;background-size:20px 20px;border-style:solid;border-color:"+(0==e.borderPattern?"black":"white")+';border-width:1px"></div>',i+="<div onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuAppearance.setBorderPattern(1)' style=\"background: url(js/wbManager/menuimages/dashedline2.png) no-repeat top left;position:absolute;width:20px; height:20px;left:214px;top:0px;background-size:20px 20px;border-style:solid;border-color:"+(1==e.borderPattern?"black":"white")+';border-width:1px"></div>',i+="<div onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuAppearance.setBorderPattern(2)' style=\"background: url(js/wbManager/menuimages/dashedline3.png) no-repeat top left;position:absolute;width:20px; height:20px;left:236px;top:0px;background-size:20px 20px;border-style:solid;border-color:"+(2==e.borderPattern?"black":"white")+';border-width:1px"></div>',n=1,r=24,o=0;o<5;o++){for(a=0;a<10;a++){var d;if(h="white",(d=e.borderColor)==H.colorChoices[n]&&(h="black"),i+='<div id="bordercolor_'+n+"\" onmouseenter='menuItem.mouseEnter(this)' onmouseleave='menuItem.mouseLeave(this)' onclick='menuAppearance.mouseClick(this)' style=\"position:absolute; left:"+a*(r+2)+"px;top:"+(o+1)*(r+2)+"px;width:"+r+"px; height:"+r+"px;background-size:"+r+"px "+r+"px;border-style:solid;border-color:"+h+';border-width:1px">',i+='<div style="border-radius:50%;position:relative;background:'+H.colorChoices[n]+";width:"+r+"px; height:"+r+"px;background-size:"+r+"px "+r+'px;"></div></div>',++n>=H.colorChoices.length)break}if(n>=H.colorChoices.length)break}i+="</div>",$("#wbmenu_"+this.getName()).empty(),$("#wbmenu_"+this.getName()).append(i)}display(){if(!this._active){U.redraw();var e=U.getSelectedItems()[0];this._active=!0;var i="",n=250;e.getType()==t.wbLine&&(n=106),i+='<div id="wbmenu_'+this.getName()+'" style="opacity:0;background-color:white;box-shadow: grey 0px 0px 10px;border-radius: 5px;border: 5px solid white;position:absolute; left:'+this._pos.x+"px; top:"+this._pos.y+"px ;z-index:1000000000;width:270px;height:"+n+'px">',i+="</div>",$(D.menudiv).prepend(i),this.refresh(),$("#wbmenu_"+this.getName()).height(),$("#wbmenu_"+this.getName()).css({top:this._pos.y}),E.fadeIn("#wbmenu_"+this._name)}}}window.menuAppearance=H;class z extends E{static mouseClick(e){var t=e.id.split("_"),i=D.getByName(t[0]);i.action(t[0],t[1]),i.hide(!0)}static keyDown(){$("#tagsearchtext")[0].value,D.getByName("searchmenu").generateTagDiv()}static zoomToFoundItem(e){var t=U.getItemByGUID(e);U.ctrlPressed?t.setSelected(!t.getSelected()):(U.clearSelection(),t.setSelected(!0));var i=U.calculateSelectionBounding().bounding;U.fitSelection(1,i),D.getByName("searchmenu").generateTagDiv()}constructor(e){super(e),this.action=W.action}generateTagDiv(){$("#allsearchtags").empty();var e=$("#tagsearchtext")[0].value;if(""!=e){for(var t=[],i=U.getItems(),n=0;n<i.length;n++){var s=i[n].getTags().getTagsHash();for(var r in s)if(r.substring(0,e.length)==e){t.push({guid:i[n].getGUID(),tag:r});break}}var o=wbTags.allTags.getTagsHash(),a="",h=0;for(n=0;n<t.length;n++)U.getItemByGUID(t[n].guid).getSelected()?a+="<div onclick='wbMenuSearch.zoomToFoundItem(\""+t[n].guid+'")\' style="border-style:solid;border-width:2px;border-color:black;position:absolute; top:'+27*h+"px;margin-bottom:2px; color:white;background:"+o[t[n].tag]+';margin-left:3px;padding:2px;display:inline-flex">'+t[n].tag+"</div>":a+="<div onclick='wbMenuSearch.zoomToFoundItem(\""+t[n].guid+'")\' style="border-style:solid;border-width:2px;border-color:white;position:absolute; top:'+27*h+"px;margin-bottom:2px; color:white;background:"+o[t[n].tag]+';margin-left:3px;padding:2px;display:inline-flex">'+t[n].tag+"</div>",h++;$("#allsearchtags").append(a),U.redraw()}}display(){if(!this._active){U.redraw(),this._active=!0;var e="";e+='<div id="wbmenu_'+this.getName()+'" style="overflow-x:hidden;overflow-y:auto;height:300px;opacity:0;background-color:white;box-shadow: grey 0px 0px 10px;border-radius: 5px;border: 5px solid white;position:absolute; left:'+this._pos.x+"px; top:"+this._pos.y+'px ;z-index:1000000000;width:240px">',e+='<input onkeyup="wbMenuSearch.keyDown()" id="tagsearchtext" type="text" placeholder="Enter Tag" style="position:relative;left:5px;top:0px;width:200px"></Input>',e+='<div id="allsearchtags" style="position:relative; left:2px;top:5px">',e+="</div>",e+="</div>",$(D.menudiv).prepend(e),this.generateTagDiv(),$("#wbmenu_"+this.getName()).height(),$("#wbmenu_"+this.getName()).css({top:this._pos.y}),E.fadeIn("#wbmenu_"+this._name)}}hideSimple(){this._active&&(this._active=!1,$("#wbmenu_"+this._name).remove())}setEditTag(e){this.editTagName=e}getEditTag(){return this.editTagName}}class V extends E{static arrange(){for(var e=wbMain.getSelectedItems(),t=0;t<e.length;t++)e[t].arrangeItems();wbMain.redraw(),wbItemContainer.assignItemsToContainer(),menuManager.getByName("tagscontainermenu").hide(!0)}static activateTag(e){for(var t=menuManager.getByName("tagscontainermenu"),i=wbMain.getSelectedItems(),n=0,s=0;s<i.length;s++)i[s].getTargetTags().hasTag(e)&&n++;if(n==i.length)for(s=0;s<i.length;s++)i[s].getTargetTags().removeTag(e);else for(s=0;s<i.length;s++)i[s].getTargetTags().addTag(e);t.generateTagDiv()}constructor(e){super(e)}generateTagDiv(){$("#alltagscontainer").empty();var e=[],t=wbTags.allTags.getTagsHash();for(var i in t)e[i]=!1;var n=wbMain.getSelectedItems();for(i=0;i<n.length;i++){var s=n[i].getTargetTags().getTagsHash();for(var r in s)e[r]=!0}var o="";for(var i in e){var a="";0==e[i]&&(a="opacity:0.15;"),o+="<div onclick='menuTagsContainer.activateTag(\""+i+'")\' style="'+a+"margin-bottom:2px; color:white;background:"+t[i]+';margin-left:3px;padding:2px;display:inline-flex">'+i+"</div>"}$("#alltagscontainer").append(o),wbMain.redraw()}display(){if(!this._active){wbMain.redraw(),this._active=!0;var e="";e+='<div id="wbmenu_'+this.getName()+'" style="opacity:0;background-color:white;box-shadow: grey 0px 0px 10px;border-radius: 5px;border: 5px solid white;position:absolute; left:'+this._pos.x+"px; top:"+this._pos.y+'px ;z-index:1000000000;width:270px">',e+='<div id="alltagscontainer">',e+="</div>",e+='<button type="button" style="background-color:white;border-style:none;position:relative; top:0px;left:0px" onclick="menuTagsContainer.arrange(this)">Arrange</button>',e+="</div>",$(menuManager.menudiv).prepend(e),this.generateTagDiv(),$("#wbmenu_"+this.getName()).height(),$("#wbmenu_"+this.getName()).css({top:this._pos.y}),E.fadeIn("#wbmenu_"+this._name)}}hideSimple(){this._active&&(this._active=!1,$("#wbmenu_"+this._name).remove())}hide(){super.hide(!0),this.mode=0}setEditTag(e){this.editTagName=e}getEditTag(){return this.editTagName}}let R=new function(){var i,n,s,r,o,a,h,l,c,u;return{menudiv:"",initialize:function(t,d){D.initialize(t,d);var g=$(D.menudiv)[0].getBoundingClientRect(),m=new E("colors");m.addItem("transparent","transparent.png"),m.addItem("grey2","rgb(255,255,255)"),m.addItem("grey3","rgb(210,210,210)"),m.addItem("grey4","rgb(150,150,150)"),m.addItem("grey5","rgb(64,64,64)"),m.addItem("grey6","rgb(0,0,0)"),m.addItem("red1","rgb(255,128,128)"),m.addItem("red2","rgb(255,0,0)"),m.addItem("red3","rgb(210,0,0)"),m.addItem("red4","rgb(170,0,0)"),m.addItem("red5","rgb(130,0,0)"),m.addItem("red6","rgb(64,0,0)"),m.addItem("green1","rgb(128,255,128)"),m.addItem("green2","rgb(0,255,0)"),m.addItem("green3","rgb(0,210,0)"),m.addItem("green4","rgb(0,170,0)"),m.addItem("green5","rgb(0,130,0)"),m.addItem("green6","rgb(0,64,0)"),m.addItem("blue1","rgb(128,128,255)"),m.addItem("blue2","rgb(0,0,255)"),m.addItem("blue3","rgb(0,0,210)"),m.addItem("blue4","rgb(0,0,170)"),m.addItem("blue5","rgb(0,0,130)"),m.addItem("blue6","rgb(0,0,64)"),m.addItem("yellow1","rgb(255,241,170)"),m.addItem("yellow2","rgb(255,255,0)"),m.addItem("yellow3","rgb(210,210,0)"),m.addItem("yellow4","rgb(170,170,0)"),m.addItem("yellow5","rgb(130,130,0)"),m.addItem("yellow6","rgb(64,64,0)"),m.setOrientation(N.box),m.setBoxDimensions(6,5);var p=new E("otheritems");p.addItem("createblank","blank.png",this.insertBlankItem,0,!0,m,"Create Blank"),p.addItem("createtexteditornote","text.png",this.insertBlankItem,1,!0,m,"Create Text Editor"),p.addItem("createcontainer","container.png",this.insertBlankItem,1,!0,m,"Create Container");var f=new L("size");f.setOrientation(N.vertical);var w=new O("font");w.setOrientation(N.vertical);var x=new E("rendermodes");x.addItem("Shaded with Lines","rm_shadedwithlines.png",this.setRendermode),x.addItem("Shaded","rm_shaded.png",this.setRendermode),x.addItem("Hidden Line","rm_hiddenline.png",this.setRendermode),x.addItem("Wireframe","rm_wireframe.png",this.setRendermode),x.addItem("XRay","rm_xray.png",this.setRendermode),x.addItem("AmbientOcclusion","ao.png",this.setRendermode,0,!0),x.addItem("Bloom","bloom.png",this.setRendermode,0,!0),x.setOrientation(N.vertical),x.setImageSize(28,28);var y=new E("standardviewmenu");y.addItem("Front View","view_front.png",this.setStandardViews),y.addItem("Back View","view_back.png",this.setStandardViews),y.addItem("Left View","view_left.png",this.setStandardViews),y.addItem("Right View","view_right.png",this.setStandardViews),y.addItem("Top View","view_up.png",this.setStandardViews),y.addItem("Down View","view_down.png",this.setStandardViews),y.addItem("Iso View","view_iso.png",this.setStandardViews),y.setOrientation(N.vertical),y.setImageSize(28,28);var b=new W("tags");b.setOrientation(N.horizontal);var _=new H("menuAppearance");_.setOrientation(N.horizontal);for(var I=new E("tagcolors"),C=0;C<e.allowedTagColors.length;C++)I.addItem("tagcolors"+C,e.allowedTagColors[C]);I.setOrientation(N.box),I.setBoxDimensions(4,3);var S=new z("searchmenu");S.setOrientation(N.horizontal);var T=new V("tagscontainermenu");T.setOrientation(N.horizontal);var M=new E("operatormenu");M.addItem("Orbit","orbitoperator.png",this.setOperator),M.addItem("Walk","walkoperator.png",this.setOperator),M.addItem("EdgeLength","edgelengthoperator.png",this.setOperator),M.addItem("PointPoint","pointpointoperator.png",this.setOperator),M.addItem("NoMeasure","nomeasure.png",this.setOperator);var k=new E("leftarrowmenu");k.addItem("Left Arrow","arrowleft.png",this.setEndArrows),k.addItem("No Arrow Left","arrownone.png",this.setEndArrows);var A=new E("rightarrowmenu");A.addItem("Right Arrow","arrowright.png",this.setEndArrows),A.addItem("No Arrow Right","arrownone.png",this.setEndArrows);var P=new E("selmenu");i=P.addItem("rendermodes","rendermodes.png",void 0,0,!0,x,"Render Modes"),r=P.addItem("standardviews","viewmenu.png",void 0,0,!0,y,"Standard Views"),o=P.addItem("Projection","projection.png",this.setProjection,0,!0,void 0,"Perspective/Orthographic"),l=P.addItem("Operators","operators.png",void 0,0,!0,M,"Perspective/Orthographic"),c=P.addItem("LeftArrowChoice","arrowleft.png",void 0,0,!0,k,"Set End Arrows"),P.addItem("appearancemenu","appearance.png",void 0,1,!0,_,"Set Appearance"),u=P.addItem("RightArrowChoice","arrowright.png",void 0,0,!0,A,"Set End Arrows"),n=P.addItem("textsize","textsize.png",void 0,1,!0,f,"Text Size"),s=P.addItem("textfont","textfont.png",void 0,1,!0,w,"Text Font"),P.setOrientation(N.horizontal),h=P.addItem("autoarrange","autoarrange.png",this.setAutoArrange,0,!0,void 0,"Enable/Disable Auto Arrange"),P.addItem("tagsmenu","tags.png",void 0,1,!0,b,"Define Tags"),a=P.addItem("containertagsmenu","containertags.png",void 0,1,!0,T,"Define Container Tags");var R=new E("curveitems");R.addItem("newcurveline","lineline.png",this.newCurve,1,!1,void 0,"New Curve"),R.addItem("newcurvecurve","linecurve.png",this.newCurve,1,!1,void 0,"New Curve"),R.addItem("newcurvestep","linestep.png",this.newCurve,1,!1,void 0,"New Curve");var F=new E("main");F.setPosition(10,g.height/2),F.addItem("search","search.png",void 0,1,!0,S,"Search"),F.addItem("creatitem","create.png",void 0,1,!0,p,"Create Item"),F.addItem("createtexteditortext","text2.png",this.insertBlankItem,1,!1,void 0,"Create Text Editor"),F.addItem("curveoptions","newcurve.png",void 0,1,!0,R,"Create Item"),D.addMenu(F),D.addMenu(m),D.addMenu(p),D.addMenu(P),D.addMenu(f),D.addMenu(w),D.addMenu(x),D.addMenu(y),D.addMenu(b),D.addMenu(I),D.addMenu(S),D.addMenu(T),D.addMenu(R),D.addMenu(M),D.addMenu(_),D.addMenu(k),D.addMenu(A),F.setOrientation(N.vertical),F.display();var B=[{name:"Order & Locking",subMenu:[{name:"Bring To Front",fun:function(){wbManager.bringToFront()}},{name:"Send To Back",fun:function(){wbManager.sendToBack()}},{name:"Lock",fun:function(){wbManager.setLocked(!0)}},{name:"Unlock",fun:function(){wbManager.setLocked(!1)}}]},{name:"Group",fun:function(){U.group()}},{name:"Ungroup",fun:function(){U.ungroup()}},{name:"Fit Selection",fun:function(){U.fitSelection(1.5)}},{name:"Fit All",fun:function(){U.fitAll()}},{name:"Toggle Multi-Active",fun:function(){v.setKeepAlive(!v.keepAlive)}},{name:"Delete Selected",fun:function(){U.handleDelete()}},{name:"Refresh Selected",fun:function(){U.refreshAll()}},{name:"Text Styles",subMenu:[{name:"Bold On",fun:function(){U.carotaEditor.selectedRange().setFormatting("bold",!0)}},{name:"Bold Off",fun:function(){U.carotaEditor.selectedRange().setFormatting("bold",!1)}},{name:"Italic On",fun:function(){U.carotaEditor.selectedRange().setFormatting("italic",!0)}},{name:"Italic Off",fun:function(){U.carotaEditor.selectedRange().setFormatting("italic",!1)}},{name:"Align Left",fun:function(){U.carotaEditor.selectedRange().setFormatting("align","left")}},{name:"Align Center",fun:function(){U.carotaEditor.selectedRange().setFormatting("align","center")}},{name:"Color Black",fun:function(){U.carotaEditor.selectedRange().setFormatting("color","black")}},{name:"Color Red",fun:function(){U.carotaEditor.selectedRange().setFormatting("color","red")}},{name:"Underline On",fun:function(){U.carotaEditor.selectedRange().setFormatting("underline",!0)}},{name:"Underline Off",fun:function(){U.carotaEditor.selectedRange().setFormatting("underline",!1)}},{name:"Vertical Alignment Top",fun:function(){U.carotaEditor.setVerticalAlignment("top")}},{name:"Vertical Alignment Middle",fun:function(){U.carotaEditor.setVerticalAlignment("middle")}},{name:"Vertical Alignment bottom",fun:function(){U.carotaEditor.setVerticalAlignment("bottom")}},{name:"1px",fun:function(){U.carotaEditor.selectedRange().setFormatting("size","1")}},{name:"3px",fun:function(){U.carotaEditor.selectedRange().setFormatting("size","3")}},{name:"5px",fun:function(){U.carotaEditor.selectedRange().setFormatting("size","5")}},{name:"10px",fun:function(){U.carotaEditor.selectedRange().setFormatting("size","10")}},{name:"15px",fun:function(){U.carotaEditor.selectedRange().setFormatting("size","15")}},{name:"20px",fun:function(){U.carotaEditor.selectedRange().setFormatting("size","20")}},{name:"30px",fun:function(){U.carotaEditor.selectedRange().setFormatting("size","30")}},{name:"50px",fun:function(){U.carotaEditor.selectedRange().setFormatting("size","50")}},{name:"100px",fun:function(){U.carotaEditor.selectedRange().setFormatting("size","100")}}]}];$(D.menudiv).contextMenu("menu",B,{triggerOn:"click",subMenuTriggerOn:"hover"}),$(U.mainOuterWindow).contextMenu("menu",B,{triggerOn:"click",subMenuTriggerOn:"hover"})},newCurve:function(e){"newcurveline"==e.name?d.setNewLineMode(0):"newcurvecurve"==e.name?d.setNewLineMode(1):"newcurvestep"==e.name&&d.setNewLineMode(2)},async setOperator(e,i){var n;"Orbit"==e.name?n=Communicator.OperatorId.Navigate:"Walk"==e.name?n=Communicator.OperatorId.KeyboardWalk:"EdgeLength"==e.name?n=Communicator.OperatorId.MeasureEdgeLength:"PointPoint"==e.name&&(n=Communicator.OperatorId.MeasurePointPointDistance);for(var s=U.getSelectedItems(),r=0;r<s.length;r++)if(s[r].getType()==t.wbItemHC){s[r].getActive(),await s[r].activate();var o=s[r].getHWV();n==Communicator.OperatorId.MeasureEdgeLength||n==Communicator.OperatorId.MeasurePointPointDistance?o.operatorManager.set(n,1):null==n?o.operatorManager.set(Communicator.OperatorId.Select,1):o.operatorManager.set(n,0)}},async setStandardViews(e,i){var n;"Front View"==e.name?n=Communicator.ViewOrientation.Front:"Back View"==e.name?n=Communicator.ViewOrientation.Back:"Left View"==e.name?n=Communicator.ViewOrientation.Left:"Right View"==e.name?n=Communicator.ViewOrientation.Right:"Top View"==e.name?n=Communicator.ViewOrientation.Top:"Down View"==e.name?n=Communicator.ViewOrientation.Bottom:"Iso View"==e.name&&(n=Communicator.ViewOrientation.Iso);for(var s=U.getSelectedItems(),r=0,o=0;o<s.length;o++)s[o].getType()==t.wbItemHC&&r++;for(o=0;o<s.length;o++)if(s[o].getType()==t.wbItemHC){var a=s[o].getActive();await s[o].activate();var h=s[o].getHWV();r>1||0==a?await h.view.setViewOrientation(n,0):await h.view.setViewOrientation(n,500),r>1&&await s[o].deactivate()}},setAutoArrange(e,i){var n;n=!!e.isToggled();for(var s=U.getSelectedItems(),r=0;r<s.length;r++)s[r].getType()==t.wbItemContainer&&(s[r].setAutoArrange(n),s[r].getAutoArange()&&(s[r].dragItemsAndArrange(),U.redraw()))},async setProjection(e,i){var n;n=e.isToggled()?Communicator.Projection.Perspective:Communicator.Projection.Orthographic;for(var s=U.getSelectedItems(),r=0,o=0;o<s.length;o++)s[o].getType()==t.wbItemHC&&r++;for(o=0;o<s.length;o++)if(s[o].getType()==t.wbItemHC){await s[o].activate();var a=s[o].getHWV();await a.view.setProjectionMode(n),r>1&&await s[o].deactivate()}},async setRendermode(e,i){var n,s,r;"Shaded with Lines"==e.name?n=Communicator.DrawMode.WireframeOnShaded:"Shaded"==e.name?n=Communicator.DrawMode.Shaded:"Hidden Line"==e.name?n=Communicator.DrawMode.HiddenLine:"Wireframe"==e.name?n=Communicator.DrawMode.Wireframe:"XRay"==e.name?n=Communicator.DrawMode.XRay:"AmbientOcclusion"==e.name?s=e.isToggled():"Bloom"==e.name&&(r=e.isToggled());for(var o=U.getSelectedItems(),a=0,h=0;h<o.length;h++)o[h].getType()==t.wbItemHC&&a++;for(h=0;h<o.length;h++)if(o[h].getType()==t.wbItemHC){await o[h].activate();var d=o[h].getHWV();null!=s?await d.view.setAmbientOcclusionEnabled(s):null!=r?await d.view.setBloomEnabled(r):await d.view.setDrawMode(n),a>1&&await o[h].deactivate()}},setDerived(e,i){for(var n=U.getSelectedItems(),s=0;s<n.length;s++)if(n[s].getType()==t.wbItemHC){"Duplicate"==e.name?n[s].duplicateToNewWindow():"Standard Views"==e.name?n[s].standardViewsToNewWindow():"Isolate"==e.name?n[s].isolateToNewWindow():"Isolate2"==e.name?n[s].isolateAllToNewWindow():"CAD Views"==e.name?n[s].CADViewstoNewWindow():"Sheets"==e.name?n[s].sheetsToNewWindow():"Floors"==e.name?n[s].floorsToNewWindow():"Unique Meshes"==e.name?n[s].uniqueMeshesToNewWindow():"Explode"==e.name?n[s].explodeToNewWindow():"Magnifier"==e.name?n[s].magnifierToNewWindow():"Model Tree"==e.name?n[s].modelTreeToNewWindow():"MTree"==e.name&&n[s].mTreeToNewWindow();break}},async addModelFromMenu(e,i){if("loadnewmodel"==i.name)for(var n=U.getSelectedItems(),s=0;s<n.length;s++)n[s].getType()==t.wbItemHC&&await v.replace(e.name,n[s]);else"emptymodel"==e.name?U.addFromRectangle(void 0,t.wbItemHC,"rgb(255,255,255)"):U.addFromRectangle(e.name,t.wbItemHC,"rgb(255,255,255)")},setEndArrows(e,t){var i=void 0,n=void 0;"Left Arrow"==e.name&&(i=!0),"Right Arrow"==e.name&&(n=!0),"No Arrow Left"==e.name&&(i=!1),"No Arrow Right"==e.name&&(n=!1);var s=D.getByName("selmenu");null!=i&&(1==i?c.setImage("arrowleft.png",s):c.setImage("arrownone.png",s)),null!=n&&(1==n?u.setImage("arrowleft.png",s):u.setImage("arrownone.png",s));for(var r=U.getSelectedItems(),o=0;o<r.length;o++)null!=i&&(r[o].drawStartArrow=i),null!=n&&(r[o].drawEndArrow=n);U.redraw()},setShape(e,t){"rectangleshape"==e.name?U.setShape(wbItemShape.rectangle):"circleshape"==e.name?U.setShape(wbItemShape.circle):U.setShape(wbItemShape.roundedCornerRectangle)},mainMenu(){window.location="./"},insertBlankItem(e,i,n){var s;s="transparent.png"==e.imagename?void 0:e.imagename,"createtexteditortext"!=e.name?null!=i&&("backgroundcolor"==i.name?U.setBackgroundColor(s):"createblank"==i.name?U.addFromRectangle("",t.wbItem,s):"createtexteditornote"==i.name?U.addFromRectangle("",t.wbItemTextEditorNote,s):"createtexteditortext"==i.name?U.addFromRectangle("",t.wbItemTextEditorText,s):"createcontainer"==i.name&&U.addFromRectangle("",t.wbItemContainer,s)):U.addFromRectangle("",t.wbItemTextEditorText,s)},hideAllMenus(){D.hideAll()},showSelectionMenu(){var e=D.getByName("selmenu"),d=U.getSelectedItems();if(0==d.length)e.hide();else{for(var g=0,m=0,p=0,f=0,v=0;v<d.length;v++)d[v].getType()==t.wbItemHC&&g++,d[v].getType()==t.wbItemTextEditor&&m++,d[v].getType()==t.wbItemContainer&&p++,d[v].getType(),d[v].getType()==t.wbLine&&f++;if(i.hidden=!1,r.hidden=!1,o.hidden=!1,l.hidden=!1,n.hidden=!0,s.hidden=!0,a.hidden=!0,h.hidden=!0,c.hidden=!0,u.hidden=!0,0==g&&(i.hidden=!0,r.hidden=!0,o.hidden=!0,l.hidden=!0),1==m&&1==d.length&&(n.hidden=!1,s.hidden=!1),1==p&&1==d.length&&(a.hidden=!1,h.hidden=!1,h.setToggled(d[0].getAutoArange())),f==d.length){var w=d[0];c.hidden=!1,u.hidden=!1;var x=D.getByName("selmenu");1==w.drawStartArrow?c.setImage("arrowleft.png",x):c.setImage("arrownone.png",x),1==w.drawEndArrow?u.setImage("arrowright.png",x):u.setImage("arrownone.png",x)}var y=U.calculateCombinedBounding(d),b=U.convertCanvasToWindowCoordinates(y);e.setPosition(b.left+b.width/2,b.top-50),e.display()}},hideSelectionMenu(){D.getByName("selmenu").hide()}}};class F{static plusimage=void 0;static minusimage=void 0;static initialize(){F.plusimage=new Image,F.plusimage.src="js/wbManager/menuimages/mtreeplus.png",F.minusimage=new Image,F.minusimage.src="js/wbManager/menuimages/mtreeminus.png"}constructor(e){this.root=new B("root"),this.nodehash=[],this.ctx=void 0,this.hotSpots=[],this.dimensions=void 0,this.nodeHeight=15,this.openIndent=15,this.scrollY=.5,this.treeHeight=0,this.doScroll=!1,this.showScrollBar=!1,this.hotSpots=[],this.matchingnodes=[],this.selectedCallback=e}add(e,t,i){var n=this.root;null!=e&&(n=this.nodehash[e]);var s=new B(t,i);this.nodehash[i]=s,n.addChild(s)}setExpanded(e,t){var i=this.root;null!=e&&(i=this.nodehash[e]),i.setExpanded(t)}addHotSpot(e,t){this.hotSpots.push({item:e,pos:t})}render(e,t){if(this.hotSpots=[],this.ctx=e,this.dimensions=t,this.startX=this.dimensions.left+this.openIndent,this.treeHeight<this.dimensions.height)this.startY=this.dimensions.top+this.nodeHeight;else{var i=this.treeHeight-t.height;this.startY=this.dimensions.top+this.nodeHeight-this.scrollY*i}this.currentY=this.startY,this.ctx.textAlign="left",this.ctx.font=this.nodeHeight-3+'px "Arial"',this.ctx.fillStyle="rgb(0,0,0)",this.ctx.strokeStyle="rgb(0,0,0)",this.root.render(this,this.startX),this.treeHeight=this.currentY-this.startY,this.ctx.fillStyle="rgb(255,255,255)",e.lineWidth=1/wbMain.getZoomFactor();var n=10/wbMain.getZoomFactor(),s=this.dimensions.height/this.treeHeight;if(this.showScrollBar)if(s>1)s=1;else{var r=this.dimensions.height*s;e.fillRect(this.dimensions.left+this.dimensions.width-n,this.dimensions.top+(this.dimensions.height-r)*this.scrollY,n,r),e.strokeRect(this.dimensions.left+this.dimensions.width-n,this.dimensions.top+(this.dimensions.height-r)*this.scrollY,n,r)}}onMouseDown(e,t,i){var n=10/wbMain.getZoomFactor();return e>this.dimensions.left+this.dimensions.width-n&&e<this.dimensions.left+this.dimensions.width&&(this.doScroll=!0,this.startScrollY=this.scrollY,!0)}onMouseMove(e,t,i){if(this.doScroll){var n=wbMain.getDragStart().y,s=this.dimensions.height/this.treeHeight,r=this.dimensions.height*s,o=(t-n)/(this.dimensions.height-r);return this.scrollY=this.startScrollY+o,this.scrollY>1&&(this.scrollY=1),this.scrollY<0&&(this.scrollY=0),!0}return!1}deselectAll(){for(var e in this.nodehash)this.nodehash[e].setSelected(!1)}gatherMatchingNodes(e){for(var t in this.matchingnodes=[],this.nodehash)if(-1!=this.nodehash[t].text.toLowerCase().indexOf(e.toLowerCase())){var i=this.nodehash[t],n=[];for(n.push(this.nodehash[t].text);;){var s=i.getParent();if(null==s)break;n.push(s.text),i=s}for(var r="",o=n.length-1;o>=0;o--)r+=o>0?n[o]+"->":n[o];var a={name:this.nodehash[t].text,chain:r,id:this.nodehash[t].id,selected:this.nodehash[t].getSelected()};this.matchingnodes.push(a)}return this.matchingnodes}async doSelection(e,t){t==Communicator.SelectionMode.Set&&this.deselectAll();for(var i=!1,n=0;n<e.length;n++)t==Communicator.SelectionMode.Set?(this.nodehash[e[n]].setSelected(!0),i?this.selectedCallback(this.nodehash[e[n]].id,Communicator.SelectionMode.Add):(this.selectedCallback(this.nodehash[e[n]].id,Communicator.SelectionMode.Set),i=!0)):(this.nodehash[e[n]].setSelected(!this.nodehash[e[n]].getSelected()),this.selectedCallback(this.nodehash[e[n]].id,t))}onMouseUp(e,t,i){this.doScroll=!1;var n=this.nodeHeight/2;if(!i)for(var s=0;s<this.hotSpots.length;s++){var r=this.hotSpots[s].pos;if(e>=r.x-n&&e<=r.x+n&&t>=r.y-n&&t<=r.y+n){this.hotSpots[s].item.setExpanded(!this.hotSpots[s].item.getExpanded());break}if(e>=r.x+n&&t>=r.y-n&&t<=r.y+n){wbMain.ctrlPressed?(this.hotSpots[s].item.setSelected(!this.hotSpots[s].item.getSelected()),this.selectedCallback(this.hotSpots[s].item.id,Communicator.SelectionMode.Toggle)):(this.deselectAll(),this.hotSpots[s].item.setSelected(!0),this.selectedCallback(this.hotSpots[s].item.id,Communicator.SelectionMode.Set));break}}}}class B{constructor(e,t){this.text=e,this.children=[],this.expanded=!1,this.selected=!1,this.parent=void 0,this.hotspot=void 0,this.id=t}addChild(e){e.setParent(this),this.children.push(e)}setExpanded(e){this.expanded=e}getExpanded(){return this.expanded}setSelected(e){this.selected=e}getSelected(){return this.selected}setParent(e){this.parent=e}getParent(){return this.parent}render(e,t){if(e.addHotSpot(this,{x:t-e.nodeHeight/2,y:e.currentY-e.nodeHeight/1.5}),this.selected&&(e.ctx.fillStyle="rgb(255,255,0)",e.ctx.fillRect(t,e.currentY-e.nodeHeight/1.5,e.dimensions.left+e.dimensions.width-t,e.nodeHeight),e.ctx.fillStyle="rgb(0,0,0)"),e.ctx.fillText(this.text,t,e.currentY),this.children.length>0&&(this.expanded?e.ctx.drawImage(F.plusimage,t-e.nodeHeight+2,e.currentY-e.nodeHeight/1.5,e.nodeHeight/1.5,e.nodeHeight/1.5):e.ctx.drawImage(F.minusimage,t-e.nodeHeight+2,e.currentY-e.nodeHeight/1.5,e.nodeHeight/1.5,e.nodeHeight/1.5)),e.currentY+=e.nodeHeight,this.expanded){t+=e.openIndent;for(var i=0;i<this.children.length;i++)this.children[i].render(e,t)}}}let U=new function(){var i,n,o,a,h,d,l,c,g=1,m=[],p=[],x=!1,y="";function I(e,t,i){if(i>=e.length)for(var n=i-e.length+1;n--;)e.push(void 0);return e.splice(i,0,e.splice(t,1)[0]),e}return{shiftPressed:!1,ctrlPressed:!1,lastX:0,lastY:0,backendAvailable:!1,carotaEditor:null,mainOuterWindow:"",showSelectionMenu:null,hideSelectionMenu:null,hideAllMenus:null,start:function(e,t,i){U.mainOuterWindow="#"+e,y="#mainwindow2",$(U.mainOuterWindow).empty(),$(U.mainOuterWindow).append('<div id="mainwindow2" style="width:100%;height:100%;position:absolute;z-index:1000000"></div>'),$(y).append('<div id="carotadiv" style="position:absolute;z-index:1;width:20%;height:100%;left:10px; display:none;overflow:hidden;margin-left:1px;border-style:none;border-width:1px">Test</div><canvas id="whiteboardcanvas" style="position:absolute;left:0px;top:0px;"></canvas><canvas id="whiteboardcanvasoverlay" style="position:absolute;left:0px;top:0px;pointer-events:none;z-index:100000000"></canvas>'),$(document.body).append('<div id="hcModelCache" style="display:none"></div>'),$(y).append('<div id="newdialogwindow" style="z-index:1000000"></div>'),$(U.mainOuterWindow).append('<div id="menudiv" style="width:100%;height:100%;z-index:10000000000"></div>');var n=document.querySelector("#carotadiv");U.carotaEditor=carota.editor.create(n),U.carotaEditor.contentChanged((function(){_.contentChanged()})),$(document).on("keydown",(e=>{e.ctrlKey?U.ctrlPressed=!0:U.ctrlPressed=!1,e.shiftKey?U.shiftPressed=!0:U.shiftPressed=!1})),$(document).on("keyup",(e=>{var t=e.keyCode;e.ctrlKey?U.ctrlPressed=!0:U.ctrlPressed=!1,e.shiftKey?U.shiftPressed=!0:U.shiftPressed=!1,67==t&&e.ctrlKey&&U.copy(),86==t&&e.ctrlKey&&U.paste()})),$(document).on("mousedown",(e=>{blockRightClick=!1})),$(document).on("mousemove",(e=>{blockRightClick=!0})),U.initialize("whiteboardcanvas","whiteboardcanvasoverlay"),f.initialize("hcModelCache"),t&&(R.initialize("menudiv",i),this.hideSelectionMenu=R.hideSelectionMenu,this.showSelectionMenu=R.showSelectionMenu,this.showSelectionMenu=R.hideAllMenus),F.initialize()},initialize:function(t,s){i=$("#"+t)[0];var r=$("#"+s)[0];n=i.getContext("2d"),o=r.getContext("2d");var a=$("#"+t).parent()[0].getBoundingClientRect();$("#"+t).attr("width",a.width),$("#"+t).attr("height",a.height),$("#"+s).attr("width",a.width),$("#"+s).attr("height",a.height),U.lastX=i.width/2,U.lastY=i.height/2,function(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg"),i=t.createSVGMatrix();e.getTransform=function(){return i};var n=[],s=e.save;e.save=function(){return n.push(i.translate(0,0)),s.call(e)};var r=e.restore;e.restore=function(){return i=n.pop(),r.call(e)};var o=e.scale;e.scale=function(t,n){return i=i.scaleNonUniform(t,n),o.call(e,t,n)};var a=e.rotate;e.rotate=function(t){return i=i.rotate(180*t/Math.PI),a.call(e,t)};var h=e.translate;e.translate=function(t,n){return i=i.translate(t,n),h.call(e,t,n)};var d=e.transform;e.transform=function(n,s,r,o,a,h){var l=t.createSVGMatrix();return l.a=n,l.b=s,l.c=r,l.d=o,l.e=a,l.f=h,i=i.multiply(l),d.call(e,n,s,r,o,a,h)};var l=e.setTransform;e.setTransform=function(t,n,s,r,o,a){return i.a=t,i.b=n,i.c=s,i.d=r,i.e=o,i.f=a,l.call(e,t,n,s,r,o,a)};var c=t.createSVGPoint();e.transformedPoint=function(e,t){return c.x=e,c.y=t,c.matrixTransform(i.inverse())},e.transformedPoint2=function(e,t){return c.x=e,c.y=t,c.matrixTransform(i)}}(n),w.initialize(n),e.initialize(),h=new b(n,o),$(y).on("mousedown",(e=>{var t,i,n=$(y).offset();t=e.clientX-n.left,i=e.clientY-n.top,h.onMouseDown(t,i,e.button),e.stopPropagation()})),setInterval((function(){U.backendAvailable&&U.serializeToNode()}),500),$(window).resize((function(){var e=$(window);$("#"+t).attr("width",e.width()),$("#"+t).attr("height",e.height()),$("#"+s).attr("width",e.width()),$("#"+s).attr("height",e.height()),U.redraw()})),$(y).on("touchstart",(e=>{e.touches.length>1?(l=new Communicator.Point2((e.touches[1].pageX+e.touches[0].pageX)/2,(e.touches[1].pageY+e.touches[0].pageY)/2),d=new Communicator.Point2(e.touches[1].pageX-e.touches[0].pageX,e.touches[1].pageY-e.touches[0].pageY).length(),h.onMouseDown(l.x,l.y,2)):h.onMouseDown(e.touches[0].pageX,e.touches[0].pageY,0)})),$(y).on("mousemove",(e=>{var t,i,n=$(y).offset();t=e.clientX-n.left,i=e.clientY-n.top,h.onMouseMove(t,i,e.button),e.stopPropagation()})),$(y).on("touchmove",(e=>{if(1!==e.scale&&e.preventDefault(),console.log(e.scale),e.touches.length>1){h.onMouseMove(e.touches[0].pageX,e.touches[0].pageY,2);var t=new Communicator.Point2((e.touches[1].pageX+e.touches[0].pageX)/2,(e.touches[1].pageY+e.touches[0].pageY)/2);h.onMouseMove(t.x,t.y,2);var i=new Communicator.Point2(e.touches[1].pageX-e.touches[0].pageX,e.touches[1].pageY-e.touches[0].pageY).length();U.zoomTouch(t.x,t.y,i/d),d=i,l=t,U.respositionNonCanvasItems()}else h.onMouseMove(e.touches[0].pageX,e.touches[0].pageY,0)})),$(y).on("touchend",(e=>{h.onMouseUp(0,0,0)})),$(y).on("mouseup",(e=>{h.onMouseUp(e),e.stopPropagation()})),i.addEventListener("DOMMouseScroll",(function(e){h.onMouseWheel(e)}),!1),i.addEventListener("mousewheel",(function(e){h.onMouseWheel(e)}),!1),this.loadFromNode(),this.redraw()},convertWindowToCanvasCoordinates:function(e){var t=n.transformedPoint(e.left,e.top),i=n.transformedPoint(e.left+e.width,e.top+e.height);return{left:t.x,top:t.y,width:i.x-t.x,height:i.y-t.y}},convertCanvasToWindowCoordinates:function(e){var t=n.transformedPoint2(e.left,e.top),i=n.transformedPoint2(e.left+e.width,e.top+e.height);return{left:t.x,top:t.y,width:i.x-t.x,height:i.y-t.y}},clearSelection:function(){for(var e=0;e<m.length;e++)m[e].setSelected(!1)},setSelected:function(e){for(var t=0;t<m.length;t++)e==t?m[t].setSelected(!0):m[t].setSelected(!1)},selectRelatedGroups:function(){for(var e=[],t=0;t<m.length;t++)if(1==m[t].getSelected()){var i=m[t].getGroup();null!=i&&(e[i]=!0)}for(var t in e)for(var n=0;n<m.length;n++)m[n].getGroup()==t&&m[n].setSelected(!0)},getItemByIndex:function(e){return m[e]},redraw:function(){var e=n.transformedPoint(0,0),t=n.transformedPoint(i.width,i.height),s=e.x%80,r=e.y%80;if(n.clearRect(e.x,e.y,t.x-e.x,t.y-e.y),o.clearRect(e.x,e.y,t.x-e.x,t.y-e.y),n.fillStyle="rgb(179,185,194)",n.getTransform().a>.155)for(var d=e.x-s;d<t.x;d+=80)for(var l=e.y-r;l<t.y;l+=80)n.fillRect(d,l,5,5);n.strokeStyle="#000000",n.fillStyle="rgb(255,255,255)";for(var c=0;c<m.length;c++)m[c].render(n,o);if(null!=a){var u=h.dragStart,g=n.transformedPoint(U.lastX,U.lastY);o.strokeStyle="rgb(0,0,0)",o.fillStyle="rgb(255,255,255)",o.lineWidth=1/n.getTransform().a,o.strokeRect(u.x,u.y,g.x-u.x,g.y-u.y),o.globalAlpha=.2,o.fillRect(u.x,u.y,g.x-u.x,g.y-u.y),o.globalAlpha=1}if(h.drawSelectionRectangle)u=h.dragStart,g=n.transformedPoint(U.lastX,U.lastY),o.strokeStyle="rgb(0,0,255)",o.fillStyle="rgb(0,0,255)",o.lineWidth=1/n.getTransform().a,o.strokeRect(u.x,u.y,g.x-u.x,g.y-u.y),o.globalAlpha=.2,o.fillRect(u.x,u.y,g.x-u.x,g.y-u.y),o.globalAlpha=1;else{var p=this.calculateSelectionBounding(!1);if(null!=p){var f=p.bounding;o.strokeStyle="rgb(0,0,255)",o.fillStyle="rgb(255,255,255)",o.lineWidth=1/n.getTransform().a,o.strokeRect(f.x1,f.y1,f.x2-f.x1,f.y2-f.y1),o.beginPath(),o.arc(f.x2,f.y2,5/n.getTransform().a,0,2*Math.PI),o.fill(),o.stroke(),o.beginPath(),o.arc(f.x1,f.y1,5/n.getTransform().a,0,2*Math.PI),o.fill(),o.stroke(),o.beginPath(),o.arc(f.x1,f.y2,5/n.getTransform().a,0,2*Math.PI),o.fill(),o.stroke(),o.beginPath(),o.arc(f.x2,f.y1,5/n.getTransform().a,0,2*Math.PI),o.fillStyle="rgb(255,255,255)",o.fill(),o.stroke(),o.fillRect((f.x2+f.x1)/2-5/n.getTransform().a,f.y1-5/n.getTransform().a,10/n.getTransform().a,10/n.getTransform().a),o.strokeRect((f.x2+f.x1)/2-5/n.getTransform().a,f.y1-5/n.getTransform().a,10/n.getTransform().a,10/n.getTransform().a)}}},zoom:function(e){var t=n.transformedPoint(U.lastX,U.lastY);n.translate(t.x,t.y);var i=Math.pow(1.1,e);n.scale(i,i),n.translate(-t.x,-t.y),o.translate(t.x,t.y),o.scale(i,i),o.translate(-t.x,-t.y),_.carotaScale=n.getTransform().a,this.redraw()},zoomTouch:function(e,t,i){var s=n.transformedPoint(e,t);n.translate(s.x,s.y),n.scale(i,i),n.translate(-s.x,-s.y),o.translate(s.x,s.y),o.scale(i,i),o.translate(-s.x,-s.y),_.carotaScale=n.getTransform().a,this.redraw()},fitAll:function(){var e=this.calculateCombinedBounding(this.getItems());this.fitSelection(1.5,e)},fitSelection:function(e,t){var i;i=null==t?this.calculateSelectionBounding().bounding:null!=t.x1?t:{x1:t.left,y1:t.top,x2:t.left+t.width,y2:t.top+t.height};var s,r=$("#whiteboardcanvas")[0].getBoundingClientRect(),o=n.getTransform(),a=r.width/(i.x2-i.x1),h=r.height/(i.y2-i.y1);s=a<h?a:h,s-=.1,this.animateCanvasCamera(o.e,o.f,o.a,-i.x1*s+r.width/2-(i.x2-i.x1)/2*s,-i.y1*s+r.height/2-(i.y2-i.y1)/2*s,s,e)},animateCanvasCamera:function(e,t,i,s,r,a,h){var d={x:e,y:t,s:i};R.hideSelectionMenu(),gsap.to(d,{duration:h,x:s,y:r,s:a,ease:Power2.easeInOut,onUpdate:function(){n.setTransform(d.s,0,0,d.s,d.x,d.y),o.setTransform(d.s,0,0,d.s,d.x,d.y),U.redraw(),U.respositionNonCanvasItems()},onComplete:function(){R.showSelectionMenu()}})},activateItemUnderMouse:function(){this.findwbItemUnderMouse().activate(n),this.redraw()},deactivateAll:function(e){var i=this,n=new Promise((function(n,s){for(var r=[],o=0;o<m.length;o++)!m[o].getActive()||m[o].getType()==t.wbItemHC&&1!=e||r.push(m[o].deactivate());e&&(v.activeHCItem=void 0),Promise.all(r).then((function(){setTimeout((function(){i.redraw()}),200),n()}))}));return n},findwbItemIndexUnderMouse:function(){for(var e=n.transformedPoint(U.lastX,U.lastY),t=m.length-1;t>=0;t--)if(m[t].pointInsideItem(e))return t},findwbItemUnderMouse:function(){for(var e=n.transformedPoint(U.lastX,U.lastY),t=m.length-1;t>=0;t--)if(m[t].pointInsideItem(e))return m[t]},findwbItemHCUnderMouse:function(){var e=this.findwbItemUnderMouse();if(null!=e)return e.getType()==t.wbItemHC?e:void 0},selectFromRectangle:function(e){for(var t=n.transformedPoint(U.lastX,U.lastY),i=0;i<m.length;i++){var s=m[i].getDimensions();s.left<e.x&&s.left+s.width<e.x||s.left>t.x&&s.left+s.width>t.x||s.top<e.y&&s.top+s.height<e.y||s.top>t.y&&s.top+s.height>t.y?m[i].setSelected(!1):m[i].setSelected(!0)}this.selectRelatedGroups()},getSelectedItems(){for(var e=[],t=0;t<m.length;t++)m[t].getSelected()&&e.push(m[t]);return e},getLineItems(){for(var e=[],i=0;i<m.length;i++)m[i].getType()==t.wbLine&&e.push(m[i]);return e},getCachedSelectedItems:()=>h.cachedSelectedItems,getCachedLineItems:()=>h.cachedLineItems,calculateSelectionBounding:function(e){for(var i={x1:Number.MAX_VALUE,y1:Number.MAX_VALUE,x2:-Number.MAX_VALUE,y2:-Number.MAX_VALUE},n=!1,r=!1,o=0;o<m.length;o++){var a;m[o].getSelected()&&(n=!0,((m[o].getType()==t.wbItemHC||null!=m[o].getImage()&&null==m[o].getDiv())&&!m[o].getActive()||m[o].getShape()==s.circle)&&(r=!0),a=e?m[o].getTempDimensions():m[o].getDimensions(),i.x1>a.left&&(i.x1=a.left),i.x2<a.left+a.width&&(i.x2=a.left+a.width),i.y1>a.top&&(i.y1=a.top),i.y2<a.top+a.height&&(i.y2=a.top+a.height))}return n?{bounding:i,keepAspectRatio:r}:void 0},calculateCombinedBounding:function(e){for(var t={x1:Number.MAX_VALUE,y1:Number.MAX_VALUE,x2:-Number.MAX_VALUE,y2:-Number.MAX_VALUE},i=0;i<e.length;i++){let n=e[i].getDimensions();t.x1>n.left&&(t.x1=n.left),t.x2<n.left+n.width&&(t.x2=n.left+n.width),t.y1>n.top&&(t.y1=n.top),t.y2<n.top+n.height&&(t.y2=n.top+n.height)}return{left:t.x1,top:t.y1,width:t.x2-t.x1,height:t.y2-t.y1}},addItem(e){m.push(e)},handleDelete(){for(var e=[],t=0;t<m.length;t++)m[t].getSelected()||e.push(m[t]);m=e,this.redraw()},bringToFront(){var e=this.findwbItemIndexUnderMouse();if(null!=e){var t=m[e];t.order=m[m.length-1].order+1e6,t.setDirty(),I(m,e,m.length-1),this.redraw()}},sendToBack(e){var t;if(null!=(t=null!=e?e:this.findwbItemIndexUnderMouse())){var i=m[t];i.order=Math.floor(m[0].order/2),i.setDirty(),I(m,t,0),this.redraw()}},setLocked(e){var t=this.findwbItemUnderMouse();null!=t&&0==t.getSelected()&&(this.clearSelection(),t.setSelected(!0),this.selectRelatedGroups());for(var i=0;i<m.length;i++)1==m[i].getSelected()&&m[i].setLocked(e);this.redraw()},setBackgroundColor(e){for(var t=0;t<m.length;t++)1==m[t].getSelected()&&m[t].setBackgroundColor(e);this.redraw()},setShape:function(e){for(var t=0;t<m.length;t++)1==m[t].getSelected()&&m[t].setShape(e);this.redraw()},group(){for(var e=0;e<m.length;e++)1==m[e].getSelected()&&m[e].setGroup(g);g++},ungroup(){for(var e=0;e<m.length;e++)1==m[e].getSelected()&&m[e].setGroup()},addEmptyBox(){var e=new r;e.initialize(),m.push(e),this.redraw()},addTextBox(){var e=new _;e.initialize(),m.push(e),this.redraw()},getItems:()=>m,getItemByGUID(e){for(var t=0;t<m.length;t++)if(m[t].getGUID()==e)return m[t]},setConsecutiveY(e){c=e},getConsecutiveY:()=>c,addFromImage(e){var t=this;e.onload=function(){console.log(this.width+"x"+this.height);var i={top:U.lastY,left:U.lastX,width:this.width,height:this.height},n=t.convertWindowToCanvasCoordinates(i),s=new r;s.initialize(),s.setImage(e),s.setDimensions(n),m.push(s),s.imageDirty=!0,t.redraw()}},addFromImageConsecutive(e){var t=this;e.onload=function(){var i;console.log(this.width+"x"+this.height),null==t.getConsecutiveY()?(i={top:U.lastY,left:U.lastX,width:this.width,height:this.height},t.setConsecutiveY(U.lastY+this.height+50)):(i={top:t.getConsecutiveY(),left:U.lastX,width:this.width,height:this.height},t.setConsecutiveY(t.getConsecutiveY()+this.height+50));var n=t.convertWindowToCanvasCoordinates(i),s=new r;s.initialize(),s.setImage(e),s.setDimensions(n),m.push(s),t.redraw()}},respositionNonCanvasItems(){for(var e=0;e<m.length;e++)m[e].getActive()&&m[e].refreshPositioning()},getZoomFactor:function(){return n.getTransform().a},getCtx:function(){return n},getLastMousePos:function(){return n.transformedPoint(U.lastX,U.lastY)},addFromRectangle(e,t,i){this.clearSelection(),a={type:t,extraData:e,backgroundColor:i}},getRectangleLoadData:()=>a,loadFromLoadData(){var e=n.transformedPoint(U.lastX,U.lastY),i=h.dragStart;if(i.x>e.x){var s=i.x;i.x=e.x,e.x=s}i.y>e.y&&(s=i.y,i.y=e.y,e.y=s);var o={left:i.x,top:i.y,width:e.x-i.x,height:e.y-i.y};if(a.type==t.wbItemHC)v.create(a.extraData,o);else if(a.type==t.wbItemTextEditorNote||a.type==t.wbItemTextEditorText){for(var d=0;d<m.length;d++)m[d].getType()==t.wbItemTextEditor&&m[d].getActive()&&m[d].deactivate();(l=new _).initialize(),a.type==t.wbItemTextEditorNote?(l.autoResizeText=!0,l.setBackgroundColor(a.backgroundColor)):(l.autoResizeExtents=!0,l.setBackgroundColor("rgb(255,255,255)")),l.setDimensions(o),m.push(l),l.activate(n),this.redraw()}else if(a.type==t.wbItem)(l=new r).initialize(),l.setDimensions(o),l.setBackgroundColor(a.backgroundColor),m.push(l),this.sendToBack(m.length-1),this.redraw();else if(a.type==t.wbItemContainer)(l=new u).initialize(),l.setDimensions(o),l.setBackgroundColor(a.backgroundColor),m.push(l),this.sendToBack(m.length-1),this.redraw();else if(a.type==t.wbItemModelTree){var l;(l=new wbItemModelTree).initialize(),l.setDimensions(o),l.setBackgroundColor(a.backgroundColor),m.push(l),this.redraw()}a=void 0},copy(){if(p=[],!this.editorActive())for(var e=0;e<m.length;e++)1==m[e].getSelected()&&p.push(m[e])},editorActive(){for(var e=0;e<m.length;e++)if(m[e].getType()==t.wbItemTextEditor&&1==m[e].getActive())return!0;return!1},paste(){if(!this.editorActive()){for(var e=[],t=0;t<p.length;t++)e.push(p[t].duplicate());this.clearSelection(),Promise.all(e).then((function(e){for(var t=0;t<e.length;t++)e[t]._dimensions.left+=20,e[t]._dimensions.top+=20,e[t].setSelected(!0);U.redraw()}))}},async refreshAll(){v.minFramerate=0;for(var e=0;e<m.length;e++)1==m[e].getSelected()&&(await this.deactivateAll(!0),await m[e].activate(n));v.minFramerate=50},getDragStart:()=>h.dragStart,getDirty:()=>x,setDirty(){x=!0},clearDirty(){x=!1},serializeToNode(){if(null==this.getDragStart()){for(var t=[],i=[],s=window.location.href.split("?")[1].split("=")[1],r=0;r<m.length;r++)1==m[r].getDirty()&&(t.push(m[r].serialize()),m[r].clearDirty()),1==m[r].imageDirty&&(i.push(m[r]),m[r].imageDirty=!1);if(t.length>0||h.getCameraDirty()||this.getDirty()){var o,a,d=n.getTransform();h.getCameraDirty()&&(o={a:d.a,b:d.b,c:d.c,d:d.d,e:d.e,f:d.f}),this.getDirty()&&(a={tags:e.allTags.serialize()}),this.clearDirty(),h.clearCameraDirty();var l={items:t,transform:o,wbdata:a},c=JSON.stringify(l);fetch("api/Items/"+s,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:c})}for(r=0;r<i.length;r++)i[r].postImage(s)}},getTopOrder:()=>m.length>0?m[m.length-1].order+1e6:1e6,async refreshItems(e){for(var t=0;t<e.length;t++)await e[t].activate(n),await e[t].deactivate(),e[t].clearDirty()},loadFromNode(){if(U.backendAvailable){var i=window.location.href.split("?")[1].split("=")[1];fetch("api/Items/"+i).then((function(s){200===s.status?s.json().then((function(s){var a=U.getItems(),h=s.rr.transform,d=s.rr.wbdata;null!=d&&e.allTags.setFromJSON(d.tags),null!=h&&(n.setTransform(h.a,h.b,h.c,h.d,h.e,h.f),o.setTransform(h.a,h.b,h.c,h.d,h.e,h.f));for(var l=[],c=[],g=0;g<s.rr.items.length;g++){var m,p=s.rr.items[g];p._type==t.wbItemHC?((m=new v).initialize(p._modelName),m.setupDiv(v.container),m.setFromJSON(p),null!=p.currentState?(m.getModelState().copy(p.currentState),null!=p.currentState.camera&&(m.getModelState().camera=Communicator.Camera.fromJson(p.currentState.camera))):l.push(m)):p._type==t.wbItemTextEditor?((m=new _).initialize(),m.setFromJSON(p),l.push(m)):p._type==t.wbLine?(p.lineType==wbLineType.straight?m=new wbLine:p.lineType==wbLineType.curve?m=new wbLineCurve:p.lineType==wbLineType.step&&(m=new wbLineStep),m.setFromJSON(p),c.push(m)):p._type==t.wbItemContainer?((m=new u).initialize(),m.setFromJSON(p)):((m=new r).initialize(),m.setFromJSON(p)),a.push(m),1==p.hasImage&&m.fetchImage(i)}for(u.assignItemsToContainer(),g=0;g<c.length;g++)null!=c[g].snapItems[0]&&(c[g].snapItems[0].item=U.getItemByGUID(c[g].snapItems[0].item)),null!=c[g].snapItems[1]&&(c[g].snapItems[1].item=U.getItemByGUID(c[g].snapItems[1].item)),c[g].initialize();U.redraw(),U.refreshItems(l),console.log(s)})):console.log("Looks like there was a problem. Status Code: "+s.status)})).catch((function(e){console.log("Fetch Error :-S",e)}))}}}};function j(e,t,i){U.start(e,t,i)}let X=t,Y=s,G=o;function J(e,t,i){var n=U.getItems();let s=new r;return s.initialize(),s.setDimensions(e),s.setBackgroundColor(t),i&&s.setShape(i),n.push(s),U.redraw(),s.getGUID()}function q(e,t,i,n,s,r,o,a){U.getItems();let h=new d(e,t);h.initialize(),h.setDrawArrows(i,n);let l=U.getItemByGUID(s),c=U.getItemByGUID(o);return h.setSnapItem(0,l,r),h.setSnapItem(1,c,a),d.addLine(h),U.redraw(),h.getGUID()}window.wb=new function(){return{addItem:J,addLine:q}}})(),wbManager=n})();